This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-03-15 00:54:32

# File Summary

## Purpose:

This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format:

The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
   a. A header with the file path (## File: path/to/file)
   b. The full contents of the file in a code block

## Usage Guidelines:

- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes:

- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

## Additional Information:

For more information about Repomix, visit: https://github.com/andersonby/python-repomix


# Repository Structure

```
.gitignore
api
  urls.py
  v1
    accounts
      urls.py
      __init__.py
    cotizador
      urls.py
      __init__.py
    urls.py
    __init__.py
  __init__.py
apps
  accounts
    admin.py
    apps.py
    management
      commands
        create_test_users.py
        setup_roles.py
        __init__.py
      __init__.py
    migrations
      0001_initial.py
      0002_user_razon_social_user_unidad.py
      0003_remove_user_last_login_ip_alter_user_area_and_more.py
      0004_alter_user_options_remove_user_created_at_and_more.py
      0005_userprofile_unidades.py
      0006_userprofile_unidades_descuento_alter_user_unidad_and_more.py
      0007_userprofile_updates.py
      0008_alter_userprofile_bio_alter_userprofile_unidades.py
      0009_unidad_alter_user_options_alter_user_managers_and_more.py
      0010_alter_user_managers_unidad_id_pricelist_and_more.py
      __init__.py
    models.py
    README.md
    roles.py
    serializers.py
    tests.py
    urls.py
    urls_api.py
    views.py
    __init__.py
  core
    admin.py
    apps.py
    constants.py
    migrations
      __init__.py
    models.py
    permissions.py
    README.md
    tests.py
    views.py
    __init__.py
  cotizador
    admin.py
    apps.py
    cache
      admin.py
      apps.py
      management
        commands
          sync_products_to_supabase.py
          __init__.py
        __init__.py
      models.py
      serializers.py
      sync.py
      tasks.py
      urls.py
      views.py
      __init__.py
    management
      commands
        compare_prime_storage_with_cache.py
        count_supabase_images.py
        sync_clients.py
        sync_images_by_keys.py
        sync_images_urls.py
        sync_products.py
        sync_products_cache_images.py
        sync_products_new.py
        __init__.py
      __init__.py
    middleware
      cache_middleware.py
      query_middleware.py
      __init__.py
    middleware.py
    migrations
      0001_initial.py
      0002_remove_productobundle_bundle_and_more.py
      0003_alter_cotizacion_uuid.py
      0004_alter_productocotizacion_porcentaje_descuento.py
      0005_cotizacion_fecha_proyecto.py
      0006_alter_cotizacion_options_and_more.py
      0007_alter_cotizacion_uuid.py
      0008_cotizacion_fecha_aprobacion_cotizacion_fecha_envio_and_more.py
      0009_alter_cotizacion_cliente_and_more.py
      0010_update_nulls.py
      0011_cotizacion_condiciones_pago_cotizacion_mostrar_clave_and_more.py
      0012_remove_cotizacion_fecha_aprobacion_and_more.py
      0013_alter_productocotizacion_cotizacion.py
      0014_alter_productocotizacion_cotizacion.py
      0015_alter_producttemplate_options.py
      0016_productscache_cotizacion_total_descuento_and_more.py
      0017_productocotizacion_kit_padre_id_and_more.py
      0018_alter_cotizadorimagenproducto_clave_padre.py
      0019_alter_cotizadorimagenproducto_clave_padre.py
      0020_cotizacion_usuario_aprobacion_and_more.py
      0021_custom_kitproducto_fields.py
      0022_rename_reference_mask_kitproducto_clave_and_more.py
      0023_add_cantidad_to_kit.py
      0024_add_cliente_id_to_cotizacion.py
      0025_add_usuario_fields_to_cotizacion.py
      0026_add_producto_id_to_models.py
      __init__.py
    models.py
    README.md
    routers.py
    serializers.py
    services.py
    tests.py
    urls.py
    utils
      storage.py
      upload_helpers.py
    views.py
    __init__.py
  __init__.py
app_manager
  asgi.py
  celery.py
  routers.py
  settings.py
  urls.py
  wsgi.py
  __init__.py
GETTING_STARTED.md
manage.py
README.md
requirements.txt
```

# Repository Files


## .gitignore

- Characters: 1131
- Tokens: 0

```text
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# Django
*.log
local_settings.py
db.sqlite3
db.sqlite3-journal
media

# Entorno virtual
venv/
env/
ENV/
.env
.venv
env.bak/
venv.bak/

# IDE y editores
.idea/
.vscode/
*.swp
*.swo
*~

# Archivos de sistema
.DS_Store
Thumbs.db

# Archivos temporales
*.bak
*.tmp
*.temp

# Archivos de configuración local
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# Archivos de caché
__pycache__/
.pytest_cache/
.coverage
htmlcov/
.tox/
.nox/
.hypothesis/
.coverage.*

# Archivos de dependencias
node_modules/

# Archivos de compilación
*.pyc
*.pyo
*.pyd

# Archivos de base de datos
*.sqlite3
*.db

# Archivos específicos del proyecto
check_env.py
check_env_simple.py

# Archivos de registro
logs/
*.log

# Archivos de configuración sensibles (asegúrate de no excluir archivos necesarios)
# settings.py

# Archivos de migraciones (opcional, dependiendo de tu flujo de trabajo)
# */migrations/*.py
# !*/migrations/__init__.py
```

## api\urls.py

- Characters: 198
- Tokens: 0

```python
from django.urls import path, include

urlpatterns = [
    path('v1/', include('api.v1.urls')),
    # En el futuro, cuando se necesite una nueva versión:
    # path('v2/', include('api.v2.urls')),
]
```

## api\v1\accounts\urls.py

- Characters: 1012
- Tokens: 0

```python
from django.urls import path
from apps.accounts.views import (
    UserViewSet,
    UnidadViewSet,
    LoginView,
    LogoutView,
    VerifyAccessView,
    QuotationView
)
from rest_framework_simplejwt.views import TokenRefreshView, TokenVerifyView
from rest_framework.routers import DefaultRouter

app_name = 'api-v1-accounts'

# Router para ViewSets
router = DefaultRouter()
router.register('users', UserViewSet, basename='user')
router.register('unidades', UnidadViewSet, basename='unidad')

urlpatterns = [
    # Autenticación JWT
    path('token/', LoginView.as_view(), name='token_obtain_pair'),
    path('token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    path('token/verify/', TokenVerifyView.as_view(), name='token_verify'),
    path('logout/', LogoutView.as_view(), name='token_logout'),
    
    # Verificación y acceso
    path('verify-access/', VerifyAccessView.as_view(), name='verify_access'),
    path('quotation/', QuotationView.as_view(), name='quotation'),
] + router.urls
```

## api\v1\accounts\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## api\v1\cotizador\urls.py

- Characters: 1502
- Tokens: 0

```python
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from apps.cotizador.views import (
    CotizacionViewSet,
    DetalleCotizacionViewSet,
    ProductTemplateViewSet,
    ImagenProductoViewSet,
    BuscarProductosView,
    AgregarProductoCotizacionView,
    get_product_data
)

app_name = 'api-v1-cotizador'

# Router para ViewSets
router = DefaultRouter()
router.register(r'cotizaciones', CotizacionViewSet, basename='cotizacion')
router.register(r'detalles', DetalleCotizacionViewSet, basename='detalle-cotizacion')
router.register(r'templates', ProductTemplateViewSet, basename='product-template')
router.register(r'imagenes', ImagenProductoViewSet, basename='imagen-producto')

# URLs adicionales
urlpatterns = [
    path('', include(router.urls)),
    # Rutas específicas para templates
    path('templates/grupos/', ProductTemplateViewSet.as_view({'get': 'grupos'}), name='template-grupos'),
    path('templates/familias/', ProductTemplateViewSet.as_view({'get': 'familias'}), name='template-familias'),
    path('templates/lineas/', ProductTemplateViewSet.as_view({'get': 'lineas'}), name='template-lineas'),
    # Rutas de productos
    path('productos/buscar/', 
        BuscarProductosView.as_view(), 
        name='buscar-productos'
    ),
    path('productos/agregar/', 
        AgregarProductoCotizacionView.as_view(), 
        name='agregar-producto'
    ),
    path('productos/data/',
        get_product_data,
        name='get-product-data'
    ),
]
```

## api\v1\cotizador\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## api\v1\urls.py

- Characters: 938
- Tokens: 0

```python
from django.urls import path, include
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import permissions

class APIv1Root(APIView):
    permission_classes = [permissions.AllowAny]
    
    def get(self, request, format=None):
        return Response({
            'accounts': '/api/v1/accounts/',
            'cotizador': '/api/v1/cotizador/',
            'endpoints': {
                'auth': {
                    'login': '/api/v1/accounts/token/',
                    'refresh': '/api/v1/accounts/token/refresh/',
                    'verify': '/api/v1/accounts/token/verify/',
                },
                'cotizaciones': '/api/v1/cotizador/cotizaciones/'
            }
        })

urlpatterns = [
    path('', APIv1Root.as_view(), name='api-v1-root'),
    path('accounts/', include('api.v1.accounts.urls')),
    path('cotizador/', include('api.v1.cotizador.urls')),
]
```

## api\v1\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## api\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\accounts\apps.py

- Characters: 175
- Tokens: 0

```python
from django.apps import AppConfig


class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.accounts'
    label = 'accounts'
```

## apps\accounts\management\commands\setup_roles.py

- Characters: 566
- Tokens: 0

```python
from django.core.management.base import BaseCommand
from apps.accounts.roles import setup_roles

class Command(BaseCommand):
    help = 'Configura los roles iniciales del sistema'

    def handle(self, *args, **options):
        self.stdout.write('Configurando roles y permisos...')
        try:
            setup_roles()
            self.stdout.write(self.style.SUCCESS('Roles y permisos configurados exitosamente'))
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'Error al configurar roles: {str(e)}')
            )
```

## apps\accounts\management\commands\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\accounts\management\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\accounts\migrations\0002_user_razon_social_user_unidad.py

- Characters: 1053
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-13 18:34

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='user',
            name='razon_social',
            field=models.CharField(choices=[('GEBESA_NACIONAL', 'GEBESA NACIONAL'), ('OPERADORA_SUCURSALES', 'OPERADORA DE SUCURSALES GEBESA'), ('SALMON_LAGUNA', 'SALMON DE LA LAGUNA')], default='', help_text='Razón social asociada al usuario', max_length=50, verbose_name='Razón Social'),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name='user',
            name='unidad',
            field=models.CharField(choices=[('CDMX', 'CDMX'), ('QRO', 'Querétaro'), ('LAG', 'Laguna'), ('MTY', 'Monterrey'), ('SPL', 'SPL'), ('GDL', 'Guadalajara')], default='', help_text='Unidad a la que pertenece el usuario', max_length=20, verbose_name='Unidad'),
            preserve_default=False,
        ),
    ]
```

## apps\accounts\migrations\0003_remove_user_last_login_ip_alter_user_area_and_more.py

- Characters: 1815
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-13 18:52

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0002_user_razon_social_user_unidad'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='user',
            name='last_login_ip',
        ),
        migrations.AlterField(
            model_name='user',
            name='area',
            field=models.CharField(choices=[('RH', 'Recursos Humanos'), ('VENTAS', 'Ventas'), ('COMPRAS', 'Compras'), ('PROD', 'Producción'), ('TI', 'Tecnología')], default='', help_text='Área a la que pertenece el usuario', max_length=20, verbose_name='Área'),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name='user',
            name='created_by',
            field=models.ForeignKey(help_text='Usuario que creó este registro', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_users', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AlterField(
            model_name='user',
            name='razon_social',
            field=models.CharField(choices=[('GEBESA_NACIONAL', 'GEBESA NACIONAL'), ('OPERADORA_SUCURSALES', 'OPERADORA SUCURSALES'), ('SALMON_LAGUNA', 'SALMON LAGUNA')], help_text='Razón social asociada al usuario', max_length=50, verbose_name='Razón Social'),
        ),
        migrations.AlterField(
            model_name='user',
            name='unidad',
            field=models.CharField(choices=[('CDMX', 'CDMX'), ('QRO', 'QRO'), ('LAG', 'LAG'), ('MTY', 'MTY'), ('SPL', 'SPL'), ('GDL', 'GDL')], help_text='Unidad a la que pertenece el usuario', max_length=20, verbose_name='Unidad'),
        ),
    ]
```

## apps\accounts\migrations\0004_alter_user_options_remove_user_created_at_and_more.py

- Characters: 2137
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-18 01:23

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0003_remove_user_last_login_ip_alter_user_area_and_more'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='user',
            options={'ordering': ['email'], 'verbose_name': 'Usuario', 'verbose_name_plural': 'Usuarios'},
        ),
        migrations.RemoveField(
            model_name='user',
            name='created_at',
        ),
        migrations.RemoveField(
            model_name='user',
            name='created_by',
        ),
        migrations.RemoveField(
            model_name='user',
            name='updated_at',
        ),
        migrations.AlterField(
            model_name='user',
            name='area',
            field=models.CharField(blank=True, choices=[('RH', 'Recursos Humanos'), ('VENTAS', 'Ventas'), ('COMPRAS', 'Compras'), ('PROD', 'Producción'), ('TI', 'Tecnología')], max_length=20, null=True, verbose_name='Área'),
        ),
        migrations.AlterField(
            model_name='user',
            name='first_name',
            field=models.CharField(blank=True, max_length=30, null=True, verbose_name='Nombre'),
        ),
        migrations.AlterField(
            model_name='user',
            name='last_name',
            field=models.CharField(blank=True, max_length=30, null=True, verbose_name='Apellido'),
        ),
        migrations.AlterField(
            model_name='user',
            name='razon_social',
            field=models.CharField(blank=True, choices=[('GEBESA_NACIONAL', 'GEBESA_NACIONAL'), ('OPERADORA_SUCURSALES', 'OPERADORA_SUCURSALES'), ('SALMON_LAGUNA', 'SALMON_LAGUNA')], max_length=50, null=True, verbose_name='Razón Social'),
        ),
        migrations.AlterField(
            model_name='user',
            name='unidad',
            field=models.CharField(blank=True, choices=[('CDMX', 'CDMX'), ('QRO', 'QRO'), ('LAG', 'LAG'), ('MTY', 'MTY'), ('SPL', 'SPL'), ('GDL', 'GDL')], max_length=10, null=True, verbose_name='Unidad'),
        ),
    ]
```

## apps\accounts\migrations\0005_userprofile_unidades.py

- Characters: 778
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-18 17:51

import django.contrib.postgres.fields
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0004_alter_user_options_remove_user_created_at_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='userprofile',
            name='unidades',
            field=django.contrib.postgres.fields.ArrayField(base_field=models.IntegerField(choices=[(32, 'Monterrey'), (43, 'CDMX'), (34, 'Querétaro'), (40, 'Laguna'), (43, 'Puebla'), (33, 'SPL'), (43, 'Guadalajara')]), blank=True, default=list, help_text='IDs de las unidades a las que pertenece el usuario', null=True, size=None, verbose_name='Unidades asignadas'),
        ),
    ]
```

## apps\accounts\migrations\0006_userprofile_unidades_descuento_alter_user_unidad_and_more.py

- Characters: 2455
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-18 18:08

import django.contrib.postgres.fields
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0005_userprofile_unidades'),
    ]

    operations = [
        migrations.AddField(
            model_name='userprofile',
            name='unidades_descuento',
            field=django.contrib.postgres.fields.ArrayField(base_field=models.CharField(choices=[('CDMX', 'CDMX'), ('QRO', 'Querétaro'), ('LAG', 'Laguna'), ('MTY', 'Monterrey'), ('SPL', 'SPL'), ('GDL', 'Guadalajara'), ('PUE', 'Puebla')], max_length=4), blank=True, help_text='Unidades de descuento asignadas al usuario para el manejo de precios', null=True, size=None),
        ),
        migrations.AlterField(
            model_name='user',
            name='unidad',
            field=models.CharField(blank=True, choices=[(32, 32), (33, 33), (34, 34), (40, 40), (43, 43)], max_length=10, null=True, verbose_name='Unidad'),
        ),
        migrations.AlterField(
            model_name='userprofile',
            name='bio',
            field=models.TextField(blank=True, max_length=500),
        ),
        migrations.AlterField(
            model_name='userprofile',
            name='failed_login_attempts',
            field=models.IntegerField(default=0),
        ),
        migrations.AlterField(
            model_name='userprofile',
            name='is_locked',
            field=models.BooleanField(default=False),
        ),
        migrations.AlterField(
            model_name='userprofile',
            name='last_failed_login',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='userprofile',
            name='last_password_change',
            field=models.DateTimeField(auto_now_add=True),
        ),
        migrations.AlterField(
            model_name='userprofile',
            name='require_password_change',
            field=models.BooleanField(default=True),
        ),
        migrations.AlterField(
            model_name='userprofile',
            name='unidades',
            field=django.contrib.postgres.fields.ArrayField(base_field=models.IntegerField(choices=[(32, 'Monterrey'), (33, 'SPL'), (34, 'Querétaro'), (40, 'Laguna'), (43, 'CDMX')]), blank=True, help_text='Unidades administrativas a las que pertenece el usuario', null=True, size=None),
        ),
    ]
```

## apps\accounts\migrations\0007_userprofile_updates.py

- Characters: 831
- Tokens: 0

```python
from django.db import migrations, models
from django.contrib.postgres.fields import ArrayField

class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0006_userprofile_unidades_descuento_alter_user_unidad_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='userprofile',
            name='unidades_descuento',
            field=ArrayField(
                base_field=models.CharField(choices=[('CDMX', 'CDMX'), ('QRO', 'Querétaro'), ('LAG', 'Laguna'), ('MTY', 'Monterrey'), ('SPL', 'SPL'), ('GDL', 'Guadalajara'), ('PUE', 'Puebla')], max_length=4),
                blank=True,
                default=list,
                null=True,
                help_text='Unidades de descuento asignadas al usuario para el manejo de precios'
            ),
        ),
    ]
```

## apps\accounts\migrations\0008_alter_userprofile_bio_alter_userprofile_unidades.py

- Characters: 873
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-20 03:55

import django.contrib.postgres.fields
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0007_userprofile_updates'),
    ]

    operations = [
        migrations.AlterField(
            model_name='userprofile',
            name='bio',
            field=models.TextField(blank=True, default='', max_length=500, null=True),
        ),
        migrations.AlterField(
            model_name='userprofile',
            name='unidades',
            field=django.contrib.postgres.fields.ArrayField(base_field=models.IntegerField(choices=[(32, 'Monterrey'), (33, 'SPL'), (34, 'Querétaro'), (40, 'Laguna'), (43, 'CDMX')]), blank=True, default=list, help_text='Unidades administrativas a las que pertenece el usuario', null=True, size=None),
        ),
    ]
```

## apps\accounts\migrations\0009_unidad_alter_user_options_alter_user_managers_and_more.py

- Characters: 5219
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-26 18:36

import django.contrib.auth.models
import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0008_alter_userprofile_bio_alter_userprofile_unidades'),
    ]

    operations = [
        migrations.CreateModel(
            name='Unidad',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre_corto', models.CharField(help_text='Nombre corto o comercial de la unidad', max_length=100, unique=True)),
                ('razon_social', models.CharField(choices=[('MPF', 'Manufacturas Post Form S.A. de C.V.'), ('SLL', 'Salmon De La Laguna S.A. de C.V.'), ('OSG', 'Operadora de Sucursales Gebesa S.A. de C.V.'), ('GNA', 'GEBESA NACIONAL')], help_text='Razón social de la unidad', max_length=3)),
                ('tipo', models.CharField(choices=[('PROPIA', 'Propia'), ('DISTRIBUIDORA', 'Distribuidora'), ('CONCESIONARIO', 'Concesionario')], help_text='Tipo de unidad (propia, distribuidora, concesionario)', max_length=15)),
                ('nombre_cliente_final', models.CharField(blank=True, help_text='Nombre del cliente final', max_length=100, null=True)),
                ('rfc_cliente_final', models.CharField(blank=True, help_text='RFC del cliente final', max_length=13, null=True)),
            ],
            options={
                'verbose_name': 'Unidad',
                'verbose_name_plural': 'Unidades',
                'ordering': ['nombre_corto'],
            },
        ),
        migrations.AlterModelOptions(
            name='user',
            options={'verbose_name': 'Usuario', 'verbose_name_plural': 'Usuarios'},
        ),
        migrations.AlterModelManagers(
            name='user',
            managers=[
                ('objects', django.contrib.auth.models.UserManager()),
            ],
        ),
        migrations.RemoveField(
            model_name='user',
            name='razon_social',
        ),
        migrations.RemoveField(
            model_name='userprofile',
            name='failed_login_attempts',
        ),
        migrations.RemoveField(
            model_name='userprofile',
            name='is_locked',
        ),
        migrations.RemoveField(
            model_name='userprofile',
            name='last_failed_login',
        ),
        migrations.RemoveField(
            model_name='userprofile',
            name='unidades',
        ),
        migrations.RemoveField(
            model_name='userprofile',
            name='unidades_descuento',
        ),
        migrations.AddField(
            model_name='user',
            name='username',
            field=models.CharField(blank=True, help_text='No usado - mantenido por compatibilidad', max_length=150, null=True, unique=True, verbose_name='username'),
        ),
        migrations.AddField(
            model_name='userprofile',
            name='extension',
            field=models.CharField(blank=True, max_length=10, null=True),
        ),
        migrations.AddField(
            model_name='userprofile',
            name='foto',
            field=models.ImageField(blank=True, null=True, upload_to='profiles/'),
        ),
        migrations.AddField(
            model_name='userprofile',
            name='telefono',
            field=models.CharField(blank=True, max_length=20, null=True),
        ),
        migrations.AlterField(
            model_name='user',
            name='area',
            field=models.CharField(blank=True, choices=[('RH', 'Recursos Humanos'), ('VENTAS', 'Ventas'), ('COMPRAS', 'Compras'), ('PROD', 'Producción'), ('TI', 'Tecnología')], max_length=20, null=True),
        ),
        migrations.AlterField(
            model_name='user',
            name='email',
            field=models.EmailField(error_messages={'unique': 'Ya existe un usuario con este email.'}, max_length=254, unique=True, verbose_name='Email'),
        ),
        migrations.AlterField(
            model_name='user',
            name='first_name',
            field=models.CharField(blank=True, max_length=150, null=True, verbose_name='Nombre'),
        ),
        migrations.AlterField(
            model_name='user',
            name='last_name',
            field=models.CharField(blank=True, max_length=150, null=True, verbose_name='Apellido'),
        ),
        migrations.AlterField(
            model_name='user',
            name='phone',
            field=models.CharField(blank=True, max_length=15, null=True, verbose_name='Teléfono'),
        ),
        migrations.AddField(
            model_name='userprofile',
            name='unidades_asignadas',
            field=models.ManyToManyField(blank=True, help_text='Unidades administrativas a las que pertenece el usuario', to='accounts.unidad'),
        ),
        migrations.AlterField(
            model_name='user',
            name='unidad',
            field=models.ForeignKey(blank=True, help_text='Unidad a la que pertenece el usuario', null=True, on_delete=django.db.models.deletion.PROTECT, to='accounts.unidad', verbose_name='Unidad'),
        ),
    ]
```

## apps\accounts\migrations\0010_alter_user_managers_unidad_id_pricelist_and_more.py

- Characters: 857
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-27 14:04

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0009_unidad_alter_user_options_alter_user_managers_and_more'),
    ]

    operations = [
        migrations.AlterModelManagers(
            name='user',
            managers=[
            ],
        ),
        migrations.AddField(
            model_name='unidad',
            name='id_pricelist',
            field=models.IntegerField(blank=True, help_text='ID de la lista de precios para filtrar en el frontend', null=True),
        ),
        migrations.AlterField(
            model_name='user',
            name='username',
            field=models.CharField(help_text='Requerido. 150 caracteres o menos.', max_length=150, unique=True, verbose_name='username'),
        ),
    ]
```

## apps\accounts\migrations\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\accounts\models.py

- Characters: 8291
- Tokens: 0

```python
from django.db import models
from django.contrib.auth.models import AbstractUser, BaseUserManager
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django.core.validators import RegexValidator
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.core.exceptions import ValidationError
from apps.core.constants import (
    AREA_CHOICES,
    TIPO_UNIDAD_CHOICES,
    RAZON_SOCIAL_CHOICES,
    RAZON_SOCIAL_MAPPING,
    RFC_POR_RAZON,
)

class Unidad(models.Model):
    """
    Modelo para gestionar las unidades/espacios de negocio
    """
    nombre_corto = models.CharField(
        max_length=100,
        unique=True,
        help_text='Nombre corto o comercial de la unidad'
    )
    razon_social = models.CharField(
        max_length=3,
        choices=RAZON_SOCIAL_CHOICES,
        help_text='Razón social de la unidad'
    )
    tipo = models.CharField(
        max_length=15,
        choices=TIPO_UNIDAD_CHOICES,
        help_text='Tipo de unidad (propia, distribuidora, concesionario)'
    )
    nombre_cliente_final = models.CharField(
        max_length=100,
        null=True,
        blank=True,
        help_text='Nombre del cliente final'
    )
    rfc_cliente_final = models.CharField(
        max_length=13,
        null=True,
        blank=True,
        help_text='RFC del cliente final'
    )
    id_pricelist = models.IntegerField(
        null=True,
        blank=True,
        help_text='ID de la lista de precios para filtrar en el frontend'
    )

    class Meta:
        verbose_name = 'Unidad'
        verbose_name_plural = 'Unidades'
        ordering = ['nombre_corto']

    def __str__(self):
        return f"{self.nombre_corto} - {self.get_razon_social_display()}"

    @property
    def razon_social_completa(self):
        """Obtiene el nombre completo de la razón social"""
        return RAZON_SOCIAL_MAPPING.get(self.razon_social, '')

    @property
    def rfc_compania(self):
        """Obtiene el RFC de la compañía basado en la razón social"""
        return RFC_POR_RAZON.get(self.razon_social, '')

class UserManager(BaseUserManager):
    def _create_user(self, email, password=None, **extra_fields):
        """
        Método base para crear usuarios.
        Asegura que el email sea obligatorio y normalizado.
        """
        if not email:
            raise ValueError('El email es obligatorio')
        email = self.normalize_email(email)
        
        # Generar un username único basado en el email
        username = email.split('@')[0]
        if 'username' not in extra_fields:
            extra_fields['username'] = username
            
        # Asegurarse de que el username sea único
        base_username = username
        counter = 1
        while self.model.objects.filter(username=username).exists():
            username = f"{base_username}{counter}"
            counter += 1
        extra_fields['username'] = username
        
        user = self.model(email=email, **extra_fields)
        if password:
            user.set_password(password)
        else:
            user.set_unusable_password()
        user.save(using=self._db)
        return user

    def create_user(self, email, password=None, **extra_fields):
        """
        Crear un usuario regular.
        Por defecto no es staff ni superusuario.
        """
        extra_fields.setdefault('is_staff', False)
        extra_fields.setdefault('is_superuser', False)
        return self._create_user(email, password, **extra_fields)

    def create_superuser(self, email, password=None, **extra_fields):
        """
        Crear un superusuario.
        Debe tener is_staff e is_superuser en True.
        """
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)

        if extra_fields.get('is_staff') is not True:
            raise ValueError('Superuser must have is_staff=True.')
        if extra_fields.get('is_superuser') is not True:
            raise ValueError('Superuser must have is_superuser=True.')

        return self._create_user(email, password, **extra_fields)

class User(AbstractUser):
    """
    Modelo de usuario personalizado que coincide con la estructura existente en la base de datos
    """
    username = models.CharField(
        'username',
        max_length=150,
        unique=True,
        help_text='Requerido. 150 caracteres o menos.',
    )
    email = models.EmailField(
        'Email',
        unique=True,
        error_messages={
            'unique': 'Ya existe un usuario con este email.',
        }
    )
    first_name = models.CharField(
        'Nombre',
        max_length=150,
        blank=True,
        null=True
    )
    last_name = models.CharField(
        'Apellido',
        max_length=150,
        blank=True,
        null=True
    )
    phone = models.CharField(
        'Teléfono',
        max_length=15,
        blank=True,
        null=True
    )
    area = models.CharField(
        max_length=20,
        choices=AREA_CHOICES,
        blank=True,
        null=True
    )
    unidad = models.ForeignKey(
        'Unidad',
        on_delete=models.PROTECT,  # No permitir eliminar una unidad si tiene usuarios
        null=True,  # Temporal mientras se migran los datos
        blank=True,
        verbose_name='Unidad',
        help_text='Unidad a la que pertenece el usuario'
    )

    objects = UserManager()

    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = []  # Email & Password son requeridos por defecto

    class Meta:
        verbose_name = 'Usuario'
        verbose_name_plural = 'Usuarios'
        
    def __str__(self):
        return self.email

    def get_full_name(self):
        """Retorna el nombre completo del usuario"""
        full_name = f"{self.first_name} {self.last_name}".strip()
        return full_name if full_name else self.email

    def save(self, *args, **kwargs):
        if not self.username:
            self.username = self.email
        super().save(*args, **kwargs)

    @property
    def razon_social(self):
        """
        Mantiene compatibilidad con el código existente que use user.razon_social
        """
        if self.unidad:
            return self.unidad.get_razon_social_display()
        return None

    @property
    def rfc_empresa(self):
        """
        Obtiene el RFC de la empresa basado en la unidad
        """
        if self.unidad:
            return self.unidad.rfc_compania
        return None

class UserProfile(models.Model):
    """
    Perfil extendido del usuario para almacenar información adicional
    y gestionar la seguridad.
    """
    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name='profile'
    )
    avatar = models.ImageField(upload_to='avatars/', null=True, blank=True)
    bio = models.TextField(
        max_length=500, 
        blank=True, 
        null=True,
        default=''
    )
    unidades_asignadas = models.ManyToManyField(
        'Unidad',
        blank=True,
        help_text='Unidades administrativas a las que pertenece el usuario'
    )
    require_password_change = models.BooleanField(default=True)
    last_password_change = models.DateTimeField(auto_now_add=True)
    telefono = models.CharField(max_length=20, blank=True, null=True)
    extension = models.CharField(max_length=10, blank=True, null=True)
    foto = models.ImageField(upload_to='profiles/', blank=True, null=True)

    class Meta:
        verbose_name = _('Perfil de Usuario')
        verbose_name_plural = _('Perfiles de Usuario')

    def __str__(self):
        return f"Perfil de {self.user.get_full_name()}"

    def reset_failed_attempts(self):
        """
        Resetea los intentos fallidos de inicio de sesión y desbloquea la cuenta.
        """
        self.user.failed_login_attempts = 0
        self.user.is_locked = False
        self.user.save()

@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    """
    Señal para crear automáticamente un perfil cuando se crea un usuario.
    """
    if created and not hasattr(instance, 'profile'):
        UserProfile.objects.create(
            user=instance,
            require_password_change=True
        )
```

## apps\accounts\README.md

- Characters: 2163
- Tokens: 0

````markdown
# Módulo de Accounts

## Descripción
Este módulo maneja toda la gestión de usuarios, autenticación y autorización en el sistema APP-MANAGER.

## Estructura

```
accounts/
├── __init__.py
├── admin.py          # Configuración del panel de administración
├── apps.py          # Configuración de la aplicación
├── models.py        # Modelos de datos
├── serializers.py   # Serializadores para la API
├── tests.py        # Pruebas unitarias
├── urls.py         # Configuración de URLs
└── views.py        # Vistas y lógica de negocio
```

## Características Principales

1. **Gestión de Usuarios**
   - Registro de usuarios
   - Actualización de perfiles
   - Gestión de roles y permisos

2. **Autenticación**
   - Login/Logout
   - Autenticación basada en JWT
   - Renovación de tokens
   - Blacklist de tokens

3. **Autorización**
   - Control de acceso basado en roles
   - Permisos granulares
   - Grupos de usuarios

## Endpoints API

### Autenticación
- `POST /api/accounts/login/` - Iniciar sesión
- `POST /api/accounts/logout/` - Cerrar sesión
- `POST /api/accounts/token/refresh/` - Refrescar token JWT

### Gestión de Usuarios
- `POST /api/accounts/register/` - Registrar nuevo usuario
- `GET /api/accounts/profile/` - Obtener perfil de usuario
- `PUT /api/accounts/profile/update/` - Actualizar perfil
- `POST /api/accounts/password/change/` - Cambiar contraseña

## Modelos

### User
Extensión del modelo User de Django con campos adicionales:
- Información personal
- Configuraciones específicas
- Roles y permisos personalizados

## Seguridad
- Implementación de JWT para tokens seguros
- Validación robusta de contraseñas
- Protección contra ataques comunes
- Manejo seguro de sesiones

## Uso

```python
# Ejemplo de autenticación
from rest_framework_simplejwt.tokens import RefreshToken

def get_tokens_for_user(user):
    refresh = RefreshToken.for_user(user)
    return {
        'refresh': str(refresh),
        'access': str(refresh.access_token),
    }
```

## Configuración
El módulo utiliza las siguientes configuraciones en settings.py:
- JWT settings
- Configuraciones de autenticación
- Validadores de contraseña
- Configuraciones de sesión
````

## apps\accounts\roles.py

- Characters: 4343
- Tokens: 0

```python
from django.contrib.auth.models import Group, Permission
from django.contrib.contenttypes.models import ContentType
from django.db import transaction
from .models import User, Unidad
from apps.cotizador.models import Cotizacion

# Definición de roles base
ROLES = {
    'ADMIN': {
        'name': 'Administrador',
        'permissions': [
            # Permisos de usuarios
            ('add_user', User),
            ('change_user', User),
            ('delete_user', User),
            ('view_user', User),
            # Permisos de sucursales (unidades)
            ('add_unidad', Unidad),
            ('change_unidad', Unidad),
            ('delete_unidad', Unidad),
            ('view_unidad', Unidad),
            # Permisos de grupos
            ('add_group', Group),
            ('change_group', Group),
            ('delete_group', Group),
            ('view_group', Group),
            # Permisos de cotizaciones
            ('add_cotizacion', Cotizacion),
            ('change_cotizacion', Cotizacion),
            ('delete_cotizacion', Cotizacion),
            ('view_cotizacion', Cotizacion),
        ]
    },
    'GERENTE_VENTAS': {
        'name': 'Gerente de Ventas',
        'permissions': [
            # Permisos de cotizaciones
            ('add_cotizacion', Cotizacion),
            ('change_cotizacion', Cotizacion),
            ('delete_cotizacion', Cotizacion),
            ('view_cotizacion', Cotizacion),
            # Permisos de sucursales (unidades)
            ('view_unidad', Unidad),
            ('change_unidad', Unidad),
            # Permisos de usuarios (vendedores)
            ('view_user', User),
            ('change_user', User),
            # Ver grupos
            ('view_group', Group),
        ]
    },
    'LIDER_SUCURSAL': {
        'name': 'Líder de Sucursal',
        'permissions': [
            # Permisos de cotizaciones de su sucursal
            ('add_cotizacion', Cotizacion),
            ('change_cotizacion', Cotizacion),
            ('delete_cotizacion', Cotizacion),
            ('view_cotizacion', Cotizacion),
            # Permisos de su sucursal (unidad)
            ('view_unidad', Unidad),
            # Permisos de usuarios de su sucursal
            ('view_user', User),
            ('change_user', User),
            # Ver grupos
            ('view_group', Group),
        ]
    },
    'VENDEDOR': {
        'name': 'Vendedor',
        'permissions': [
            # Permisos de cotizaciones de su sucursal
            ('add_cotizacion', Cotizacion),
            ('change_cotizacion', Cotizacion),
            ('view_cotizacion', Cotizacion),
            # Ver su sucursal (unidad)
            ('view_unidad', Unidad),
        ]
    },
    'BACKOFFICE': {
        'name': 'Backoffice',
        'permissions': [
            # Permisos de cotizaciones
            ('view_cotizacion', Cotizacion),
            ('change_cotizacion', Cotizacion),
            # Ver sucursales (unidades)
            ('view_unidad', Unidad),
            # Ver usuarios
            ('view_user', User),
        ]
    }
}

def setup_roles():
    """
    Configura los roles base del sistema.
    Esta función debe ejecutarse durante la migración inicial o mediante un comando de Django.
    """
    with transaction.atomic():
        for role_key, role_data in ROLES.items():
            # Crear o actualizar el grupo
            group, _ = Group.objects.get_or_create(name=role_data['name'])
            
            # Limpiar permisos existentes
            group.permissions.clear()
            
            # Asignar nuevos permisos
            for permission_name, model_class in role_data['permissions']:
                content_type = ContentType.objects.get_for_model(model_class)
                try:
                    permission = Permission.objects.get(
                        codename=permission_name,
                        content_type=content_type,
                    )
                    group.permissions.add(permission)
                except Permission.DoesNotExist:
                    print(f"Permiso no encontrado: {permission_name} para {model_class.__name__}")

def get_role_choices():
    """
    Retorna las opciones de roles para usar en formularios o serializadores
    """
    return [(role_data['name'], role_data['name']) for role_key, role_data in ROLES.items()]
```

## apps\accounts\tests.py

- Characters: 59
- Tokens: 0

```python
from django.test import TestCase

# Create your tests here.
```

## apps\accounts\urls.py

- Characters: 773
- Tokens: 0

```python
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import (
    UserViewSet,
    UnidadViewSet,
    LoginView,
    LogoutView,
    VerifyAccessView,
)

app_name = 'accounts'

# Configuración del router para ViewSets
router = DefaultRouter()
router.register(r'accounts/users', UserViewSet)
router.register(r'accounts/unidades', UnidadViewSet)

# URLs de la API v1
api_v1_patterns = [
    path('', include(router.urls)),
    path('accounts/login/', LoginView.as_view(), name='api-login'),
    path('accounts/logout/', LogoutView.as_view(), name='api-logout'),
    path('accounts/verify-access/', VerifyAccessView.as_view(), name='verify-access'),
]

urlpatterns = [
    # API v1
    path('api/v1/', include(api_v1_patterns)),
]
```

## apps\accounts\urls_api.py

- Characters: 1101
- Tokens: 0

```python
from django.urls import path, include
from .views import (
    UserViewSet,
    UnidadViewSet,
    LoginView,
    LogoutView,
    VerifyAccessView,
    QuotationView,
    GroupViewSet
)
from rest_framework_simplejwt.views import TokenRefreshView, TokenVerifyView
from rest_framework.routers import DefaultRouter

app_name = 'api-v1-accounts'

# Router para ViewSets
router = DefaultRouter()
router.register('users', UserViewSet, basename='user')
router.register('unidades', UnidadViewSet, basename='unidad')
router.register('groups', GroupViewSet)  # Agregamos el endpoint de grupos

urlpatterns = [
    # Autenticación JWT
    path('token/', LoginView.as_view(), name='token_obtain_pair'),
    path('token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    path('token/verify/', TokenVerifyView.as_view(), name='token_verify'),
    path('logout/', LogoutView.as_view(), name='token_logout'),
    
    # Verificación y acceso
    path('verify-access/', VerifyAccessView.as_view(), name='verify_access'),
    path('quotation/', QuotationView.as_view(), name='quotation'),
] + router.urls
```

## apps\accounts\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\core\admin.py

- Characters: 62
- Tokens: 0

```python
from django.contrib import admin

# Register your models here.
```

## apps\core\apps.py

- Characters: 139
- Tokens: 0

```python
from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'core'
```

## apps\core\constants.py

- Characters: 4317
- Tokens: 0

```python
"""
Constantes globales para la aplicación
"""

# Roles de usuario
ROL_SUPERUSUARIO = 'SUPER'
ROL_GERENTE = 'GERENTE'
ROL_LIDER = 'LIDER'
ROL_VENDEDOR = 'VENDEDOR'
ROL_BACKOFFICE = 'BACKOFFICE'

ROL_CHOICES = [
    (ROL_SUPERUSUARIO, 'Superusuario'),
    (ROL_GERENTE, 'Gerente de Ventas'),
    (ROL_LIDER, 'Líder de Sucursal'),
    (ROL_VENDEDOR, 'Vendedor'),
    (ROL_BACKOFFICE, 'Backoffice'),
]

# Áreas
AREA_RH = 'RH'
AREA_VENTAS = 'VENTAS'
AREA_COMPRAS = 'COMPRAS'
AREA_PRODUCCION = 'PROD'
AREA_TI = 'TI'

AREA_CHOICES = [
    (AREA_RH, 'Recursos Humanos'),
    (AREA_VENTAS, 'Ventas'),
    (AREA_COMPRAS, 'Compras'),
    (AREA_PRODUCCION, 'Producción'),
    (AREA_TI, 'Tecnología'),
]

# Tipos de unidad
TIPO_PROPIA = 'PROPIA'
TIPO_DISTRIBUIDORA = 'DISTRIBUIDORA'
TIPO_CONCESIONARIO = 'CONCESIONARIO'

TIPO_UNIDAD_CHOICES = [
    (TIPO_PROPIA, 'Propia'),
    (TIPO_DISTRIBUIDORA, 'Distribuidora'),
    (TIPO_CONCESIONARIO, 'Concesionario'),
]

# Razones sociales
RAZON_MPF = 'MPF'  # Manufacturas Post Form
RAZON_SLL = 'SLL'  # Salmon De La Laguna
RAZON_OSG = 'OSG'  # Operadora de Sucursales Gebesa
RAZON_GNA = 'GNA'  # GEBESA NACIONAL

# Mapeo de razones sociales completas
RAZON_SOCIAL_MAPPING = {
    RAZON_MPF: 'Manufacturas Post Form S.A. de C.V.',
    RAZON_SLL: 'Salmon De La Laguna S.A. de C.V.',
    RAZON_OSG: 'Operadora de Sucursales Gebesa S.A. de C.V.',
    RAZON_GNA: 'GEBESA NACIONAL',
}

RAZON_SOCIAL_CHOICES = [(k, v) for k, v in RAZON_SOCIAL_MAPPING.items()]

# Mapeo de códigos RFC por razón social
RFC_POR_RAZON = {
    RAZON_MPF: 'MPF861014CD6',
    RAZON_SLL: 'SLA8210184A7',
    RAZON_OSG: 'OSG161026F56',
    RAZON_GNA: 'GNA120703RV1',
}

# Datos iniciales de unidades
UNIDADES_INICIALES = [
    {
        "nombre_corto": "Monterrey",
        "razon_social": RAZON_GNA,
        "tipo": TIPO_PROPIA,
        "nombre_cliente_final": "Cotización",
        "rfc_cliente_final": "Cotización"
    },
    {
        "nombre_corto": "CDMX",
        "razon_social": RAZON_GNA,
        "tipo": TIPO_PROPIA,
        "nombre_cliente_final": "Cotización",
        "rfc_cliente_final": "Cotización"
    },
    {
        "nombre_corto": "Puebla",
        "razon_social": RAZON_OSG,
        "tipo": TIPO_PROPIA,
        "nombre_cliente_final": "Cotización",
        "rfc_cliente_final": "Cotización"
    },
    {
        "nombre_corto": "Laguna",
        "razon_social": RAZON_SLL,
        "tipo": TIPO_PROPIA,
        "nombre_cliente_final": "Cotización",
        "rfc_cliente_final": "Cotización"
    },
    {
        "nombre_corto": "Querétaro",
        "razon_social": RAZON_OSG,
        "tipo": TIPO_PROPIA,
        "nombre_cliente_final": "Cotización",
        "rfc_cliente_final": "Cotización"
    },
    {
        "nombre_corto": "Guadalajara",
        "razon_social": RAZON_OSG,
        "tipo": TIPO_PROPIA,
        "nombre_cliente_final": "Cotización",
        "rfc_cliente_final": "Cotización"
    },
    {
        "nombre_corto": "Metrópoli",
        "razon_social": RAZON_MPF,
        "tipo": TIPO_PROPIA,
        "nombre_cliente_final": "Gebesa Metropoli S.A. de C.V.",
        "rfc_cliente_final": "GME020523DP7"
    },
    {
        "nombre_corto": "Mérida",
        "razon_social": RAZON_MPF,
        "tipo": TIPO_DISTRIBUIDORA,
        "nombre_cliente_final": "FUSION DE NEGOCIOS SA DE CV",
        "rfc_cliente_final": "FNE1011056K1"
    },
    {
        "nombre_corto": "León",
        "razon_social": RAZON_MPF,
        "tipo": TIPO_CONCESIONARIO,
        "nombre_cliente_final": "PROVEDURIA DE SERVICIOS Y PRODUCTOS DE MEXICO SA DE CV",
        "rfc_cliente_final": "PPS090331MD3"
    },
    {
        "nombre_corto": "Tijuana",
        "razon_social": RAZON_MPF,
        "tipo": TIPO_CONCESIONARIO,
        "nombre_cliente_final": "ESPACIOS E IMAGEN DE OFICINA SA DE CV",
        "rfc_cliente_final": "EEI110611UI3"
    },
    {
        "nombre_corto": "Hermosillo",
        "razon_social": RAZON_MPF,
        "tipo": TIPO_CONCESIONARIO,
        "nombre_cliente_final": "ESPACIOS E IMAGEN DE OFICINA SA DE CV",
        "rfc_cliente_final": "EEI110611UI3"
    },
    {
        "nombre_corto": "Chihuahua",
        "razon_social": RAZON_MPF,
        "tipo": TIPO_CONCESIONARIO,
        "nombre_cliente_final": "OFICASA SA DE CV",
        "rfc_cliente_final": "OFI850703E75"
    }
]
```

## apps\core\migrations\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\core\models.py

- Characters: 56
- Tokens: 0

```python
from django.db import models

# Create your models here.
```

## apps\core\permissions.py

- Characters: 7797
- Tokens: 0

```python
from rest_framework import permissions

# Roles para la app de cotizaciones
ROLE_ADMINISTRADOR = 'Administrador'
ROLE_MANAGER = 'Manager'
ROLE_VENDEDOR = 'Vendedor'
ROLE_BACKOFFICE = 'Backoffice'
ROLE_MARKETING = 'Marketing'

# Áreas permitidas
AREA_RH = 'RH'
AREA_VENTAS = 'VENTAS'
AREA_COMPRAS = 'COMPRAS'
AREA_PRODUCCION = 'PROD'
AREA_TI = 'TI'

AREAS_PERMITIDAS = [
    AREA_RH,
    AREA_VENTAS,
    AREA_COMPRAS,
    AREA_PRODUCCION,
    AREA_TI
]

# Unidades administrativas (IDs)
UNIDAD_MTY = 32  # Monterrey
UNIDAD_SPL = 33  # SPL
UNIDAD_QRO = 34  # Querétaro
UNIDAD_LAG = 40  # Laguna
UNIDAD_CDMX = 43  # CDMX, Puebla, GDL

# Unidades de descuento (códigos)
UNIDAD_DESC_CDMX = 'CDMX'
UNIDAD_DESC_QRO = 'QRO'
UNIDAD_DESC_LAG = 'LAG'
UNIDAD_DESC_MTY = 'MTY'
UNIDAD_DESC_SPL = 'SPL'
UNIDAD_DESC_GDL = 'GDL'
UNIDAD_DESC_PUE = 'PUE'

# Nombres de unidades administrativas para display
UNIDAD_NOMBRES = {
    UNIDAD_MTY: 'Monterrey',
    UNIDAD_SPL: 'SPL',
    UNIDAD_QRO: 'Querétaro',
    UNIDAD_LAG: 'Laguna',
    UNIDAD_CDMX: 'CDMX'
}

# Lista de unidades administrativas
UNIDADES_NEGOCIO = list(UNIDAD_NOMBRES.keys())

# Lista de unidades de descuento
UNIDADES_DESCUENTO = [
    UNIDAD_DESC_CDMX,
    UNIDAD_DESC_QRO,
    UNIDAD_DESC_LAG,
    UNIDAD_DESC_MTY,
    UNIDAD_DESC_SPL,
    UNIDAD_DESC_GDL,
    UNIDAD_DESC_PUE
]

# Razones sociales
RAZON_GEBESA = 'GEBESA_NACIONAL'
RAZON_OPERADORA = 'OPERADORA_SUCURSALES'
RAZON_SALMON = 'SALMON_LAGUNA'

RAZONES_SOCIALES = [
    RAZON_GEBESA,
    RAZON_OPERADORA,
    RAZON_SALMON
]

# Mapeo de unidades administrativas a razones sociales permitidas
UNIDAD_RAZON_SOCIAL_MAPPING = {
    UNIDAD_CDMX: [RAZON_GEBESA, RAZON_OPERADORA],
    UNIDAD_QRO: [RAZON_GEBESA, RAZON_OPERADORA],
    UNIDAD_LAG: [RAZON_SALMON],
    UNIDAD_MTY: [RAZON_GEBESA, RAZON_OPERADORA],
    UNIDAD_SPL: [RAZON_GEBESA]
}

#Funcion para obtener el rol del usuario
def get_cotizador_rol(user):
    if user.is_superuser:
        return ROLE_ADMINISTRADOR
    
    #obtenemos los nombres de los grupos al que pertenece el usuario
    user_groups = list(user.groups.values_list('name', flat=True))

    #Asumimos que cada usuario tiene unicamente un rol
    if ROLE_MANAGER in user_groups:
        return ROLE_MANAGER
    elif ROLE_BACKOFFICE in user_groups:
        return ROLE_BACKOFFICE
    elif ROLE_VENDEDOR in user_groups:
        return ROLE_VENDEDOR
    elif ROLE_MARKETING in user_groups:
        return ROLE_MARKETING

    return None

def validate_unidad_razon_social(user):
    """
    Valida que la razón social del usuario corresponda con su unidad
    """
    if user.is_superuser:
        return True
        
    if user.unidad not in UNIDAD_RAZON_SOCIAL_MAPPING:
        return False
        
    return user.razon_social in UNIDAD_RAZON_SOCIAL_MAPPING[user.unidad]

def can_create_cotizacion(user):
    """
    Verifica si un usuario puede crear cotizaciones:
    - Debe tener rol Manager o Vendedor
    - Su razón social debe corresponder con su unidad
    - Debe pertenecer al área de ventas
    """
    if not validate_unidad_razon_social(user):
        return False
        
    if user.area != AREA_VENTAS:
        return False
        
    role = get_cotizador_rol(user)
    return role in [ROLE_MANAGER, ROLE_VENDEDOR]

def can_view_cotizaciones(user, cotizacion_owner=None):
    """
    Verifica permisos para ver cotizaciones:
    - Manager y Backoffice ven todas las cotizaciones
    - Vendedores solo ven sus propias cotizaciones
    - Debe pertenecer al área de ventas
    """
    if not validate_unidad_razon_social(user):
        return False
        
    if user.area != AREA_VENTAS:
        return False
        
    role = get_cotizador_rol(user)
    if role in [ROLE_MANAGER, ROLE_BACKOFFICE, ROLE_ADMINISTRADOR]:
        return True
    elif role == ROLE_VENDEDOR:
        return cotizacion_owner == user
    return False

def can_view_cotizacion_by_unidad(user, cotizacion):
    """
    Verifica si un usuario puede ver una cotización específica:
    - Administradores pueden ver todo
    - Managers pueden ver todas las cotizaciones
    - Vendedores solo ven sus propias cotizaciones
    """
    if not validate_unidad_razon_social(user):
        return False
        
    role = get_cotizador_rol(user)
    
    if role in [ROLE_ADMINISTRADOR, ROLE_MANAGER]:
        return True
    
    # Validar que la razón social coincida
    if cotizacion.unidad_facturacion != user.razon_social:
        return False
    
    if role == ROLE_VENDEDOR:
        return cotizacion.created_by == user
    
    return False

def can_edit_cotizacion(user, cotizacion):
    """
    Verifica permisos para editar cotizaciones:
    - Administradores pueden editar todo
    - Managers pueden editar cualquier cotización
    - Backoffice solo puede editar de su unidad/razón social
    """
    if not validate_unidad_razon_social(user):
        return False
        
    role = get_cotizador_rol(user)
    
    # Admins y Managers pueden editar todo
    if role in [ROLE_ADMINISTRADOR, ROLE_MANAGER]:
        return True
        
    if role == ROLE_BACKOFFICE:
        # Backoffice solo puede editar de su unidad/razón social
        return (cotizacion.created_by.unidad == user.unidad and
                cotizacion.unidad_facturacion == user.razon_social)
    
    return False

class CotizadorPermission(permissions.BasePermission):
    """
    Permisos personalizados para el módulo de cotizaciones:
    - Validación por rol
    - Validación por unidad
    - Validación por razón social
    - Validación por área
    """
    def has_permission(self, request, view):
        if not request.user.is_authenticated:
            return False
            
        role = get_cotizador_rol(request.user)
        if not role:
            return False

        if request.method == 'POST':
            return can_create_cotizacion(request.user)
        
        return can_view_cotizaciones(request.user)
    
    def has_object_permission(self, request, view, obj):
        if not request.user.is_authenticated:
            return False

        if request.method in ['PUT', 'PATCH', 'DELETE']:
            return can_edit_cotizacion(request.user, obj)
        
        return can_view_cotizacion_by_unidad(request.user, obj)

class IsAdminUser(permissions.BasePermission):
    """
    Permite acceso solo a usuarios administradores.
    """
    def has_permission(self, request, view):
        return bool(request.user and request.user.is_staff)

class IsOwnerOrAdmin(permissions.BasePermission):
    """
    Permite acceso al propietario del objeto o a administradores.
    """
    def has_object_permission(self, request, view, obj):
        if request.user.is_staff:
            return True
        return obj.id == request.user.id

class HasAreaPermission(permissions.BasePermission):
    """
    Permite acceso basado en el área del usuario.
    """
    def __init__(self, allowed_areas):
        self.allowed_areas = allowed_areas

    def has_permission(self, request, view):
        return bool(
            request.user and
            request.user.is_authenticated and
            request.user.area in self.allowed_areas
        )

class RequirePasswordChange(permissions.BasePermission):
    """
    Restringe el acceso si el usuario necesita cambiar su contraseña.
    """
    def has_permission(self, request, view):
        if not request.user.is_authenticated:
            return False
            
        # Permitir acceso a la vista de cambio de contraseña
        if view.__class__.__name__ == 'ChangePasswordView':
            return True
            
        # Verificar si el usuario necesita cambiar su contraseña
        try:
            return not request.user.profile.require_password_change
        except:
            return True
```

## apps\core\README.md

- Characters: 2746
- Tokens: 0

````markdown
# Módulo Core

## Descripción
El módulo Core proporciona funcionalidades base y utilidades compartidas para todo el sistema APP-MANAGER. Actúa como una biblioteca central de componentes reutilizables.

## Estructura

```
core/
├── __init__.py
├── admin.py          # Configuración del panel de administración
├── apps.py          # Configuración de la aplicación
├── migrations/      # Migraciones de la base de datos
├── models.py        # Modelos de datos base
├── permissions.py   # Sistema de permisos personalizado
├── tests.py        # Pruebas unitarias
└── views.py        # Vistas base
```

## Características Principales

1. **Sistema de Permisos**
   - Permisos personalizados
   - Decoradores de permisos
   - Mixins de autorización

2. **Utilidades Base**
   - Modelos abstractos
   - Vistas genéricas
   - Funciones auxiliares

3. **Configuraciones Globales**
   - Constantes del sistema
   - Configuraciones compartidas
   - Valores por defecto

## Componentes

### Permisos
El archivo `permissions.py` contiene:
- Clases base para permisos
- Decoradores personalizados
- Validadores de permisos

### Modelos Base
Modelos abstractos que pueden ser heredados por otras aplicaciones:
- Timestamps
- Auditoría
- Metadatos comunes

### Vistas Base
Vistas genéricas que pueden ser extendidas:
- Manejo de errores
- Respuestas estándar
- Mixins comunes

## Uso

### Permisos Personalizados
```python
from apps.core.permissions import IsOwnerOrAdmin

class MyView(APIView):
    permission_classes = [IsOwnerOrAdmin]
```

### Modelos Base
```python
from apps.core.models import TimeStampedModel

class MyModel(TimeStampedModel):
    # Hereda created_at y updated_at
    name = models.CharField(max_length=100)
```

## Configuración
El módulo core no requiere configuraciones específicas, pero proporciona:
- Constantes del sistema
- Configuraciones por defecto
- Utilidades de configuración

## Extensión
Para extender las funcionalidades del módulo core:

1. Crear nuevos permisos:
```python
from apps.core.permissions import BasePermission

class MyCustomPermission(BasePermission):
    def has_permission(self, request, view):
        # Implementar lógica personalizada
        return True
```

2. Crear nuevos modelos base:
```python
from django.db import models
from apps.core.models import TimeStampedModel

class MyBaseModel(TimeStampedModel):
    # Agregar campos adicionales
    description = models.TextField()
    
    class Meta:
        abstract = True
```

## Buenas Prácticas
1. Mantener el código del core lo más genérico posible
2. Documentar todas las utilidades y componentes
3. Escribir pruebas unitarias para cada componente
4. Seguir los principios DRY (Don't Repeat Yourself)
5. Mantener la compatibilidad hacia atrás
````

## apps\core\tests.py

- Characters: 59
- Tokens: 0

```python
from django.test import TestCase

# Create your tests here.
```

## apps\core\views.py

- Characters: 62
- Tokens: 0

```python
from django.shortcuts import render

# Create your views here.
```

## apps\core\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\cotizador\admin.py

- Characters: 7264
- Tokens: 0

```python
from django.contrib import admin
from django.utils.safestring import mark_safe
from django.utils.html import format_html
from django.urls import reverse
from django.http import HttpResponseRedirect
from .models import (
    ProductTemplate, Cotizacion, ProductoCotizacion, Producto, 
    ProductType, ProductFamily, ProductGroup, ProductLine, 
    CotizadorImagenproducto, Cliente
)
from django.utils.html import mark_safe

# Register your models here.

@admin.register(ProductTemplate)
class ProductTemplateAdmin(admin.ModelAdmin):
    list_display = (
        'id', 
        'reference_mask', 
        'name',
        'get_type', 
        'get_family', 
        'get_group', 
        'get_line',
        'preview_image'
    )
    search_fields = ('reference_mask', 'name')
    list_filter = ('type', 'family', 'line', 'group', 'is_line', 'active')
    list_select_related = ('type', 'family', 'line', 'group')
    readonly_fields = ('preview_image', 'image_gallery')

    def get_type(self, obj):
        return obj.type.name if obj.type else '-'
    get_type.short_description = 'Tipo'
    get_type.admin_order_field = 'type__name'

    def get_family(self, obj):
        return obj.family.name if obj.family else '-'
    get_family.short_description = 'Familia'
    get_family.admin_order_field = 'family__name'

    def get_group(self, obj):
        return obj.group.name if obj.group else '-'
    get_group.short_description = 'Grupo'
    get_group.admin_order_field = 'group__name'

    def get_line(self, obj):
        return obj.line.name if obj.line else '-'
    get_line.short_description = 'Línea'
    get_line.admin_order_field = 'line__name'

    def preview_image(self, obj):
        return obj.get_image_preview()
    preview_image.short_description = 'Imagen'
    preview_image.allow_tags = True

    def image_gallery(self, obj):
        return obj.get_image_gallery()
    image_gallery.short_description = 'Galería de Imágenes'
    image_gallery.allow_tags = True

    def get_queryset(self, request):
        return super().get_queryset(request).using('erp-portalgebesa-com')

    def has_add_permission(self, request):
        return False

    def has_delete_permission(self, request, obj=None):
        return False

    def has_change_permission(self, request, obj=None):
        return False

@admin.register(ProductType)
class ProductTypeAdmin(admin.ModelAdmin):
    list_display = ('id', 'name')
    search_fields = ('name',)

    def get_queryset(self, request):
        return super().get_queryset(request).using('erp-portalgebesa-com')

    def has_add_permission(self, request):
        return False

    def has_delete_permission(self, request, obj=None):
        return False

    def has_change_permission(self, request, obj=None):
        return False

@admin.register(ProductFamily)
class ProductFamilyAdmin(admin.ModelAdmin):
    list_display = ('id', 'name')
    search_fields = ('name',)

    def get_queryset(self, request):
        return super().get_queryset(request).using('erp-portalgebesa-com')

    def has_add_permission(self, request):
        return False

    def has_delete_permission(self, request, obj=None):
        return False

    def has_change_permission(self, request, obj=None):
        return False

@admin.register(ProductLine)
class ProductLineAdmin(admin.ModelAdmin):
    list_display = ('id', 'name')
    search_fields = ('name',)

    def get_queryset(self, request):
        return super().get_queryset(request).using('erp-portalgebesa-com')

    def has_add_permission(self, request):
        return False

    def has_delete_permission(self, request, obj=None):
        return False

    def has_change_permission(self, request, obj=None):
        return False

@admin.register(ProductGroup)
class ProductGroupAdmin(admin.ModelAdmin):
    list_display = ('id', 'name')
    search_fields = ('name',)

    def get_queryset(self, request):
        return super().get_queryset(request).using('erp-portalgebesa-com')

    def has_add_permission(self, request):
        return False

    def has_delete_permission(self, request, obj=None):
        return False

    def has_change_permission(self, request, obj=None):
        return False

@admin.register(Producto)
class ProductoAdmin(admin.ModelAdmin):
    list_display = ['nombre', 'codigo_producto', 'precio_base', 'activo']
    list_filter = ['activo']
    search_fields = ['nombre', 'codigo_producto', 'descripcion']
    ordering = ['codigo_producto']

@admin.register(ProductoCotizacion)
class ProductoCotizacionAdmin(admin.ModelAdmin):
    list_display = ['clave', 'descripcion', 'cantidad', 'precio_lista']
    search_fields = ['clave', 'descripcion']

@admin.register(Cotizacion)
class CotizacionAdmin(admin.ModelAdmin):
    list_display = ['folio', 'version', 'proyecto', 'cliente', 'vendedor', 'estatus']
    list_filter = ['estatus']
    search_fields = ['folio', 'proyecto', 'cliente', 'vendedor']
    readonly_fields = [
        'uuid',
        'folio',
        'version',
        'fecha_creacion',
        'fecha_modificacion'
    ]
    fieldsets = (
        ('Información de Control', {
            'fields': (
                'folio', 'version', 'estatus', 'motivo'
            )
        }),
        ('Información del Proyecto', {
            'fields': (
                'proyecto', 'fecha_proyecto', 'unidad_facturacion'
            )
        }),
        ('Información del Cliente', {
            'fields': (
                'cliente', 'persona_contacto', 'email_cliente', 'telefono_cliente'
            )
        }),
        ('Información del Vendedor', {
            'fields': (
                'vendedor', 'email_vendedor', 'telefono_vendedor', 'proyectista'
            )
        }),
        ('Configuración PDF', {
            'fields': (
                'tiempo_entrega', 'vigencia', 'condiciones_pago',
                'mostrar_clave', 'mostrar_precio_lista', 'mostrar_precio_descuento',
                'mostrar_logistica', 'mostrar_descuento_total'
            )
        }),
        ('Totales', {
            'fields': (
                'subtotal_mobiliario', 'logistica', 'iva', 'total_general'
            )
        }),
        ('Auditoría', {
            'fields': (
                'fecha_creacion', 'fecha_modificacion'
            )
        })
    )

@admin.register(CotizadorImagenproducto)
class CotizadorImagenproductoAdmin(admin.ModelAdmin):
    list_display = [
        'clave_padre',
        'get_color',
        'mostrar_imagen',
        'get_es_principal'
    ]
    search_fields = ['clave_padre']

    def get_color(self, obj):
        return getattr(obj, 'get_color', '-')
    get_color.short_description = 'Color'

    def get_es_principal(self, obj):
        return getattr(obj, 'es_principal', False)
    get_es_principal.short_description = 'Es Principal'
    get_es_principal.boolean = True

    def mostrar_imagen(self, obj):
        if obj.url:
            return mark_safe(f'<img src="{obj.url}" style="max-height: 50px;" />')
        return '-'
    mostrar_imagen.short_description = 'Vista Previa'

@admin.register(Cliente)
class ClienteAdmin(admin.ModelAdmin):
    list_display = ('partner_id', 'name_partner', 'rfc')
    search_fields = ('name_partner', 'rfc')
    list_filter = ('partner_id',)
```

## apps\cotizador\apps.py

- Characters: 178
- Tokens: 0

```python
from django.apps import AppConfig


class CotizadorConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.cotizador'
    label = 'cotizador'
```

## apps\cotizador\cache\admin.py

- Characters: 3622
- Tokens: 0

```python
from django.contrib import admin
from django.utils.html import format_html
from .models import ProductsCache

# Filtro personalizado para productos sin imágenes
class SinImagenFilter(admin.SimpleListFilter):
    title = 'Estado de imagen'
    parameter_name = 'tiene_imagen'

    def lookups(self, request, model_admin):
        return (
            ('sin_imagen', 'Sin imagen'),
            ('con_imagen', 'Con imagen'),
        )

    def queryset(self, request, queryset):
        if self.value() == 'sin_imagen':
            return queryset.filter(image_url__isnull=True) | queryset.filter(image_url='')
        if self.value() == 'con_imagen':
            return queryset.exclude(image_url__isnull=True).exclude(image_url='')

@admin.register(ProductsCache)
class ProductsCacheAdmin(admin.ModelAdmin):
    list_display = [
        'reference_mask',
        'name',
        'get_image_preview',
        'type_name',
        'family_name',
        'line_name',
        'group_name',
        'is_line',
        'active',
        'last_sync'
    ]
    
    list_filter = [
        'active',
        'is_line',
        'type_name',
        'family_name',
        'line_name',
        'group_name',
        SinImagenFilter,  # Agregamos nuestro filtro personalizado
    ]
    
    search_fields = [
        'reference_mask',
        'name',
        'default_code',
        'description_sale'
    ]
    
    readonly_fields = [
        'id',
        'reference_mask',
        'name',
        'type_id',
        'family_id',
        'line_id',
        'group_id',
        'type_name',
        'family_name',
        'line_name',
        'group_name',
        'is_line',
        'active',
        'description_sale',
        'default_code',
        'image_url',
        'last_sync',
        'get_image_preview',
        'get_full_image'
    ]

    fieldsets = (
        ('Información Básica', {
            'fields': ('reference_mask', 'name', 'default_code')
        }),
        ('Jerarquía', {
            'fields': (
                ('type_name', 'type_id'),
                ('family_name', 'family_id'),
                ('line_name', 'line_id'),
                ('group_name', 'group_id')
            )
        }),
        ('Estado', {
            'fields': ('is_line', 'active', 'last_sync')
        }),
        ('Descripción', {
            'fields': ('description_sale',)
        }),
        ('Imagen', {
            'fields': ('image_url', 'get_full_image')
        }),
    )
    
    ordering = ['name']

    def has_add_permission(self, request):
        return False

    def has_delete_permission(self, request, obj=None):
        return False

    def has_change_permission(self, request, obj=None):
        return False

    def get_image_preview(self, obj):
        """Vista previa pequeña para la lista"""
        if obj.image_url:
            return format_html('<img src="{}" style="max-height: 50px;" />', obj.image_url)
        return '-'
    get_image_preview.short_description = 'Vista Previa'
    get_image_preview.allow_tags = True

    def get_full_image(self, obj):
        """Imagen completa para el detalle"""
        if obj.image_url:
            return format_html(
                '<div style="text-align: center;">'
                '<img src="{}" style="max-width: 100%; max-height: 400px;" />'
                '<br><a href="{}" target="_blank">Ver imagen completa</a>'
                '</div>',
                obj.image_url, obj.image_url
            )
        return 'No hay imagen disponible'
    get_full_image.short_description = 'Imagen del Producto'
    get_full_image.allow_tags = True
```

## apps\cotizador\cache\apps.py

- Characters: 195
- Tokens: 0

```python
from django.apps import AppConfig

class CacheConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.cotizador.cache'
    verbose_name = 'Caché de Productos'
```

## apps\cotizador\cache\management\commands\sync_products_to_supabase.py

- Characters: 581
- Tokens: 0

```python
from django.core.management.base import BaseCommand
from apps.cotizador.cache.sync import sync_products_to_supabase

class Command(BaseCommand):
    help = 'Sincroniza productos desde PostgreSQL a Supabase'

    def handle(self, *args, **options):
        try:
            count = sync_products_to_supabase()
            self.stdout.write(
                self.style.SUCCESS(f'Sincronizados {count} productos exitosamente')
            )
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'Error al sincronizar: {str(e)}')
            )
```

## apps\cotizador\cache\management\commands\__init__.py

- Characters: 36
- Tokens: 0

```python
# Inicializador del paquete commands
```

## apps\cotizador\cache\management\__init__.py

- Characters: 38
- Tokens: 0

```python
# Inicializador del paquete management
```

## apps\cotizador\cache\models.py

- Characters: 1765
- Tokens: 0

```python
from django.db import models
from django.utils.html import mark_safe

class ProductsCache(models.Model):
    """
    Modelo que representa la tabla de productos en Supabase.
    Esta tabla es una caché de los productos de PostgreSQL.
    """
    id = models.IntegerField(primary_key=True)
    name = models.CharField(max_length=255)
    reference_mask = models.CharField(max_length=255)
    type_id = models.IntegerField(null=True)
    family_id = models.IntegerField(null=True)
    line_id = models.IntegerField(null=True)
    group_id = models.IntegerField(null=True)
    active = models.BooleanField(default=True)
    is_line = models.BooleanField(default=True)
    description_sale = models.TextField(null=True)
    default_code = models.CharField(max_length=64, null=True)
    type_name = models.CharField(max_length=255, null=True)
    family_name = models.CharField(max_length=255, null=True)
    line_name = models.CharField(max_length=255, null=True)
    group_name = models.CharField(max_length=255, null=True)
    image_url = models.URLField(max_length=512, null=True)
    last_sync = models.DateTimeField(auto_now=True)

    class Meta:
        managed = False  # Django no manejará la creación/modificación de la tabla
        db_table = 'products_cache'  # Nombre de la tabla en Supabase
        app_label = 'cotizador'
        verbose_name = "Producto Supabase"
        verbose_name_plural = "Productos Supabase"

    def __str__(self):
        return f"{self.reference_mask} - {self.name}"

    def get_image_preview(self):
        """
        Retorna el HTML para mostrar la vista previa de la imagen
        """
        if self.image_url:
            return mark_safe(f'<img src="{self.image_url}" style="max-height: 50px;" />')
        return '-'
```

## apps\cotizador\cache\serializers.py

- Characters: 2104
- Tokens: 0

```python
from rest_framework import serializers
from .models import ProductsCache
from apps.cotizador.models import CotizadorImagenproducto

class ProductsCacheSerializer(serializers.ModelSerializer):
    """
    Serializador para el modelo ProductsCache.
    """
    class Meta:
        model = ProductsCache
        fields = [
            'id', 'name', 'reference_mask', 'type_id', 'family_id',
            'line_id', 'group_id', 'active', 'is_line', 'description_sale',
            'default_code', 'type_name', 'family_name', 'line_name',
            'group_name', 'image_url', 'last_sync'
        ]
        read_only_fields = fields  # Todos los campos son de solo lectura ya que es una caché

class ProductImageUploadSerializer(serializers.Serializer):
    """
    Serializador para la carga de imágenes de productos.
    """
    image = serializers.ImageField(
        help_text="Archivo de imagen a cargar",
        required=True
    )
    reference_mask = serializers.CharField(
        help_text="Identificador único del producto (reference_mask)",
        required=True
    )
    
    def validate_image(self, value):
        """
        Validar que el archivo sea una imagen y tenga un tamaño adecuado.
        """
        # Verificar el tipo de archivo
        if not value.content_type.startswith('image/'):
            raise serializers.ValidationError(
                "El archivo debe ser una imagen (JPEG, PNG, etc.)"
            )
        
        # Verificar el tamaño (máximo 5MB)
        if value.size > 5 * 1024 * 1024:
            raise serializers.ValidationError(
                "El tamaño de la imagen no debe exceder 5MB"
            )
        
        return value
    
    def validate_reference_mask(self, value):
        """
        Validar que el reference_mask corresponda a un producto existente.
        """
        product = ProductsCache.objects.filter(reference_mask=value).first()
        if not product:
            raise serializers.ValidationError(
                f"No se encontró ningún producto con reference_mask: {value}"
            )
        
        return value
```

## apps\cotizador\cache\sync.py

- Characters: 25073
- Tokens: 0

```python
from django.db import connections
from supabase import create_client, Client
from django.conf import settings
from decimal import Decimal
import time
import logging
from datetime import datetime

def sync_products_to_supabase():
    """
    Sincroniza los productos desde PostgreSQL a Supabase.
    """
    print("Iniciando sincronización de productos...")
    
    # Configuración de Supabase
    print("Conectando a Supabase...")
    supabase: Client = create_client(
        settings.SUPABASE_URL,
        settings.SUPABASE_KEY
    )

    # Estadísticas
    total_products = 0
    successful_products = 0
    products_with_images = 0
    preserved_images = 0
    start_time = datetime.now()

    # Obtener datos de PostgreSQL
    print("Obteniendo productos de la base de datos ERP...")
    with connections['erp-portalgebesa-com'].cursor() as cursor:
        cursor.execute("""
            SELECT 
                pt.id,
                pt.reference_mask,
                pt.note_pricelist,  
                pt.type_id,
                pt.family_id,
                pt.line_id,
                pt.group_id,
                pt.is_line,
                pt.pricelist,
                pt.active,
                -- Nueva columna "code"
                COALESCE(pt.reference_mask, pt.note_pricelist) AS code,
                -- Información adicional de las tablas relacionadas
                ptype.name   AS type_name,
                pfam.name    AS family_name,
                pline.name   AS line_name,
                pgroup.name  AS group_name,
                -- Nueva columna con la traducción en español
                it.value AS name_spanish
            FROM product_template pt
                LEFT JOIN product_type ptype 
                    ON pt.type_id = ptype.id
                LEFT JOIN product_family pfam 
                    ON pt.family_id = pfam.id
                LEFT JOIN product_line pline 
                    ON pt.line_id = pline.id
                LEFT JOIN product_group pgroup 
                    ON pt.group_id = pgroup.id
                -- Agrega la unión con ir_translation para obtener la traducción en español
                LEFT JOIN ir_translation it 
                    ON it.res_id = pt.id
                       AND it.name = 'product.template,name'
                       AND it.lang = 'es_MX'
            WHERE 
                pt.is_line = TRUE
                AND pt.active = TRUE
                AND (
                    (
                        pt.reference_mask IS NOT NULL
                        AND pt.reference_mask NOT IN (
                            'LLR1SCANT', 'LLR1SCANTWM', 'LLRBLAPMBBFLPF162329NT', 
                            'LLRBLAPMFFLPF162329NT', 'LLRBLAPMSBBFLPF162329NT', 
                            'LLRBLAPMSFFLPF162329NT', 'LLRBPMBBFLPF162329NT', 
                            'LLRBPMFFLPF162329NT', 'LLRBPMSBBFLPF162329NT', 
                            'LLRBPMSFFLPF162329NT', 'LLRBWSLP242442', 'LLRBWSLP302442', 
                            'LLRBWSRELP242442', 'LLRBWSRELP302442', 'LLRBWSSLP2460', 
                            'LLRBWSSLP2465', 'LLRBWSSLP2472', 'LLRBWSSLP3060', 
                            'LLRBWSSLP3065', 'LLRBWSSLP3072', 'LLRC1DLP602024', 
                            'LLRC1DLP712024', 'LLRCANTSS', 'LLRCANTSSWM', 'LLRCC2720', 
                            'LLRCOUNTBR', 'LLRCRBRKIT', 'LLRCWSSLP363624', 'LLRCWSSLP423624', 
                            'LLRCWSSLP424224', 'LLRCWSSLP424230', 'LLRCWSSLP483624', 
                            'LLRCWSSLP484224', 'LLRCWSSLP484230', 'LLRCWSSLP484824', 
                            'LLRCWSSLP484830', 'LLRCWSSLP603624', 'LLRCWSSLP604224', 
                            'LLRCWSSLP604230', 'LLRCWSSLP604824', 'LLRCWSSLP604830', 
                            'LLREHWSLP367224', 'LLREHWSLP367230', 'LLREIWSLP2460', 
                            'LLREIWSLP2472', 'LLREIWSLP3072', 'LLREL01525MPS120', 
                            'LLREL01525MPS72', 'LLREL01525S120', 'LLREL01525S72', 
                            'LLREL0153611SMAM172', 'LLREL0153611SMBM172', 
                            'LLREL0153611SMCM172', 'LLREL0153620SMA72', 
                            'LLREL0153620SMB72', 'LLREL0153620SMC72', 'LLREL0181922E120', 
                            'LLREL0181922E72', 'LLREL01820M22120', 'LLREL01820M2272', 
                            'LLREL01820M22D172', 'LLREL01820M2X22120', 'LLREL01820M2X2272', 
                            'LLREL01820M2X22U5/U5120', 'LLREL01820M2X22U5/U572', 
                            'LLREL01820M2X40120', 'LLREL01820M2X4072', 
                            'LLREL01826M3X4002120', 'LLREL01826M3X400272', 
                            'LLREL01826M4X4001120', 'LLREL01826M4X400172', 'LLREL02137C1172', 
                            'LLREL02137C2072', 'LLREL0251122120', 'LLREL025112272', 
                            'LLREL0251133120', 'LLREL025113372', 'LLREL02511B22U572', 
                            'LLREL02511B31U172', 'LLREL02511B33U3172', 'LLREL02511B4072', 
                            'LLREL0252022XA120', 'LLREL0252022XA72', 'LLREL0252022YA120', 
                            'LLREL0252022YA72', 'LLREL0252022Z120', 'LLREL0252022Z72', 
                            'LLREL0252033XA120', 'LLREL0252033XA72', 'LLREL0252033YA120', 
                            'LLREL0252033YA72', 'LLREL0252033Z120', 'LLREL0252033Z72', 
                            'LLREL0335911120', 'LLREL033591172', 'LLREL0335911M1120', 
                            'LLREL0335911M172', 'LLREL0335920120', 'LLREL033592072', 
                            'LLREL03373EN22120', 'LLREL03373EN2272', 'LLREL03373EN22M2120', 
                            'LLREL03373EN22M272', 'LLREL03373GN22M1120', 
                            'LLREL03373GN22M172', 'LLREL03373GN31M1120', 
                            'LLREL03373GN31M172', 'LLREL03373TT40120', 'LLREL03373TT4072', 
                            'LLREL03378GN22120', 'LLREL03378GN2272', 'LLREL03378GN22M1120', 
                            'LLREL03378GN22M172', 'LLREL03378GN22M2120', 
                            'LLREL03378GN22M272', 'LLREL03378GN31120', 'LLREL03378GN3172', 
                            'LLREL03378GN31M1120', 'LLREL03378GN31M172', 'LLREL03378GN40120', 
                            'LLREL03378GN4072', 'LLREL03378TT22MMT120', 'LLREL03378TT22MMT72', 
                            'LLREL03378TT40120', 'LLREL03378TT4072', 'LLREL0338522120', 
                            'LLREL033852272', 'LLREL0338522M1120', 'LLREL0338522M172', 
                            'LLREL0338522M2120', 'LLREL0338522M272', 'LLREL0338531120', 
                            'LLREL033853172', 'LLREL0338531M1120', 'LLREL0338531M172', 
                            'LLREL0338540120', 'LLREL033854072', 'LLREL0377021MR1120', 
                            'LLREL0377021MR172', 'LLREL0377030120', 'LLREL037703072', 
                            'LLREL0381621MR1120', 'LLREL0381621MR172', 'LLREL0381630120', 
                            'LLREL038163072', 'LLREL0407311AMR172', 'LLREL0407320A72', 
                            'LLREL0407321AMR172', 'LLREL0407330A72', 'LLREL0407332AMR272', 
                            'LLREL0407350A72', 'LLREL0407611UB172', 'LLREL040762072', 
                            'LLREL0407621UB172', 'LLREL040763072', 'LLREL0407632UB272', 
                            'LLREL040765072', 'LLREL04262A11UB148', 'LLREL04262A11UB160', 
                            'LLREL04262S11UB1120', 'LLREL04262S11UB172', 'LLREL0428611M1120', 
                            'LLREL0428611M172', 'LLREL0428620120', 'LLREL042862072', 
                            'LLREL0431511AA120', 'LLREL0431511AA72', 'LLREL0431511AZ120', 
                            'LLREL0431511AZ72', 'LLREL0431520A120', 'LLREL0431520A72', 
                            'LLREL0431520Z120', 'LLREL0431520Z72', 'LLREL0431521AA120', 
                            'LLREL0431521AA72', 'LLREL0431521AZ120', 'LLREL0431521AZ72', 
                            'LLREL0431530A120', 'LLREL0431530A72', 'LLREL0431530Z72', 
                            'LLREL0431532AA120', 'LLREL0431532AA72', 'LLREL0431532AZ120', 
                            'LLREL0431532AZ72', 'LLREL0431550A120', 'LLREL0431550A72', 
                            'LLREL0431550Z120', 'LLREL0431550Z72', 'LLREL0475572', 
                            'LLREL0475672', 'LLREL0481431U172', 'LLREL05451A110', 
                            'LLREL05451A111', 'LLREL05451A112', 'LLREL05451A113', 
                            'LLREL05451A114', 'LLREL05451A115', 'LLREL05451A116', 
                            'LLREL05451A117', 'LLREL0806232', 'LLREL0806832', 'LLREL080863', 
                            'LLREL080923', 'LLREL081803', 'LLREL420813', 'LLREL420823', 
                            'LLREL5241332', 'LLREL524263C', 'LLREL524263G', 'LLREL524633', 
                            'LLREL524903', 'LLREPTWSLP367224', 'LLREPTWSLP367230', 
                            'LLREPWSLP367224', 'LLREPWSLP367230', 'LLREWSCCLP363624', 
                            'LLREWSCCLP423624', 'LLREWSCCLP424224', 'LLREWSCCLP424230', 
                            'LLREWSCCLP483624', 'LLREWSCCLP484224', 'LLREWSCCLP484230', 
                            'LLREWSCCLP484824', 'LLREWSCCLP484830', 'LLREWSCCLP603624', 
                            'LLREWSCCLP604224', 'LLREWSCCLP604230', 'LLREWSCCLP604824', 
                            'LLREWSCCLP604830', 'LLREWSLP2424', 'LLREWSLP2430', 
                            'LLREWSLP2436', 'LLREWSLP2442', 'LLREWSLP2448', 'LLREWSLP3024', 
                            'LLREWSLP3030', 'LLREWSLP3036', 'LLREWSLP3042', 'LLREWSLP3048'
                        )
                    )
                    OR (pt.reference_mask IS NULL AND pt.pricelist = TRUE)
                )
        """)
        
        columns = [desc[0] for desc in cursor.description]
        
        print("Procesando y sincronizando productos...")
        batch_size = 100
        current_batch = []
        
        # Obtener un mapa de los productos existentes en Supabase para preservar las URLs de imágenes
        print("Obteniendo productos existentes en Supabase para preservar imágenes...")
        try:
            existing_products_result = supabase.table('products_cache').select('reference_mask,image_url').execute()
            existing_products_map = {}
            if existing_products_result.data:
                for product in existing_products_result.data:
                    if product.get('reference_mask') and product.get('image_url'):
                        existing_products_map[product['reference_mask']] = product['image_url']
                print(f"Se encontraron {len(existing_products_map)} productos con imágenes en Supabase")
        except Exception as e:
            print(f"Error al obtener productos existentes: {str(e)}")
            existing_products_map = {}
        
        for row in cursor.fetchall():
            total_products += 1
            
            try:
                # Convertir a diccionario
                product = dict(zip(columns, row))
                
                # Validar datos requeridos
                if not product['id']:
                    raise ValueError(f"ID faltante para el producto: {product.get('name_spanish', 'N/A')}")
                
                # Si reference_mask es nulo, usar note_pricelist
                if product['reference_mask'] is None and product.get('note_pricelist'):
                    product['reference_mask'] = product['note_pricelist']
                
                # Filtrar solo los campos que existen en la tabla products_cache
                allowed_fields = [
                    'id', 'name_spanish', 'reference_mask', 'type_id', 'family_id', 
                    'line_id', 'group_id', 'type_name', 'family_name', 
                    'line_name', 'group_name', 'is_line', 'active', 
                    'default_code', 'description_sale', 'image_url', 'last_sync'
                ]
                
                # Crear un nuevo diccionario con solo los campos permitidos y mapear name_spanish a name
                filtered_product = {}
                for field in allowed_fields:
                    if field in product:
                        if field == 'name_spanish':
                            filtered_product['name'] = product[field]  # Usar name_spanish como name
                        else:
                            filtered_product[field] = product[field]
                
                # Verificar si el producto tiene una URL de imagen en Supabase
                has_existing_image = False
                if filtered_product.get('reference_mask') and filtered_product['reference_mask'] in existing_products_map:
                    filtered_product['image_url'] = existing_products_map[filtered_product['reference_mask']]
                    has_existing_image = True
                    preserved_images += 1
                    print(f"Preservando imagen para {filtered_product['reference_mask']}: {filtered_product['image_url']}")
                
                # Si no tiene imagen existente, intentar obtenerla de cotizador_imagenproducto
                if not has_existing_image and filtered_product.get('reference_mask'):
                    image_result = supabase.table('cotizador_imagenproducto')\
                        .select('url')\
                        .eq('clave_padre', filtered_product['reference_mask'])\
                        .execute()
                    
                    # Agregar URL de imagen si existe
                    if image_result.data:
                        filtered_product['image_url'] = image_result.data[0]['url']
                        products_with_images += 1
                    else:
                        filtered_product['image_url'] = None
                elif not has_existing_image:
                    filtered_product['image_url'] = None
                
                # Agregar timestamp
                filtered_product['last_sync'] = datetime.now().isoformat()
                
                current_batch.append(filtered_product)
                
                # Si alcanzamos el tamaño del lote, sincronizar
                if len(current_batch) >= batch_size:
                    try:
                        batch_number = total_products // batch_size
                        print(f"Sincronizando lote {batch_number} ({len(current_batch)} productos)...")
                        
                        # Eliminar duplicados en el lote basado en reference_mask
                        unique_batch = {}
                        for item in current_batch:
                            if item.get('reference_mask'):  # Solo incluir si tiene reference_mask (que puede venir de note_pricelist)
                                unique_batch[item['reference_mask']] = item
                            else:
                                print(f" Advertencia: Producto ID {item.get('id')} sin reference_mask ni note_pricelist")
                        unique_batch = list(unique_batch.values())
                        
                        if unique_batch:
                            result = supabase.table('products_cache').upsert(unique_batch, on_conflict='reference_mask').execute()
                            
                            if result.data:
                                successful_products += len(unique_batch)
                                print(f" Lote {batch_number} sincronizado")
                            else:
                                raise Exception("No se recibió confirmación de Supabase")
                        else:
                            print(f" Lote {batch_number} no contenía productos válidos para sincronizar")
                            
                    except Exception as e:
                        print(f" Error en lote {batch_number}: {str(e)}")
                    
                    # Limpiar el lote actual
                    current_batch = []
                    
                    # Pequeña pausa para evitar sobrecarga
                    time.sleep(0.5)
                
            except Exception as e:
                print(f" Error en producto {row[2] if len(row) > 2 else 'desconocido'}: {str(e)}")

        # Sincronizar el último lote si quedaron productos
        if current_batch:
            try:
                print(f"\nSincronizando lote final ({len(current_batch)} productos)...")
                
                # Eliminar duplicados en el lote final basado en reference_mask
                unique_batch = {}
                for item in current_batch:
                    if item.get('reference_mask'):  # Solo incluir si tiene reference_mask (que puede venir de note_pricelist)
                        unique_batch[item['reference_mask']] = item
                    else:
                        print(f" Advertencia: Producto ID {item.get('id')} sin reference_mask ni note_pricelist")
                unique_batch = list(unique_batch.values())
                
                if unique_batch:
                    result = supabase.table('products_cache').upsert(unique_batch, on_conflict='reference_mask').execute()
                    
                    if result.data:
                        successful_products += len(unique_batch)
                        print(" Lote final sincronizado")
                    else:
                        raise Exception("No se recibió confirmación de Supabase")
                else:
                    print(" Lote final no contenía productos válidos para sincronizar")
                    
            except Exception as e:
                print(f" Error en lote final: {str(e)}")

        # Mostrar resumen
        end_time = datetime.now()
        duration = end_time - start_time
        
        print("\n=== Resumen de Sincronización ===")
        print(f"Tiempo total: {duration}")
        print(f"Productos en ERP: {total_products}")
        print(f"Productos sincronizados: {successful_products}")
        print(f"Productos con imágenes: {products_with_images}")
        print(f"Imágenes preservadas: {preserved_images}")
        print(f"Productos sin imágenes: {total_products - products_with_images - preserved_images}")
        
        if successful_products < total_products:
            print(f" No se sincronizaron {total_products - successful_products} productos")
        
        return {
            "total": total_products,
            "successful": successful_products,
            "with_images": products_with_images,
            "preserved_images": preserved_images,
            "duration": str(duration)
        }

def sync_clients_to_supabase(clients_data):
    """
    Sincroniza los clientes desde la API de Odoo a Supabase.
    
    Args:
        clients_data (list): Lista de diccionarios con los datos de los clientes
        
    Returns:
        dict: Estadísticas de la sincronización
    """
    print("Iniciando sincronización de clientes a Supabase...")
    
    # Configuración de Supabase
    print("Conectando a Supabase...")
    supabase: Client = create_client(
        settings.SUPABASE_URL,
        settings.SUPABASE_KEY
    )

    # Estadísticas
    total_clients = len(clients_data)
    successful_clients = 0
    error_count = 0
    start_time = datetime.now()
    
    if not clients_data:
        print("No hay clientes para sincronizar")
        return {
            'total': 0,
            'successful': 0,
            'errors': 0,
            'duration': "0:00:00"
        }
    
    print(f"Procesando {total_clients} clientes...")
    
    # Procesar los clientes en lotes para evitar sobrecarga
    batch_size = 50
    current_batch = []
    
    for client in clients_data:
        try:
            # Verificar que el cliente tenga partner_id
            if not client.get('partner_id'):
                print(f"Cliente sin partner_id: {client}")
                error_count += 1
                continue
            
            # Filtrar solo los campos que necesitamos
            filtered_client = {
                'partner_id': client.get('partner_id'),
                'name_partner': client.get('name_partner', ''),
                'rfc': client.get('rfc', '')
            }
            
            current_batch.append(filtered_client)
            
            # Si alcanzamos el tamaño del lote, sincronizar
            if len(current_batch) >= batch_size:
                try:
                    batch_number = (successful_clients + error_count) // batch_size
                    print(f"Sincronizando lote {batch_number} ({len(current_batch)} clientes)...")
                    
                    # Eliminar duplicados en el lote basado en partner_id
                    unique_batch = {}
                    for item in current_batch:
                        if item.get('partner_id'):
                            unique_batch[item['partner_id']] = item
                        else:
                            print(f" Advertencia: Cliente sin partner_id")
                    unique_batch = list(unique_batch.values())
                    
                    if unique_batch:
                        result = supabase.table('cotizador_cliente').upsert(unique_batch, on_conflict='partner_id').execute()
                        
                        if result.data:
                            successful_clients += len(unique_batch)
                            print(f" Lote {batch_number} sincronizado")
                        else:
                            raise Exception("No se recibió confirmación de Supabase")
                    else:
                        print(f" Lote {batch_number} no contenía clientes válidos para sincronizar")
                        
                except Exception as e:
                    print(f" Error en lote {batch_number}: {str(e)}")
                    error_count += len(current_batch)
                
                # Limpiar el lote actual
                current_batch = []
                
                # Pequeña pausa para evitar sobrecarga
                time.sleep(0.5)
            
        except Exception as e:
            print(f" Error en cliente {client.get('partner_id', 'desconocido')}: {str(e)}")
            error_count += 1
    
    # Sincronizar el último lote si quedaron clientes
    if current_batch:
        try:
            print(f"\nSincronizando lote final ({len(current_batch)} clientes)...")
            
            # Eliminar duplicados en el lote final basado en partner_id
            unique_batch = {}
            for item in current_batch:
                if item.get('partner_id'):
                    unique_batch[item['partner_id']] = item
                else:
                    print(f" Advertencia: Cliente sin partner_id")
            unique_batch = list(unique_batch.values())
            
            if unique_batch:
                result = supabase.table('cotizador_cliente').upsert(unique_batch, on_conflict='partner_id').execute()
                
                if result.data:
                    successful_clients += len(unique_batch)
                    print(" Lote final sincronizado")
                else:
                    raise Exception("No se recibió confirmación de Supabase")
            else:
                print(" Lote final no contenía clientes válidos para sincronizar")
                
        except Exception as e:
            print(f" Error en lote final: {str(e)}")
            error_count += len(current_batch)
    
    # Mostrar resumen
    end_time = datetime.now()
    duration = end_time - start_time
    
    print("\n=== Resumen de Sincronización de Clientes ===")
    print(f"Tiempo total: {duration}")
    print(f"Clientes totales: {total_clients}")
    print(f"Clientes sincronizados: {successful_clients}")
    print(f"Errores: {error_count}")
    
    if successful_clients < total_clients:
        print(f" No se sincronizaron {total_clients - successful_clients} clientes")
    
    return {
        'total': total_clients,
        'successful': successful_clients,
        'errors': error_count,
        'duration': str(duration)
    }

def get_clients_from_supabase():
    """
    Obtiene todos los clientes desde Supabase.
    
    Returns:
        list: Lista de diccionarios con los datos de los clientes
    """
    print("Obteniendo clientes desde Supabase...")
    
    # Configuración de Supabase
    supabase: Client = create_client(
        settings.SUPABASE_URL,
        settings.SUPABASE_KEY
    )
    
    try:
        # Consultar todos los clientes
        result = supabase.table('cotizador_cliente').select('*').execute()
        
        if result.data:
            print(f"Se encontraron {len(result.data)} clientes en Supabase")
            return result.data
        else:
            print("No se encontraron clientes en Supabase")
            return []
            
    except Exception as e:
        print(f"Error al obtener clientes desde Supabase: {str(e)}")
        return []
```

## apps\cotizador\cache\tasks.py

- Characters: 556
- Tokens: 0

```python
from celery import shared_task
from celery.schedules import crontab
from celery.utils.log import get_task_logger
from .sync import sync_products_to_supabase

logger = get_task_logger(__name__)

@shared_task
def sync_products_task():
    """
    Tarea Celery para sincronizar productos desde PostgreSQL a Supabase
    """
    try:
        result = sync_products_to_supabase()
        logger.info(f'Sincronización completada: {result}')
        return result
    except Exception as e:
        logger.error(f'Error en sincronización: {str(e)}')
        raise
```

## apps\cotizador\cache\urls.py

- Characters: 228
- Tokens: 0

```python
from rest_framework.routers import DefaultRouter
from .views import ProductsCacheViewSet

# Crear el router
router = DefaultRouter()
router.register('', ProductsCacheViewSet, basename='products-cache')

urlpatterns = router.urls
```

## apps\cotizador\cache\views.py

- Characters: 21492
- Tokens: 0

```python
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from rest_framework.pagination import PageNumberPagination
from django_filters import rest_framework as filters
import requests
from django.db.models import Q
from django.conf import settings
from urllib.parse import urlencode
from .models import ProductsCache
from .serializers import ProductsCacheSerializer, ProductImageUploadSerializer
from apps.cotizador.models import CotizadorImagenproducto
from apps.cotizador.utils.upload_helpers import upload_image_to_supabase
from supabase import create_client, Client

class CustomPagination(PageNumberPagination):
    """
    Paginación personalizada que permite al cliente especificar el tamaño de página
    """
    page_size = 10
    page_size_query_param = 'page_size'
    max_page_size = 100

    def get_paginated_response(self, data):
        return Response({
            'total': self.page.paginator.count,
            'page_size': self.get_page_size(self.request),
            'current_page': self.page.number,
            'total_pages': self.page.paginator.num_pages,
            'next': self.get_next_link(),
            'previous': self.get_previous_link(),
            'results': data
        })

    def get_next_link(self):
        if not self.page.has_next():
            return None
        
        url = self.request.build_absolute_uri()
        page_number = self.page.next_page_number()
        
        return self._replace_query_param(url, self.page_query_param, page_number)

    def get_previous_link(self):
        if not self.page.has_previous():
            return None
        
        url = self.request.build_absolute_uri()
        page_number = self.page.previous_page_number()
        
        return self._replace_query_param(url, self.page_query_param, page_number)

    def _replace_query_param(self, url, key, value):
        """
        Dado un URL, reemplaza o agrega un parámetro y su valor.
        """
        # Separar la base de la URL de los parámetros de consulta
        base_url = url.split('?')[0]
        query_params = {}
        
        # Si hay parámetros de consulta, convertirlos a diccionario
        if '?' in url:
            query_string = url.split('?')[1]
            query_params = dict(param.split('=') for param in query_string.split('&'))
        
        # Actualizar o agregar el nuevo parámetro
        query_params[key] = value
        
        # Reconstruir la URL con los parámetros actualizados
        new_query = urlencode(query_params)
        return f"{base_url}?{new_query}" if new_query else base_url

class ProductFilter(filters.FilterSet):
    """
    Filtros para productos en caché.
    
    Ejemplos de uso:
    - Búsqueda general: ?search=texto (busca en nombre, tipo, familia, grupo y línea)
    - Filtrar por tipo específico: ?tipo=Divisor
    - Filtrar por familia específica: ?familia=Mamparas
    - Filtrar por grupo específico: ?grupo=GEBESA
    - Filtrar por línea específica: ?linea=Zone
    """
    search = filters.CharFilter(method='filter_search')
    tipo = filters.CharFilter(field_name='type_name', lookup_expr='icontains')
    familia = filters.CharFilter(field_name='family_name', lookup_expr='icontains')
    grupo = filters.CharFilter(field_name='group_name', lookup_expr='icontains')
    linea = filters.CharFilter(field_name='line_name', lookup_expr='icontains')

    def filter_search(self, queryset, name, value):
        """
        Búsqueda que coincide con cualquier campo especificado
        """
        return queryset.filter(
            Q(name__icontains=value) |
            Q(type_name__icontains=value) |
            Q(family_name__icontains=value) |
            Q(line_name__icontains=value) |
            Q(group_name__icontains=value)
        )

    class Meta:
        model = ProductsCache
        fields = ['search', 'tipo', 'familia', 'grupo', 'linea']

class ProductsCacheViewSet(viewsets.ReadOnlyModelViewSet):
    """
    API endpoint para consultar productos en caché.
    Soporta:
    - Paginación:
      * Página actual: ?page=1
      * Tamaño de página: ?page_size=10 (máximo 100)
    - Búsqueda general con ?search= (busca en nombre, tipo, familia, grupo y línea)
    - Filtros específicos por tipo, familia, grupo y línea
    - Ordenamiento por cualquier campo
    
    Ejemplos de uso:
    - Paginación: 
      * /api/v1/cotizador/productos/?page=1&page_size=20
    - Búsqueda general: 
      * /api/v1/cotizador/productos/?search=escritorio
    - Filtros específicos:
      * /api/v1/cotizador/productos/?tipo=Divisor
      * /api/v1/cotizador/productos/?familia=Mamparas
      * /api/v1/cotizador/productos/?grupo=Accesorios
      * /api/v1/cotizador/productos/?linea=Zone
    
    Se pueden combinar todos los parámetros:
    - /api/v1/cotizador/productos/?search=metal&familia=Mamparas&page=1&page_size=20
    """
    queryset = ProductsCache.objects.all()
    serializer_class = ProductsCacheSerializer
    permission_classes = [IsAuthenticated]
    filterset_class = ProductFilter
    pagination_class = CustomPagination
    ordering_fields = '__all__'
    ordering = ['name']

    def _parse_precios(self, precios_str):
        """Obtiene el precio base del producto como un float"""
        if not precios_str:
            return None
            
        try:
            for precio in precios_str.split('|'):
                if not precio:
                    continue
                    
                partes = precio.split(':')
                if len(partes) >= 2:
                    id_precio = partes[0]
                    valor = partes[1]
                    # Solo nos interesa el precio base
                    if id_precio == "Precio base":
                        return float(valor)
            return None
            
        except Exception:
            return None

    def _parse_ids_precios(self, ids_precios_str):
        """Convierte el string de ids_precios en un diccionario con valores float"""
        if not ids_precios_str:
            return {}
            
        try:
            ids_precios = {}
            for precio in ids_precios_str.split('|'):
                if not precio:
                    continue
                    
                partes = precio.split(':')
                if len(partes) >= 2:
                    id_precio = partes[0]
                    try:
                        valor = float(partes[1])
                        ids_precios[id_precio] = valor
                    except ValueError:
                        continue
                    
            # Solo retornar los IDs que nos interesan
            ids_filtrados = {k: v for k, v in ids_precios.items() if k in ['32', '43', '40', '33', '34', '38']}
            return ids_filtrados
            
        except Exception:
            return {}

    def _process_product_data(self, product):
        """Procesa y estructura los datos del producto"""
        return {
            "informacion_general": {
                "id_externo": product.get("id_externo"),
                "tmpl_id": product.get("tmpl_id"),
                "product_id": product.get("product_id"),
                "clave": product.get("clave"),
                "producto": product.get("producto"),
                "descripcion_venta": product.get("descripcion_venta"),
                "traduccion_producto": product.get("traduccion_producto"),
                "traduccion_template_producto": product.get("traduccion_template_producto")
            },
            "clasificacion": {
                "familia": {
                    "id": product.get("familia_id"),
                    "nombre": product.get("familia")
                },
                "grupo": {
                    "id": product.get("grupo_id"),
                    "nombre": product.get("grupo")
                },
                "linea": {
                    "id": product.get("linea_id"),
                    "nombre": product.get("linea")
                },
                "tipo": {
                    "id": product.get("tipo_id"),
                    "nombre": product.get("tipo")
                }
            },
            "atributos": {
                "atributos_str": product.get("atributos"),
                "ids_atributos": product.get("ids_atributos")
            },
            "precios": {
                "precio_base": self._parse_precios(product.get("precios")),
                "precios_unidades": self._parse_ids_precios(product.get("ids_precios"))
            },
            "empresa": {
                "id": product.get("id_empresa"),
                "nombre": product.get("nombre_empresa")
            },
            "sat": {
                "id": product.get("id_sat"),
                "codigo": product.get("codigo_sat"),
                "nombre": product.get("nombre_sat")
            },
            "medidas": {
                "uom": product.get("uom"),
                "medida_compra": product.get("medida_compra"),
                "medida_compra_tipo": product.get("medida_compra_tipo"),
                "medida_compra_factor": product.get("medida_compra_factor")
            },
            "peso_y_volumen": {
                "peso_bruto": product.get("peso_bruto"),
                "volumen": product.get("volumen")
            },
            "rutas": {
                "ruta_id": product.get("ruta_id"),
                "ruta_nombre": product.get("ruta_nombre"),
                "rutas_ids": product.get("rutas_ids")
            }
        }

    @action(detail=False, methods=['get'], url_path='detalles/(?P<clave>[^/.]+)')
    def get_details(self, request, clave=None):
        """
        Obtiene los detalles y datos del producto desde la API externa
        """
        if not clave:
            return Response(
                {"error": "Debe proporcionar una clave de producto"},
                status=status.HTTP_400_BAD_REQUEST
            )

        try:
            # URL de la API externa
            api_url = "https://api2.ercules.mx/api/v1/common/product_data"
            
            # Parámetros de la consulta
            params = {
                "user_id": 2,
                "products": 0,
                "product_tmpl_ids": clave,
                "line_ids": 0,
                "group_ids": 0,
                "type_ids": 0,
                "family_ids": 0,
                "only_line": 1
            }

            # Realizar la petición a la API externa
            response = requests.get(api_url, params=params)
            
            # Verificar si la petición fue exitosa
            if response.status_code == 200:
                data = response.json()
                # Procesar cada producto en la respuesta
                processed_data = [self._process_product_data(product) for product in data]
                return Response(processed_data)
            else:
                return Response(
                    {"error": f"Error al consultar la API externa: {response.status_code}"},
                    status=status.HTTP_502_BAD_GATEWAY
                )

        except requests.RequestException as e:
            return Response(
                {"error": f"Error de conexión: {str(e)}"},
                status=status.HTTP_503_SERVICE_UNAVAILABLE
            )
        except Exception as e:
            return Response(
                {"error": f"Error inesperado: {str(e)}"},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

    @action(detail=False, methods=['get'], url_path='precio/(?P<reference_mask>[^/.]+)')
    def precio(self, request, reference_mask=None):
        """
        Obtiene los detalles completos y precios de un producto por su reference_mask
        
        Ejemplo de uso:
        - /api/v1/cotizador/productos/precio/777789/
        """
        if not reference_mask:
            return Response(
                {"error": "Debe proporcionar un reference_mask de producto"},
                status=status.HTTP_400_BAD_REQUEST
            )

        try:
            # URL de la API externa
            api_url = "https://api2.ercules.mx/api/v1/common/product_data"
            
            # Parámetros de la consulta
            params = {
                "user_id": 2,
                "products": 0,
                "product_tmpl_ids": reference_mask,
                "line_ids": 0,
                "group_ids": 0,
                "type_ids": 0,
                "family_ids": 0,
                "only_line": 1
            }

            # Realizar la petición a la API externa
            response = requests.get(api_url, params=params)
            
            # Verificar si la petición fue exitosa
            if response.status_code == 200:
                data = response.json()
                if not data:
                    return Response(
                        {'error': f'No se encontró el producto con reference_mask: {reference_mask}'},
                        status=status.HTTP_404_NOT_FOUND
                    )
                    
                # Procesar el primer producto en la respuesta
                processed_data = self._process_product_data(data[0])
                
                # Intentar obtener datos del caché si existen
                try:
                    cached_product = ProductsCache.objects.get(reference_mask=reference_mask)
                    processed_data['cache'] = {
                        'id': cached_product.id,
                        'reference_mask': cached_product.reference_mask,
                        'name': cached_product.name,
                        'image_url': cached_product.image_url,
                        'last_sync': cached_product.last_sync
                    }
                except ProductsCache.DoesNotExist:
                    processed_data['cache'] = None
                
                return Response(processed_data)
            else:
                return Response(
                    {"error": f"Error al consultar la API externa: {response.status_code}"},
                    status=status.HTTP_502_BAD_GATEWAY
                )

        except requests.RequestException as e:
            return Response(
                {"error": f"Error de conexión: {str(e)}"},
                status=status.HTTP_503_SERVICE_UNAVAILABLE
            )
        except Exception as e:
            return Response(
                {'error': f'Error al obtener la información: {str(e)}'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

    @action(detail=False, methods=['get'])
    def tipos(self, request):
        """
        Obtener lista única de tipos de productos
        """
        tipos = ProductsCache.objects.values_list('type_name', flat=True).distinct().order_by('type_name')
        return Response(list(tipos))

    @action(detail=False, methods=['get'])
    def lineas(self, request):
        """
        Obtener lista única de líneas de productos
        """
        lineas = ProductsCache.objects.values_list('line_name', flat=True).distinct().order_by('line_name')
        return Response(list(lineas))

    @action(detail=False, methods=['get'])
    def familias(self, request):
        """
        Obtener lista única de familias de productos
        """
        familias = ProductsCache.objects.values_list('family_name', flat=True).distinct().order_by('family_name')
        return Response(list(familias))

    @action(detail=False, methods=['get'])
    def grupos(self, request):
        """
        Obtener lista única de grupos de productos
        """
        grupos = ProductsCache.objects.values_list('group_name', flat=True).distinct().order_by('group_name')
        return Response(list(grupos))

    @action(detail=False, methods=['get'])
    def categorias(self, request):
        """
        Obtener todas las categorías (tipos, líneas, familias, grupos) en un solo request
        """
        tipos = ProductsCache.objects.values_list('type_name', flat=True).distinct().order_by('type_name')
        lineas = ProductsCache.objects.values_list('line_name', flat=True).distinct().order_by('line_name')
        familias = ProductsCache.objects.values_list('family_name', flat=True).distinct().order_by('family_name')
        grupos = ProductsCache.objects.values_list('group_name', flat=True).distinct().order_by('group_name')
        
        return Response({
            'tipos': list(tipos),
            'lineas': list(lineas),
            'familias': list(familias),
            'grupos': list(grupos)
        })

    @action(detail=False, methods=['get'], url_path='sin-imagenes')
    def sin_imagenes(self, request):
        """
        Obtiene una lista de productos que no tienen imágenes.
        
        Ejemplo de uso:
        - /api/v1/cotizador/productos/sin-imagenes/
        
        Soporta los mismos filtros y paginación que el endpoint principal.
        """
        # Filtrar productos sin imagen
        queryset = self.filter_queryset(self.get_queryset().filter(
            Q(image_url__isnull=True) | Q(image_url='')
        ))
        
        # Aplicar paginación
        page = self.paginate_queryset(queryset)
        if page is not None:
            serializer = self.get_serializer(page, many=True)
            return self.get_paginated_response(serializer.data)
        
        serializer = self.get_serializer(queryset, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['post'], url_path='cargar-imagen')
    def cargar_imagen(self, request):
        """
        Carga una imagen para un producto específico.
        
        Ejemplo de uso:
        - POST /api/v1/cotizador/productos/cargar-imagen/
        
        Parámetros:
        - image: Archivo de imagen (multipart/form-data)
        - reference_mask: Identificador único del producto
        
        Retorna:
        - URL de la imagen cargada
        - Información actualizada del producto
        """
        return self._procesar_carga_imagen(request)
    
    @action(detail=False, methods=['post'], url_path='cargar-imagenes')
    def cargar_imagenes(self, request):
        """
        Alias para cargar-imagen. Carga una imagen para un producto específico.
        
        Ejemplo de uso:
        - POST /api/v1/cotizador/productos/cargar-imagenes/
        
        Parámetros:
        - image: Archivo de imagen (multipart/form-data)
        - reference_mask: Identificador único del producto
        
        Retorna:
        - URL de la imagen cargada
        - Información actualizada del producto
        """
        return self._procesar_carga_imagen(request)
    
    def _procesar_carga_imagen(self, request):
        """
        Método interno para procesar la carga de imágenes.
        Usado por los endpoints cargar-imagen y cargar-imagenes.
        """
        serializer = ProductImageUploadSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        # Obtener datos validados
        image_file = serializer.validated_data['image']
        reference_mask = serializer.validated_data['reference_mask']
        
        # Obtener el producto
        product = ProductsCache.objects.filter(reference_mask=reference_mask).first()
        if not product:
            return Response(
                {"error": f"No se encontró ningún producto con reference_mask: {reference_mask}"},
                status=status.HTTP_404_NOT_FOUND
            )
        
        # Subir la imagen a Supabase Storage
        image_url, error = upload_image_to_supabase(
            image_file=image_file,
            line_name=product.line_name or "otros",
            reference_mask=reference_mask
        )
        
        if error:
            return Response({"error": error}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
        
        # Actualizar o crear el registro en CotizadorImagenproducto
        imagen_producto, created = CotizadorImagenproducto.objects.update_or_create(
            clave_padre=reference_mask,
            defaults={'url': image_url}
        )
        
        # Actualizar el campo image_url en Supabase
        try:
            supabase: Client = create_client(
                settings.SUPABASE_URL,
                settings.SUPABASE_KEY
            )
            
            result = supabase.table('products_cache').update(
                {"image_url": image_url}
            ).eq('reference_mask', reference_mask).execute()
            
            # Actualizar el objeto local para la respuesta
            product.image_url = image_url
            product.save()
            
        except Exception as e:
            # Si falla la actualización en Supabase, al menos tenemos la imagen en CotizadorImagenproducto
            return Response({
                "warning": f"La imagen se cargó correctamente, pero no se pudo actualizar en Supabase: {str(e)}",
                "image_url": image_url,
                "product": ProductsCacheSerializer(product).data
            }, status=status.HTTP_207_MULTI_STATUS)
        
        return Response({
            "message": "Imagen cargada y actualizada correctamente",
            "image_url": image_url,
            "product": ProductsCacheSerializer(product).data
        }, status=status.HTTP_200_OK)
```

## apps\cotizador\cache\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\cotizador\management\commands\compare_prime_storage_with_cache.py

- Characters: 13229
- Tokens: 0

```python
from django.core.management.base import BaseCommand
from supabase import create_client, Client
from apps.cotizador.cache.models import ProductsCache
import os
import logging
from collections import defaultdict
import re

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Compara los archivos en la carpeta Prime de Supabase con los registros de ProductsCache'

    def add_arguments(self, parser):
        parser.add_argument(
            '--detail',
            action='store_true',
            dest='detail',
            default=False,
            help='Mostrar detalle completo de archivos y productos',
        )
        parser.add_argument(
            '--folder',
            type=str,
            default='Prime',
            help='Nombre de la carpeta a comparar (por defecto: Prime)',
        )
        parser.add_argument(
            '--show-duplicates',
            action='store_true',
            dest='show_duplicates',
            default=False,
            help='Mostrar archivos que comparten la misma clave de producto',
        )
        parser.add_argument(
            '--min-files',
            type=int,
            default=2,
            help='Número mínimo de archivos para considerar como duplicados (por defecto: 2)',
        )

    def handle(self, *args, **options):
        SUPABASE_URL = "https://wlwxbdlmrcgjzmnjovbm.supabase.co"
        SUPABASE_KEY = (
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indsd3hiZGxtcmNnanptbmpvdmJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczOTM4MjI1MSwiZXhwIjoyMDU0OTU4MjUxfQ.QgMuPGN3I3WDv5G7nYK5DR23eiyBZfbf_tn2ZjxhCa8"
        )
        BUCKET_NAME = "imagenes-productos"
        show_detail = options['detail']
        folder_name = options['folder']
        show_duplicates = options['show_duplicates']
        min_files = options['min_files']

        # Contadores y estructuras de datos
        archivos_storage = []
        codigos_producto_storage = set()
        productos_cache = []
        codigos_producto_cache = set()
        # Diccionario para agrupar archivos por código de producto
        archivos_por_codigo = defaultdict(list)

        try:
            supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)
            self.stdout.write(self.style.SUCCESS(f"Conexión exitosa a Supabase"))

            # 1. Obtener archivos de la carpeta especificada en Supabase Storage
            self.stdout.write(f"Obteniendo archivos de la carpeta '{folder_name}' en Supabase Storage...")
            ruta_carpeta = f"Imagenes/{folder_name}"
            archivos_storage = self.listar_contenido_con_paginacion(supabase, BUCKET_NAME, ruta_carpeta)
            
            # Extraer códigos de producto de los nombres de archivo
            for archivo in archivos_storage:
                nombre_archivo = archivo["name"]
                codigo_producto = self.extraer_clave_producto(nombre_archivo)
                if codigo_producto:
                    codigos_producto_storage.add(codigo_producto)
                    # Guardar el archivo en el diccionario agrupado por código
                    archivos_por_codigo[codigo_producto].append(nombre_archivo)

            # 2. Obtener productos de ProductsCache con line_name igual al nombre de la carpeta
            self.stdout.write(f"Obteniendo productos de ProductsCache con line_name='{folder_name}'...")
            productos_cache = list(ProductsCache.objects.filter(line_name__iexact=folder_name, active=True))
            
            # Extraer códigos de producto de ProductsCache
            for producto in productos_cache:
                codigo_producto = self.extraer_clave_producto(producto.reference_mask)
                if codigo_producto:
                    codigos_producto_cache.add(codigo_producto)

            # 3. Comparar resultados
            self.stdout.write(self.style.SUCCESS(f"\nResultados de la comparación:"))
            self.stdout.write(f"- Total de archivos en Storage (carpeta {folder_name}): {len(archivos_storage)}")
            self.stdout.write(f"- Total de códigos de producto únicos en Storage: {len(codigos_producto_storage)}")
            self.stdout.write(f"- Total de productos en ProductsCache (line_name={folder_name}): {len(productos_cache)}")
            self.stdout.write(f"- Total de códigos de producto únicos en tabla de ProductsCache: {len(codigos_producto_cache)}")
            
            # Calcular estadísticas de archivos duplicados
            archivos_unicos = len(codigos_producto_storage)
            archivos_totales = len(archivos_storage)
            archivos_duplicados = archivos_totales - archivos_unicos
            porcentaje_duplicados = (archivos_duplicados / archivos_totales * 100) if archivos_totales > 0 else 0
            
            # Mostrar resumen de imágenes únicas vs totales
            self.stdout.write("\n" + "=" * 50)
            self.stdout.write(self.style.SUCCESS(f"RESUMEN DE IMÁGENES ÚNICAS VS TOTALES"))
            self.stdout.write("=" * 50)
            self.stdout.write(f"\n- Total de archivos en Storage: {archivos_totales}")
            self.stdout.write(f"- Total de imágenes únicas (por código de producto): {archivos_unicos}")
            self.stdout.write(f"- Archivos duplicados o variantes: {archivos_duplicados}")
            self.stdout.write(f"- Porcentaje de duplicación: {porcentaje_duplicados:.2f}%")
            
            # Distribución de archivos por código de producto
            distribucion = defaultdict(int)
            for codigo, archivos in archivos_por_codigo.items():
                distribucion[len(archivos)] += 1
            
            self.stdout.write("\nDistribución de archivos por código de producto:")
            for num_archivos, cantidad in sorted(distribucion.items()):
                self.stdout.write(f"  - Códigos con {num_archivos} archivo{'s' if num_archivos > 1 else ''}: {cantidad}")

            # Mostrar archivos que comparten la misma clave única
            if show_duplicates:
                self.stdout.write("\n" + "=" * 50)
                self.stdout.write(self.style.SUCCESS(f"ARCHIVOS QUE COMPARTEN LA MISMA CLAVE DE PRODUCTO"))
                self.stdout.write("=" * 50)
                
                # Filtrar códigos con múltiples archivos
                codigos_con_multiples_archivos = {codigo: archivos for codigo, archivos in archivos_por_codigo.items() 
                                                if len(archivos) >= min_files}
                
                if codigos_con_multiples_archivos:
                    self.stdout.write(f"\nSe encontraron {len(codigos_con_multiples_archivos)} códigos de producto con {min_files} o más archivos:")
                    
                    # Ordenar por código de producto
                    for codigo, archivos in sorted(codigos_con_multiples_archivos.items()):
                        self.stdout.write(f"\nCódigo de producto: {codigo} - {len(archivos)} archivos:")
                        for archivo in sorted(archivos):
                            self.stdout.write(f"  - {archivo}")
                else:
                    self.stdout.write(f"\nNo se encontraron códigos de producto con {min_files} o más archivos.")

            # 4. Encontrar diferencias
            codigos_solo_storage = codigos_producto_storage - codigos_producto_cache
            codigos_solo_cache = codigos_producto_cache - codigos_producto_storage
            codigos_en_ambos = codigos_producto_storage.intersection(codigos_producto_cache)

            # 5. Mostrar diferencias
            self.stdout.write("\n" + "=" * 50)
            self.stdout.write(self.style.SUCCESS(f"ANÁLISIS DE DIFERENCIAS"))
            self.stdout.write("=" * 50)
            
            self.stdout.write(f"\nCódigos presentes en ambos sistemas: {len(codigos_en_ambos)}")
            if show_detail and codigos_en_ambos:
                self.stdout.write("Códigos en ambos:")
                for codigo in sorted(codigos_en_ambos):
                    self.stdout.write(f"  - {codigo}")

            self.stdout.write(f"\nCódigos solo en Storage (sin registro en ProductsCache): {len(codigos_solo_storage)}")
            if codigos_solo_storage:
                for codigo in sorted(codigos_solo_storage):
                    archivos_relacionados = [a["name"] for a in archivos_storage 
                                          if self.extraer_clave_producto(a["name"]) == codigo]
                    self.stdout.write(f"  - {codigo}: {len(archivos_relacionados)} archivos")
                    if show_detail:
                        for archivo in sorted(archivos_relacionados):
                            self.stdout.write(f"      {archivo}")

            self.stdout.write(f"\nCódigos solo en ProductsCache (sin imágenes en Storage): {len(codigos_solo_cache)}")
            if codigos_solo_cache:
                for codigo in sorted(codigos_solo_cache):
                    productos_relacionados = [p for p in productos_cache 
                                           if self.extraer_clave_producto(p.reference_mask) == codigo]
                    self.stdout.write(f"  - {codigo}: {len(productos_relacionados)} productos")
                    if show_detail:
                        for producto in sorted(productos_relacionados, key=lambda p: p.reference_mask):
                            self.stdout.write(f"      {producto.reference_mask} - {producto.name}")

            # 6. Verificar productos con imágenes asignadas pero que no existen en Storage
            productos_con_url = [p for p in productos_cache if p.image_url and 
                               self.extraer_clave_producto(p.reference_mask) in codigos_solo_cache]
            
            if productos_con_url:
                self.stdout.write("\n" + "-" * 50)
                self.stdout.write(self.style.WARNING(
                    f"ADVERTENCIA: {len(productos_con_url)} productos tienen URL de imagen asignada "
                    f"pero no se encontraron imágenes correspondientes en Storage"
                ))
                self.stdout.write("-" * 50)
                
                if show_detail:
                    for producto in productos_con_url:
                        self.stdout.write(f"  - {producto.reference_mask} - {producto.name}")
                        self.stdout.write(f"    URL: {producto.image_url}")

        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error: {str(e)}"))
            logger.error(f"Error: {str(e)}")

    def listar_contenido_con_paginacion(self, supabase, bucket_name, ruta_actual):
        """Lista todo el contenido de una carpeta con paginación para superar el límite de 100 elementos"""
        todos_los_items = []
        offset = 0
        limit = 1000  # Máximo número de elementos por solicitud
        
        while True:
            try:
                # Construir opciones de paginación
                options = {
                    "limit": limit,
                    "offset": offset,
                    "sortBy": {
                        "column": "name",
                        "order": "asc"
                    }
                }
                
                # Realizar la solicitud con opciones de paginación
                if ruta_actual:
                    contenido = supabase.storage.from_(bucket_name).list(path=ruta_actual, options=options)
                else:
                    contenido = supabase.storage.from_(bucket_name).list(options=options)
                
                # Si no hay más elementos, salir del bucle
                if not contenido or len(contenido) == 0:
                    break
                    
                # Filtrar solo archivos (no carpetas)
                archivos = [item for item in contenido if item.get("id") is not None]
                todos_los_items.extend(archivos)
                
                # Si recibimos menos elementos que el límite, significa que hemos terminado
                if len(contenido) < limit:
                    break
                    
                # Incrementar el offset para la siguiente solicitud
                offset += limit
                
                # Informar del progreso
                self.stdout.write(f"  Obtenidos {len(todos_los_items)} archivos de {ruta_actual or '[Raíz]'}...")
                
            except Exception as e:
                self.stdout.write(self.style.ERROR(f"Error al listar contenido de {ruta_actual}: {str(e)}"))
                logger.error(f"Error al listar contenido de {ruta_actual}: {str(e)}")
                break
                
        return todos_los_items

    def extraer_clave_producto(self, nombre_archivo):
        """Extrae la clave de producto del nombre del archivo usando expresiones regulares"""
        # Patrón para buscar claves de producto (letras seguidas de números)
        # Por ejemplo: GAA704, ABC123, etc.
        patron = re.compile(r'([A-Za-z]{2,3}\d{3,4})')
        coincidencia = patron.search(nombre_archivo)
        
        if coincidencia:
            return coincidencia.group(1).upper()  # Normalizar a mayúsculas
        return None
```

## apps\cotizador\management\commands\sync_clients.py

- Characters: 8189
- Tokens: 0

```python
from django.core.management.base import BaseCommand
from django.db import transaction
from apps.cotizador.models import Cliente
import requests
import logging
from datetime import datetime
import json
from apps.cotizador.cache.sync import sync_clients_to_supabase

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Sincroniza los clientes desde la API de Odoo a la base de datos local'

    def add_arguments(self, parser):
        parser.add_argument(
            '--user_id',
            type=int,
            default=1,
            help='ID del usuario para filtrar los clientes'
        )
        parser.add_argument(
            '--fecha_ini',
            type=str,
            default='2009-09-01',
            help='Fecha inicial para filtrar los clientes (formato: YYYY-MM-DD)'
        )
        parser.add_argument(
            '--fecha_fin',
            type=str,
            default='2025-09-04',
            help='Fecha final para filtrar los clientes (formato: YYYY-MM-DD)'
        )
        parser.add_argument(
            '--name',
            type=str,
            default='gebesa',
            help='Nombre para filtrar los clientes'
        )
        parser.add_argument(
            '--skip_django',
            action='store_true',
            help='Omitir la sincronización con Django y solo sincronizar con Supabase'
        )
        parser.add_argument(
            '--skip_supabase',
            action='store_true',
            help='Omitir la sincronización con Supabase'
        )

    def handle(self, *args, **options):
        start_time = datetime.now()
        logger.info(f"Iniciando sincronización de clientes: {start_time}")
        
        # Obtener los parámetros de la línea de comandos
        user_id = options['user_id']
        fecha_ini = options['fecha_ini']
        fecha_fin = options['fecha_fin']
        name = options['name']
        skip_django = options['skip_django']
        skip_supabase = options['skip_supabase']
        
        try:
            # Construir la URL con los parámetros
            api_url = f"https://api.ercules.mx/api/v1/common/res_partner"
            params = {
                'user_id': user_id,
                'fecha_ini': fecha_ini,
                'fecha_fin': fecha_fin,
                'name': name
            }
            
            # Realizar la petición a la API
            self.stdout.write(self.style.SUCCESS(f"Consultando API: {api_url}"))
            response = requests.get(api_url, params=params)
            
            # Verificar si la respuesta es exitosa
            if response.status_code != 200:
                self.stdout.write(self.style.ERROR(f"Error al consultar la API: {response.status_code}"))
                logger.error(f"Error al consultar la API: {response.status_code}")
                return
            
            # Convertir la respuesta a JSON
            clients_data = response.json()
            
            if not clients_data:
                self.stdout.write(self.style.WARNING("No se encontraron clientes en la API"))
                logger.warning("No se encontraron clientes en la API")
                return
            
            self.stdout.write(self.style.SUCCESS(f"Se encontraron {len(clients_data)} clientes en la API"))
            
            # Sincronizar con Django si no se omitió
            if not skip_django:
                self.stdout.write(self.style.SUCCESS("Sincronizando con Django..."))
                try:
                    self._sync_clients_to_django(clients_data)
                    self.stdout.write(self.style.SUCCESS("Sincronización con Django completada."))
                except Exception as e:
                    self.stdout.write(self.style.ERROR(f"Error en la sincronización con Django: {str(e)}"))
                    logger.error(f"Error en la sincronización con Django: {str(e)}")
            
            # Sincronizar con Supabase si no se omitió
            if not skip_supabase:
                self.stdout.write(self.style.SUCCESS("Sincronizando con Supabase..."))
                try:
                    supabase_stats = sync_clients_to_supabase(clients_data)
                    self.stdout.write(self.style.SUCCESS(f"Sincronización con Supabase completada. Clientes sincronizados: {supabase_stats['successful']}"))
                except Exception as e:
                    self.stdout.write(self.style.ERROR(f"Error en la sincronización con Supabase: {str(e)}"))
                    logger.error(f"Error en la sincronización con Supabase: {str(e)}")
            
            end_time = datetime.now()
            duration = end_time - start_time
            self.stdout.write(self.style.SUCCESS(f"Sincronización completada en {duration}"))
            logger.info(f"Sincronización completada en {duration}")
            
        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error durante la sincronización: {str(e)}"))
            logger.error(f"Error durante la sincronización: {str(e)}")
    
    def _sync_clients_to_django(self, clients_data):
        """Sincroniza los clientes con la base de datos local de Django"""
        try:
            with transaction.atomic():
                # Contador para estadísticas
                created_count = 0
                updated_count = 0
                error_count = 0
                
                for client in clients_data:
                    try:
                        # Extraer los campos necesarios del cliente
                        partner_id = client.get('partner_id')
                        
                        if not partner_id:
                            logger.warning(f"Cliente sin partner_id: {client}")
                            error_count += 1
                            continue
                        
                        # Asegurarse de que partner_id sea un entero
                        try:
                            partner_id = int(partner_id)
                        except (ValueError, TypeError):
                            logger.warning(f"partner_id no es un entero válido: {partner_id}")
                            error_count += 1
                            continue
                        
                        name_partner = client.get('name_partner', '')
                        rfc = client.get('rfc', '')
                        
                        # Verificar si el cliente ya existe antes de usar update_or_create
                        try:
                            cliente = Cliente.objects.get(partner_id=partner_id)
                            # Actualizar campos
                            cliente.name_partner = name_partner
                            cliente.rfc = rfc
                            cliente.save()
                            updated_count += 1
                        except Cliente.DoesNotExist:
                            # Crear nuevo cliente
                            cliente = Cliente(
                                partner_id=partner_id,
                                name_partner=name_partner,
                                rfc=rfc
                            )
                            cliente.save()
                            created_count += 1
                            
                    except Exception as e:
                        logger.error(f"Error al procesar cliente {client.get('partner_id')}: {str(e)}")
                        error_count += 1
                
                self.stdout.write(self.style.SUCCESS(f"Clientes creados: {created_count}"))
                self.stdout.write(self.style.SUCCESS(f"Clientes actualizados: {updated_count}"))
                self.stdout.write(self.style.SUCCESS(f"Errores: {error_count}"))
                logger.info(f"Clientes creados: {created_count}")
                logger.info(f"Clientes actualizados: {updated_count}")
                logger.info(f"Errores: {error_count}")
                
        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error en la transacción: {str(e)}"))
            logger.error(f"Error en la transacción: {str(e)}")
            raise
```

## apps\cotizador\management\commands\sync_images_urls.py

- Characters: 9066
- Tokens: 0

```python
from django.core.management.base import BaseCommand
from supabase import create_client, Client
import os
import logging
from apps.cotizador.models import CotizadorImagenproducto

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Sincroniza las URLs de imágenes desde Supabase Storage a la tabla cotizador_imagenproducto.'

    def add_arguments(self, parser):
        parser.add_argument(
            '--recursive',
            action='store_true',
            dest='recursive',
            default=True,
            help='Buscar imágenes recursivamente en subcarpetas',
        )

    def handle(self, *args, **options):
        SUPABASE_URL = "https://wlwxbdlmrcgjzmnjovbm.supabase.co"
        SUPABASE_KEY = (
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indsd3hiZGxtcmNnanptbmpvdmJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczOTM4MjI1MSwiZXhwIjoyMDU0OTU4MjUxfQ.QgMuPGN3I3WDv5G7nYK5DR23eiyBZfbf_tn2ZjxhCa8"
        )
        BUCKET_NAME = "imagenes-productos"
        recursive = options['recursive']

        # Contadores para estadísticas
        total_archivos = 0
        actualizados = 0
        creados = 0
        ignorados = 0
        errores = 0

        try:
            supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)
            self.stdout.write(self.style.SUCCESS(f"Conexión exitosa a Supabase"))

            # Procesar carpetas y archivos
            self.stdout.write("Listando contenido del bucket...")
            self.procesar_carpeta(supabase, SUPABASE_URL, BUCKET_NAME, "", recursive, 
                                  total_archivos, actualizados, creados, ignorados, errores)

            # Mostrar resumen
            self.stdout.write(self.style.SUCCESS(
                f"\nSincronización completada:\n"
                f"- Total de archivos procesados: {total_archivos}\n"
                f"- Registros actualizados: {actualizados}\n"
                f"- Registros creados: {creados}\n"
                f"- Archivos ignorados: {ignorados}\n"
                f"- Errores: {errores}"
            ))

        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error al conectar con Supabase: {str(e)}"))
            logger.error(f"Error al conectar con Supabase: {str(e)}")

    def procesar_carpeta(self, supabase, supabase_url, bucket_name, ruta_actual, recursive, 
                         total_archivos, actualizados, creados, ignorados, errores):
        try:
            # Listar contenido de la carpeta actual con paginación
            self.stdout.write(f"Listando contenido de {ruta_actual or '[Raíz]'}...")
            contenido = self.listar_contenido_con_paginacion(supabase, bucket_name, ruta_actual)
            self.stdout.write(f"Total de elementos encontrados en {ruta_actual or '[Raíz]'}: {len(contenido)}")

            # Procesar cada elemento (archivo o carpeta)
            for item in contenido:
                nombre_item = item["name"]
                es_carpeta = item.get("id") is None
                
                # Construir la ruta completa para el elemento actual
                if ruta_actual:
                    ruta_completa = f"{ruta_actual}/{nombre_item}"
                else:
                    ruta_completa = nombre_item
                
                # Si es carpeta y recursive=True, procesarla recursivamente
                if es_carpeta and recursive:
                    self.procesar_carpeta(supabase, supabase_url, bucket_name, ruta_completa, 
                                          recursive, total_archivos, actualizados, creados, 
                                          ignorados, errores)
                # Si es archivo, procesarlo
                elif not es_carpeta:
                    self.procesar_archivo(supabase, supabase_url, bucket_name, ruta_actual, 
                                          nombre_item, total_archivos, actualizados, 
                                          creados, ignorados, errores)

        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error al procesar carpeta {ruta_actual}: {str(e)}"))
            logger.error("Error al procesar carpeta %s: %s" % (ruta_actual, str(e)))
            errores += 1

    def listar_contenido_con_paginacion(self, supabase, bucket_name, ruta_actual):
        """Lista todo el contenido de una carpeta con paginación para superar el límite de 100 elementos"""
        todos_los_items = []
        offset = 0
        limit = 1000  # Máximo número de elementos por solicitud
        
        while True:
            try:
                # Construir opciones de paginación
                options = {
                    "limit": limit,
                    "offset": offset,
                    "sortBy": {
                        "column": "name",
                        "order": "asc"
                    }
                }
                
                # Realizar la solicitud con opciones de paginación
                if ruta_actual:
                    contenido = supabase.storage.from_(bucket_name).list(path=ruta_actual, options=options)
                else:
                    contenido = supabase.storage.from_(bucket_name).list(options=options)
                
                # Si no hay más elementos, salir del bucle
                if not contenido or len(contenido) == 0:
                    break
                    
                # Agregar elementos a la lista completa
                todos_los_items.extend(contenido)
                
                # Si recibimos menos elementos que el límite, significa que hemos terminado
                if len(contenido) < limit:
                    break
                    
                # Incrementar el offset para la siguiente solicitud
                offset += limit
                
                # Informar del progreso
                self.stdout.write(f"  Obtenidos {len(todos_los_items)} elementos de {ruta_actual or '[Raíz]'}...")
                
            except Exception as e:
                self.stdout.write(self.style.ERROR(f"Error al listar contenido de {ruta_actual}: {str(e)}"))
                logger.error("Error al listar contenido de %s: %s" % (ruta_actual, str(e)))
                break
                
        return todos_los_items
            
    def procesar_archivo(self, supabase, supabase_url, bucket_name, ruta_carpeta, 
                         nombre_archivo, total_archivos, actualizados, creados, 
                         ignorados, errores):
        try:
            # Ignorar archivos placeholder
            if nombre_archivo == ".emptyFolderPlaceholder":
                ignorados += 1
                return

            total_archivos += 1
            
            # Construir la URL completa del archivo exactamente como se requiere
            # Formato: https://wlwxbdlmrcgjzmnjovbm.supabase.co/storage/v1/object/public/imagenes-productos/Almacenaje/GAA790180.png
            if ruta_carpeta:
                url = f"{supabase_url}/storage/v1/object/public/{bucket_name}/{ruta_carpeta}/{nombre_archivo}"
            else:
                url = f"{supabase_url}/storage/v1/object/public/{bucket_name}/{nombre_archivo}"
            
            # Extraer la clave_padre del nombre del archivo (sin extensión)
            # Usamos rsplit para manejar nombres con múltiples puntos, tomando solo la última extensión
            clave_padre = nombre_archivo.rsplit(".", 1)[0]
            
            self.stdout.write(f"Procesando: {nombre_archivo} en {ruta_carpeta if ruta_carpeta else 'raíz'}")
            self.stdout.write(f"  URL: {url}")
            self.stdout.write(f"  Clave padre: {clave_padre}")

            #Intentar primero una coincidencia exacta
            imagen = CotizadorImagenproducto.objects.filter(clave_padre__iexact=clave_padre).first()

            if not imagen:
                self.stdout.write(f"  No se encontró una coincidencia exacta para: {clave_padre}")
                imagen = CotizadorImagenproducto.objects.filter(clave_padre__icontains=clave_padre).first()
                if imagen:
                    self.stdout.write(f"  Coincidencia inexacta encontrada: {imagen.clave_padre}")
                    imagen.url = url
                    imagen.save()
                    self.stdout.write(f"  Actualizado registro existente para: {clave_padre}")
                    actualizados += 1
                else:
                    self.stdout.write(f"  No se encontro ninguna coincidencia para: {clave_padre}")
                    imagen = CotizadorImagenproducto(clave_padre=clave_padre, url=url)
                    imagen.save()
                    self.stdout.write(f"  Creado nuevo registro para: {clave_padre}")
                    creados += 1
        
        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error al procesar archivo {nombre_archivo}: {str(e)}"))
            logger.error("Error al procesar archivo %s: %s" % (nombre_archivo, str(e)))
            errores += 1
```

## apps\cotizador\management\commands\sync_products.py

- Characters: 16571
- Tokens: 0

```python
from django.core.management.base import BaseCommand
from django.db import connections, transaction
from apps.cotizador.models import ProductTemplate, ProductType, ProductFamily, ProductLine, ProductGroup
from datetime import datetime
import logging
from ...cache.sync import sync_products_to_supabase

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Sincroniza los productos desde la copia de Odoo a la base de datos local'

    def handle(self, *args, **options):
        start_time = datetime.now()
        logger.info(f"Iniciando sincronización de productos: {start_time}")
        
        try:
            # Conectar a la base de datos de Odoo
            with connections['erp-portalgebesa-com'].cursor() as odoo_cursor:
                # Obtener productos de Odoo
                odoo_cursor.execute("""
                    SELECT 
                        pt.id,
                        pt.name,
                        pt.reference_mask,
                        pt.note_pricelist,  
                        pt.type_id,
                        pt.family_id,
                        pt.line_id,
                        pt.group_id,
                        pt.is_line,
                        pt.pricelist,
                        pt.active,
                        -- Nueva columna "code"
                        COALESCE(pt.reference_mask, pt.note_pricelist) AS code,
                        -- Información adicional de las tablas relacionadas
                        ptype.name   AS type_name,
                        pfam.name    AS family_name,
                        pline.name   AS line_name,
                        pgroup.name  AS group_name,
                        -- Nueva columna con la traducción en español
                        it.value AS name_spanish
                    FROM product_template pt
                        LEFT JOIN product_type ptype 
                            ON pt.type_id = ptype.id
                        LEFT JOIN product_family pfam 
                            ON pt.family_id = pfam.id
                        LEFT JOIN product_line pline 
                            ON pt.line_id = pline.id
                        LEFT JOIN product_group pgroup 
                            ON pt.group_id = pgroup.id
                        -- Agrega la unión con ir_translation para obtener la traducción en español
                        LEFT JOIN ir_translation it 
                            ON it.res_id = pt.id
                               AND it.name = 'product.template,name'
                               AND it.lang = 'es_MX'
                    WHERE 
                        pt.is_line = TRUE
                        AND pt.active = TRUE
                        AND (
                            (
                                pt.reference_mask IS NOT NULL
                                AND pt.reference_mask NOT IN (
                                    'LLR1SCANT', 'LLR1SCANTWM', 'LLRBLAPMBBFLPF162329NT', 
                                    'LLRBLAPMFFLPF162329NT', 'LLRBLAPMSBBFLPF162329NT', 
                                    'LLRBLAPMSFFLPF162329NT', 'LLRBPMBBFLPF162329NT', 
                                    'LLRBPMFFLPF162329NT', 'LLRBPMSBBFLPF162329NT', 
                                    'LLRBPMSFFLPF162329NT', 'LLRBWSLP242442', 'LLRBWSLP302442', 
                                    'LLRBWSRELP242442', 'LLRBWSRELP302442', 'LLRBWSSLP2460', 
                                    'LLRBWSSLP2465', 'LLRBWSSLP2472', 'LLRBWSSLP3060', 
                                    'LLRBWSSLP3065', 'LLRBWSSLP3072', 'LLRC1DLP602024', 
                                    'LLRC1DLP712024', 'LLRCANTSS', 'LLRCANTSSWM', 'LLRCC2720', 
                                    'LLRCOUNTBR', 'LLRCRBRKIT', 'LLRCWSSLP363624', 'LLRCWSSLP423624', 
                                    'LLRCWSSLP424224', 'LLRCWSSLP424230', 'LLRCWSSLP483624', 
                                    'LLRCWSSLP484224', 'LLRCWSSLP484230', 'LLRCWSSLP484824', 
                                    'LLRCWSSLP484830', 'LLRCWSSLP603624', 'LLRCWSSLP604224', 
                                    'LLRCWSSLP604230', 'LLRCWSSLP604824', 'LLRCWSSLP604830', 
                                    'LLREHWSLP367224', 'LLREHWSLP367230', 'LLREIWSLP2460', 
                                    'LLREIWSLP2472', 'LLREIWSLP3072', 'LLREL01525MPS120', 
                                    'LLREL01525MPS72', 'LLREL01525S120', 'LLREL01525S72', 
                                    'LLREL0153611SMAM172', 'LLREL0153611SMBM172', 
                                    'LLREL0153611SMCM172', 'LLREL0153620SMA72', 
                                    'LLREL0153620SMB72', 'LLREL0153620SMC72', 'LLREL0181922E120', 
                                    'LLREL0181922E72', 'LLREL01820M22120', 'LLREL01820M2272', 
                                    'LLREL01820M22D172', 'LLREL01820M2X22120', 'LLREL01820M2X2272', 
                                    'LLREL01820M2X22U5/U5120', 'LLREL01820M2X22U5/U572', 
                                    'LLREL01820M2X40120', 'LLREL01820M2X4072', 
                                    'LLREL01826M3X4002120', 'LLREL01826M3X400272', 
                                    'LLREL01826M4X4001120', 'LLREL01826M4X400172', 'LLREL02137C1172', 
                                    'LLREL02137C2072', 'LLREL0251122120', 'LLREL025112272', 
                                    'LLREL0251133120', 'LLREL025113372', 'LLREL02511B22U572', 
                                    'LLREL02511B31U172', 'LLREL02511B33U3172', 'LLREL02511B4072', 
                                    'LLREL0252022XA120', 'LLREL0252022XA72', 'LLREL0252022YA120', 
                                    'LLREL0252022YA72', 'LLREL0252022Z120', 'LLREL0252022Z72', 
                                    'LLREL0252033XA120', 'LLREL0252033XA72', 'LLREL0252033YA120', 
                                    'LLREL0252033YA72', 'LLREL0252033Z120', 'LLREL0252033Z72', 
                                    'LLREL0335911120', 'LLREL033591172', 'LLREL0335911M1120', 
                                    'LLREL0335911M172', 'LLREL0335920120', 'LLREL033592072', 
                                    'LLREL03373EN22120', 'LLREL03373EN2272', 'LLREL03373EN22M2120', 
                                    'LLREL03373EN22M272', 'LLREL03373GN22M1120', 
                                    'LLREL03373GN22M172', 'LLREL03373GN31M1120', 
                                    'LLREL03373GN31M172', 'LLREL03373TT40120', 'LLREL03373TT4072', 
                                    'LLREL03378GN22120', 'LLREL03378GN2272', 'LLREL03378GN22M1120', 
                                    'LLREL03378GN22M172', 'LLREL03378GN22M2120', 
                                    'LLREL03378GN22M272', 'LLREL03378GN31120', 'LLREL03378GN3172', 
                                    'LLREL03378GN31M1120', 'LLREL03378GN31M172', 'LLREL03378GN40120', 
                                    'LLREL03378GN4072', 'LLREL03378TT22MMT120', 'LLREL03378TT22MMT72', 
                                    'LLREL03378TT40120', 'LLREL03378TT4072', 'LLREL0338522120', 
                                    'LLREL033852272', 'LLREL0338522M1120', 'LLREL0338522M172', 
                                    'LLREL0338522M2120', 'LLREL0338522M272', 'LLREL0338531120', 
                                    'LLREL033853172', 'LLREL0338531M1120', 'LLREL0338531M172', 
                                    'LLREL0338540120', 'LLREL033854072', 'LLREL0377021MR1120', 
                                    'LLREL0377021MR172', 'LLREL0377030120', 'LLREL037703072', 
                                    'LLREL0381621MR1120', 'LLREL0381621MR172', 'LLREL0381630120', 
                                    'LLREL038163072', 'LLREL0407311AMR172', 'LLREL0407320A72', 
                                    'LLREL0407321AMR172', 'LLREL0407330A72', 'LLREL0407332AMR272', 
                                    'LLREL0407350A72', 'LLREL0407611UB172', 'LLREL040762072', 
                                    'LLREL0407621UB172', 'LLREL040763072', 'LLREL0407632UB272', 
                                    'LLREL040765072', 'LLREL04262A11UB148', 'LLREL04262A11UB160', 
                                    'LLREL04262S11UB1120', 'LLREL04262S11UB172', 'LLREL0428611M1120', 
                                    'LLREL0428611M172', 'LLREL0428620120', 'LLREL042862072', 
                                    'LLREL0431511AA120', 'LLREL0431511AA72', 'LLREL0431511AZ120', 
                                    'LLREL0431511AZ72', 'LLREL0431520A120', 'LLREL0431520A72', 
                                    'LLREL0431520Z120', 'LLREL0431520Z72', 'LLREL0431521AA120', 
                                    'LLREL0431521AA72', 'LLREL0431521AZ120', 'LLREL0431521AZ72', 
                                    'LLREL0431530A120', 'LLREL0431530A72', 'LLREL0431530Z72', 
                                    'LLREL0431532AA120', 'LLREL0431532AA72', 'LLREL0431532AZ120', 
                                    'LLREL0431532AZ72', 'LLREL0431550A120', 'LLREL0431550A72', 
                                    'LLREL0431550Z120', 'LLREL0431550Z72', 'LLREL0475572', 
                                    'LLREL0475672', 'LLREL0481431U172', 'LLREL05451A110', 
                                    'LLREL05451A111', 'LLREL05451A112', 'LLREL05451A113', 
                                    'LLREL05451A114', 'LLREL05451A115', 'LLREL05451A116', 
                                    'LLREL05451A117', 'LLREL0806232', 'LLREL0806832', 'LLREL080863', 
                                    'LLREL080923', 'LLREL081803', 'LLREL420813', 'LLREL420823', 
                                    'LLREL5241332', 'LLREL524263C', 'LLREL524263G', 'LLREL524633', 
                                    'LLREL524903', 'LLREPTWSLP367224', 'LLREPTWSLP367230', 
                                    'LLREPWSLP367224', 'LLREPWSLP367230', 'LLREWSCCLP363624', 
                                    'LLREWSCCLP423624', 'LLREWSCCLP424224', 'LLREWSCCLP424230', 
                                    'LLREWSCCLP483624', 'LLREWSCCLP484224', 'LLREWSCCLP484230', 
                                    'LLREWSCCLP484824', 'LLREWSCCLP484830', 'LLREWSCCLP603624', 
                                    'LLREWSCCLP604224', 'LLREWSCCLP604230', 'LLREWSCCLP604824', 
                                    'LLREWSCCLP604830', 'LLREWSLP2424', 'LLREWSLP2430', 
                                    'LLREWSLP2436', 'LLREWSLP2442', 'LLREWSLP2448', 'LLREWSLP3024', 
                                    'LLREWSLP3030', 'LLREWSLP3036', 'LLREWSLP3042', 'LLREWSLP3048'
                                )
                            )
                            OR (pt.reference_mask IS NULL AND pt.pricelist = TRUE)
                        )
                """)
                
                products = odoo_cursor.fetchall()
                
                # Obtener los nombres de las columnas
                columns = [desc[0] for desc in odoo_cursor.description]
                
                # Convertir a diccionarios
                products_data = [dict(zip(columns, product)) for product in products]
                
            # Actualizar la base de datos local en una transacción
            with transaction.atomic():
                # Ya no desactivamos todos los productos, solo actualizamos los que recibimos
                # ProductTemplate.objects.all().update(active=False)
                
                # Lista para registrar productos actualizados
                updated_product_ids = []
                
                # Actualizar o crear productos
                for product in products_data:
                    # Usar name_spanish como name si está disponible, de lo contrario usar name
                    product_name = product.get('name_spanish') if product.get('name_spanish') else product['name']
                    
                    # Usar code como reference_mask
                    reference_mask = product.get('code') or product.get('reference_mask')
                    
                    # Registrar información sobre la traducción y el código
                    if product.get('name_spanish') and product.get('name_spanish') != product['name']:
                        logger.info(f"Usando traducción para ID {product['id']}: '{product['name']}' -> '{product_name}'")
                    
                    if product.get('code') and product.get('code') != product.get('reference_mask'):
                        logger.info(f"Usando código combinado para ID {product['id']}: '{product.get('reference_mask')}' -> '{reference_mask}'")
                    
                    # Verificar si el producto ya existe
                    try:
                        existing_product = ProductTemplate.objects.get(id=product['id'])
                        
                        # Actualizar solo los campos específicos que vienen de Odoo
                        existing_product.name = product_name
                        existing_product.reference_mask = reference_mask
                        existing_product.note_pricelist = product.get('note_pricelist')
                        existing_product.type_id = product['type_id']
                        existing_product.family_id = product['family_id']
                        existing_product.line_id = product['line_id']
                        existing_product.group_id = product['group_id']
                        existing_product.is_line = product['is_line']
                        existing_product.pricelist = product.get('pricelist', False)
                        existing_product.active = product['active']
                        
                        # Guardar los cambios (esto preservará otros campos como URLs de imágenes)
                        existing_product.save()
                        logger.info(f"Producto actualizado: ID {product['id']} - {product_name}")
                    except ProductTemplate.DoesNotExist:
                        # Si el producto no existe, crearlo
                        ProductTemplate.objects.create(
                            id=product['id'],
                            name=product_name,
                            reference_mask=reference_mask,
                            note_pricelist=product.get('note_pricelist'),
                            type_id=product['type_id'],
                            family_id=product['family_id'],
                            line_id=product['line_id'],
                            group_id=product['group_id'],
                            is_line=product['is_line'],
                            pricelist=product.get('pricelist', False),
                            active=product['active'],
                        )
                        logger.info(f"Producto creado: ID {product['id']} - {product_name}")
                    
                    # Registrar este ID como actualizado
                    updated_product_ids.append(product['id'])
                
                # Registrar estadísticas
                total_products = len(products_data)
                active_products = sum(1 for p in products_data if p['active'])
                spanish_names = sum(1 for p in products_data if p.get('name_spanish') and p.get('name_spanish') != p['name'])
                combined_codes = sum(1 for p in products_data if p.get('code') and p.get('code') != p.get('reference_mask'))
                
            end_time = datetime.now()
            duration = end_time - start_time
            
            logger.info(f"Sincronización completada en {duration}")
            logger.info(f"Total de productos: {total_products}")
            logger.info(f"Productos activos: {active_products}")
            logger.info(f"Productos con nombre en español: {spanish_names}")
            logger.info(f"Productos con código combinado: {combined_codes}")
            
            self.stdout.write(
                self.style.SUCCESS(
                    f'Sincronización exitosa. {total_products} productos actualizados en {duration}\n'
                    f'- {active_products} productos activos\n'
                    f'- {spanish_names} productos con nombre en español\n'
                    f'- {combined_codes} productos con código combinado'
                )
            )
            
        except Exception as e:
            logger.error(f"Error durante la sincronización: {str(e)}")
            self.stdout.write(
                self.style.ERROR(f'Error durante la sincronización: {str(e)}')
            )
            raise
```

## apps\cotizador\management\commands\sync_products_cache_images.py

- Characters: 7156
- Tokens: 0

```python
from django.core.management.base import BaseCommand
from apps.cotizador.models import CotizadorImagenproducto
from apps.cotizador.cache.models import ProductsCache
from django.db.models import F
from django.utils import timezone
import logging
import requests
from django.db import transaction
from tqdm import tqdm
import time

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Sincroniza las URLs de las imágenes con la tabla products_cache'

    def add_arguments(self, parser):
        parser.add_argument(
            '--batch-size',
            type=int,
            default=100,
            help='Tamaño del lote para procesar productos',
        )
        parser.add_argument(
            '--validate-urls',
            action='store_true',
            dest='validate_urls',
            default=False,
            help='Validar que las URLs sean accesibles',
        )
        parser.add_argument(
            '--force-update',
            action='store_true',
            dest='force_update',
            default=False,
            help='Forzar actualización incluso si la URL no ha cambiado',
        )

    def handle(self, *args, **options):
        batch_size = options['batch_size']
        validate_urls = options['validate_urls']
        force_update = options['force_update']

        # Contadores para estadísticas
        total_productos = 0
        total_actualizados = 0
        total_sin_cambios = 0
        total_errores = 0
        total_sin_imagen = 0

        try:
            # Obtener todos los productos en cache
            productos = ProductsCache.objects.all()
            total_productos = productos.count()
            self.stdout.write(f"Total de productos en cache: {total_productos}")

            # Procesar productos en lotes para mejor rendimiento
            offset = 0
            with tqdm(total=total_productos, desc="Sincronizando productos") as pbar:
                while offset < total_productos:
                    # Obtener lote actual
                    lote_productos = productos[offset:offset+batch_size]
                    
                    # Procesar cada producto en el lote
                    for producto in lote_productos:
                        try:
                            # Buscar imagen correspondiente al código del producto
                            imagen = CotizadorImagenproducto.objects.filter(clave_padre__iexact=producto.reference_mask).first()
                            if not imagen:
                                imagen = CotizadorImagenproducto.objects.filter(clave_padre__icontains=producto.reference_mask).first()
                            
                            if imagen:
                                url_anterior = producto.image_url or ""
                                nueva_url = imagen.url
                                
                                # Validar URL si se solicitó
                                url_valida = True
                                if validate_urls and nueva_url:
                                    try:
                                        response = requests.head(nueva_url, timeout=5)
                                        url_valida = response.status_code == 200
                                        if not url_valida:
                                            self.stdout.write(self.style.WARNING(
                                                f"URL no válida para {producto.reference_mask}: {nueva_url} "
                                                f"(Status: {response.status_code})"
                                            ))
                                    except Exception as e:
                                        url_valida = False
                                        self.stdout.write(self.style.WARNING(
                                            f"Error al validar URL para {producto.reference_mask}: {str(e)}"
                                        ))
                                
                                # Actualizar URL si ha cambiado o si se fuerza la actualización
                                if url_valida and (force_update or url_anterior != nueva_url):
                                    # Guardar URL anterior para registro
                                    url_anterior_log = url_anterior if url_anterior else "[Sin URL]"
                                    
                                    # Actualizar producto
                                    producto.image_url = nueva_url
                                    producto.save(update_fields=['image_url'])
                                    
                                    total_actualizados += 1
                                    self.stdout.write(
                                        f"Actualizado: {producto.reference_mask} - "
                                        f"URL anterior: {url_anterior_log} -> "
                                        f"Nueva URL: {nueva_url}"
                                    )
                                else:
                                    total_sin_cambios += 1
                            else:
                                total_sin_imagen += 1
                                if producto.image_url:  # Si tenía URL pero ya no hay imagen
                                    self.stdout.write(self.style.WARNING(
                                        f"Producto sin imagen pero con URL: {producto.reference_mask} - {producto.image_url}"
                                    ))
                                    # Opcionalmente, se podría limpiar la URL aquí
                                    # producto.image_url = None
                                    # producto.save(update_fields=['image_url'])
                        except Exception as e:
                            total_errores += 1
                            self.stdout.write(self.style.ERROR(
                                f"Error al procesar producto {producto.reference_mask}: {str(e)}"
                            ))
                            logger.error(f"Error al procesar producto {producto.reference_mask}: {str(e)}")
                    
                    # Actualizar offset y barra de progreso
                    offset += batch_size
                    pbar.update(len(lote_productos))
                    
                    # Pequeña pausa para no sobrecargar la base de datos
                    time.sleep(0.01)

            # Mostrar estadísticas finales
            self.stdout.write(self.style.SUCCESS(f"\nSincronización completada:"))
            self.stdout.write(f"- Total de productos procesados: {total_productos}")
            self.stdout.write(f"- Productos actualizados: {total_actualizados}")
            self.stdout.write(f"- Productos sin cambios: {total_sin_cambios}")
            self.stdout.write(f"- Productos sin imagen: {total_sin_imagen}")
            self.stdout.write(f"- Errores: {total_errores}")

        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error general: {str(e)}"))
            logger.error(f"Error general: {str(e)}")
```

## apps\cotizador\management\commands\sync_products_new.py

- Characters: 2036
- Tokens: 0

```python
from django.core.management.base import BaseCommand
from django.db import connections
from datetime import datetime
import logging
from ...cache.sync import sync_products_to_supabase

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Sincroniza los productos desde la copia de Odoo directamente a Supabase'

    def handle(self, *args, **options):
        start_time = datetime.now()
        logger.info(f"Iniciando sincronización de productos con Supabase: {start_time}")
        
        try:
            # Llamar directamente a la función de sincronización con Supabase
            self.stdout.write("Iniciando sincronización de productos con Supabase...")
            result = sync_products_to_supabase()
            
            end_time = datetime.now()
            duration = end_time - start_time
            
            logger.info(f"Sincronización completada en {duration}")
            logger.info(f"Total de productos: {result.get('total', 0)}")
            logger.info(f"Productos sincronizados: {result.get('successful', 0)}")
            logger.info(f"Productos con imágenes: {result.get('with_images', 0)}")
            logger.info(f"Productos sin imágenes: {result.get('without_images', 0)}")
            
            self.stdout.write(
                self.style.SUCCESS(
                    f'Sincronización exitosa con Supabase:\n'
                    f'- Total de productos: {result.get("total", 0)}\n'
                    f'- Productos sincronizados: {result.get("successful", 0)}\n'
                    f'- Productos con imágenes: {result.get("with_images", 0)}\n'
                    f'- Productos sin imágenes: {result.get("without_images", 0)}\n'
                    f'- Duración: {duration}'
                )
            )
            
        except Exception as e:
            logger.error(f"Error durante la sincronización: {str(e)}")
            self.stdout.write(
                self.style.ERROR(f'Error durante la sincronización: {str(e)}')
            )
            raise
```

## apps\cotizador\management\commands\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\cotizador\management\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\cotizador\middleware\cache_middleware.py

- Characters: 2070
- Tokens: 0

```python
from django.core.cache import cache
from django.conf import settings
from django.utils.deprecation import MiddlewareMixin
import hashlib
import json

class QueryCacheMiddleware(MiddlewareMixin):
    """
    Middleware to cache expensive database queries.
    """
    def process_request(self, request):
        # Only cache GET requests
        if request.method != 'GET':
            return None

        # Generate cache key based on full URL and query parameters
        cache_key = self._generate_cache_key(request)
        cached_response = cache.get(cache_key)

        if cached_response is not None:
            return cached_response

        return None

    def process_response(self, request, response):
        if request.method != 'GET':
            return response

        # Only cache 200 OK responses
        if response.status_code != 200:
            return response

        # Generate cache key
        cache_key = self._generate_cache_key(request)

        # Cache the response for CACHE_TTL seconds
        cache.set(cache_key, response, settings.CACHE_TTL)

        return response

    def _generate_cache_key(self, request):
        """Generate a unique cache key based on the request."""
        # Get the full path including query parameters
        full_path = request.get_full_path()
        
        # Add user info to make cache user-specific if needed
        if request.user.is_authenticated:
            user_id = str(request.user.id)
        else:
            user_id = 'anonymous'

        # Create a unique key
        key_parts = [
            settings.CACHE_KEY_PREFIX,
            full_path,
            user_id,
        ]

        # Add request body for POST requests
        if request.method == 'POST':
            try:
                body = json.loads(request.body)
                key_parts.append(json.dumps(body, sort_keys=True))
            except:
                pass

        # Create a hash of all parts
        key = hashlib.md5(''.join(key_parts).encode()).hexdigest()
        
        return f'query_cache:{key}'
```

## apps\cotizador\middleware\query_middleware.py

- Characters: 1166
- Tokens: 0

```python
import time
import logging
from django.conf import settings
from django.db import connection
from django.utils.deprecation import MiddlewareMixin

logger = logging.getLogger(__name__)

class QueryTimeMiddleware(MiddlewareMixin):
    """
    Middleware to log database query execution time.
    Only active when DEBUG is True.
    """
    def process_request(self, request):
        if settings.DEBUG:
            request.start_time = time.time()

    def process_response(self, request, response):
        if settings.DEBUG and hasattr(request, 'start_time'):
            total_time = time.time() - request.start_time
            # Log queries that take more than 0.5 seconds
            if total_time > 0.5:
                for query in connection.queries:
                    if float(query['time']) > 0.5:
                        logger.warning(
                            f"Slow query detected ({query['time']}s): {query['sql']}"
                        )
                logger.info(
                    f"Request to {request.path} took {total_time:.2f}s "
                    f"with {len(connection.queries)} queries"
                )
        return response
```

## apps\cotizador\middleware\__init__.py

- Characters: 49
- Tokens: 0

```python
"""
Middleware package for the cotizador app.
"""
```

## apps\cotizador\middleware.py

- Characters: 1582
- Tokens: 0

```python
import time
from django.db import connection
from django.conf import settings
import logging

logger = logging.getLogger(__name__)

class QueryTimeMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # Código que se ejecuta antes de la vista
        start_time = time.time()
        initial_queries = len(connection.queries)

        response = self.get_response(request)

        # Código que se ejecuta después de la vista
        end_time = time.time()
        final_queries = len(connection.queries)

        # Solo registrar si DEBUG está activado
        if settings.DEBUG:
            total_time = end_time - start_time
            total_queries = final_queries - initial_queries

            # Registrar consultas que toman más de 0.5 segundos
            slow_queries = [
                {
                    'sql': q['sql'],
                    'time': float(q['time']),
                }
                for q in connection.queries[initial_queries:final_queries]
                if float(q['time']) > 0.5
            ]

            if slow_queries:
                logger.warning(
                    f"\nRequest: {request.path}\n"
                    f"Total time: {total_time:.2f}s\n"
                    f"Total queries: {total_queries}\n"
                    f"Slow queries:\n"
                    + "\n".join(
                        f"Time: {q['time']}s\nSQL: {q['sql']}\n"
                        for q in slow_queries
                    )
                )

        return response
```

## apps\cotizador\migrations\0001_initial.py

- Characters: 15116
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-20 22:19

import django.core.validators
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='ProductFamily',
            fields=[
                ('id', models.AutoField(primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=255)),
            ],
            options={
                'db_table': 'product_family',
                'managed': False,
            },
        ),
        migrations.CreateModel(
            name='ProductGroup',
            fields=[
                ('id', models.AutoField(primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=255)),
            ],
            options={
                'db_table': 'product_group',
                'managed': False,
            },
        ),
        migrations.CreateModel(
            name='ProductLine',
            fields=[
                ('id', models.AutoField(primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=255)),
            ],
            options={
                'db_table': 'product_line',
                'managed': False,
            },
        ),
        migrations.CreateModel(
            name='ProductTemplate',
            fields=[
                ('id', models.AutoField(primary_key=True, serialize=False)),
                ('name', models.CharField(db_index=True, max_length=255)),
                ('reference_mask', models.CharField(db_index=True, max_length=255, null=True)),
                ('is_line', models.BooleanField(db_index=True, default=True)),
                ('active', models.BooleanField(db_index=True, default=True)),
            ],
            options={
                'db_table': 'product_template',
                'managed': False,
            },
        ),
        migrations.CreateModel(
            name='ProductType',
            fields=[
                ('id', models.AutoField(primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=255)),
            ],
            options={
                'db_table': 'product_type',
                'managed': False,
            },
        ),
        migrations.CreateModel(
            name='Cliente',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(max_length=200)),
                ('email', models.EmailField(max_length=254)),
                ('telefono', models.CharField(max_length=15)),
                ('empresa', models.CharField(blank=True, max_length=200, null=True)),
                ('direccion', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='Fecha de Creación')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='Fecha de Actualización')),
            ],
        ),
        migrations.CreateModel(
            name='Producto',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(max_length=255)),
                ('codigo_producto', models.CharField(blank=True, max_length=64, null=True, unique=True)),
                ('precio_base', models.DecimalField(decimal_places=2, max_digits=10)),
                ('descripcion', models.TextField(blank=True, null=True)),
                ('activo', models.BooleanField(default=True)),
            ],
        ),
        migrations.CreateModel(
            name='Cotizacion',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('folio_cotizacion', models.CharField(blank=True, help_text='Folio único de la cotización en formato COT-YYYY-XXXX (ej: COT-2025-0001)', max_length=15, null=True, unique=True)),
                ('estado', models.CharField(choices=[('borrador', 'Borrador'), ('en_revision', 'En Revisión'), ('aprobado', 'Aprobado'), ('cancelado', 'Cancelado')], default='borrador', max_length=20)),
                ('cliente', models.CharField(help_text='Nombre del cliente', max_length=255)),
                ('razon_social', models.CharField(blank=True, help_text='Razón social del cliente', max_length=255, null=True)),
                ('rfc', models.CharField(blank=True, help_text='RFC del cliente', max_length=13, null=True)),
                ('email_cliente', models.EmailField(blank=True, help_text='Email del cliente', max_length=255, null=True)),
                ('telefono_cliente', models.CharField(blank=True, help_text='Teléfono del cliente', max_length=20, null=True)),
                ('direccion_fiscal_calle', models.CharField(blank=True, help_text='Calle de la dirección fiscal', max_length=255, null=True)),
                ('direccion_fiscal_numero', models.CharField(blank=True, help_text='Número exterior de la dirección fiscal', max_length=20, null=True)),
                ('direccion_fiscal_colonia', models.CharField(blank=True, help_text='Colonia de la dirección fiscal', max_length=255, null=True)),
                ('direccion_fiscal_cp', models.CharField(blank=True, help_text='Código postal de la dirección fiscal', max_length=5, null=True)),
                ('direccion_fiscal_ciudad', models.CharField(blank=True, help_text='Ciudad de la dirección fiscal', max_length=255, null=True)),
                ('direccion_fiscal_estado', models.CharField(blank=True, help_text='Estado de la dirección fiscal', max_length=255, null=True)),
                ('proyecto', models.CharField(blank=True, help_text='Nombre del proyecto', max_length=255, null=True)),
                ('atencion_a', models.CharField(blank=True, help_text='Persona a quien va dirigida la cotización', max_length=255, null=True)),
                ('email_representante', models.EmailField(blank=True, help_text='Email del representante de ventas', max_length=255, null=True)),
                ('telefono_representante', models.CharField(blank=True, help_text='Teléfono del representante de ventas', max_length=20, null=True)),
                ('codigo_vendedor', models.CharField(blank=True, help_text='Código identificador del vendedor', max_length=20, null=True)),
                ('proyectista', models.CharField(blank=True, help_text='Nombre del proyectista', max_length=255, null=True)),
                ('unidad_facturacion', models.CharField(choices=[('GEBESA_NACIONAL', 'GEBESA NACIONAL'), ('SALMON_LAGUNA', 'SALMÓN DE LA LAGUNA'), ('OPERADORA_SUCURSALES', 'OPERADORA DE SUCURSALES GEBESA'), ('GEBESA_METROPOLI', 'GEBESA METRÓPOLI')], max_length=50)),
                ('moneda', models.CharField(choices=[('MXN', 'Peso Mexicano'), ('USD', 'Dólar Americano')], default='MXN', max_length=3)),
                ('tipo_cambio', models.DecimalField(decimal_places=4, default=1.0, max_digits=10)),
                ('vigencia_dias', models.IntegerField(default=30, help_text='Días de vigencia de la cotización')),
                ('condiciones_pago', models.CharField(default='Contado', max_length=255)),
                ('tiempo_entrega', models.CharField(default='20 días hábiles', max_length=255)),
                ('lugar_entrega', models.CharField(default='Planta Cliente', max_length=255)),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='Fecha de Creación')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='Fecha de Actualización')),
                ('version', models.IntegerField(default=1, help_text='Versión de la cotización')),
                ('requiere_autorizacion', models.BooleanField(default=False)),
                ('motivo_autorizacion', models.TextField(blank=True, null=True)),
                ('comentarios_internos', models.TextField(blank=True, null=True)),
                ('approved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='cotizaciones_aprobadas', to=settings.AUTH_USER_MODEL, verbose_name='Aprobado por')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='cotizaciones_creadas', to=settings.AUTH_USER_MODEL, verbose_name='Creado por')),
                ('ejecutivo_ventas', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='cotizaciones_vendedor', to=settings.AUTH_USER_MODEL, verbose_name='Ejecutivo de ventas')),
                ('modified_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='cotizaciones_modificadas', to=settings.AUTH_USER_MODEL, verbose_name='Modificado por')),
            ],
            options={
                'verbose_name': 'Cotización',
                'verbose_name_plural': 'Cotizaciones',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='Bundle',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(help_text='Nombre descriptivo del bundle', max_length=255)),
                ('descripcion', models.TextField(blank=True, help_text='Descripción detallada del bundle y los productos que incluye', null=True)),
                ('descuento_bundle', models.DecimalField(decimal_places=2, default=0, help_text='Porcentaje de descuento aplicado a todo el bundle (0-100)', max_digits=5)),
                ('activo', models.BooleanField(default=True, help_text='Indica si el bundle está activo')),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='Fecha de Creación')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='Fecha de Actualización')),
                ('cotizacion', models.ForeignKey(blank=True, help_text='Cotización a la que pertenece este bundle', null=True, on_delete=django.db.models.deletion.CASCADE, related_name='bundles', to='cotizador.cotizacion')),
            ],
            options={
                'verbose_name': 'Bundle de Productos',
                'verbose_name_plural': 'Bundles de Productos',
                'db_table': 'cotizador_bundle',
                'managed': True,
            },
        ),
        migrations.CreateModel(
            name='CotizadorImagenproducto',
            fields=[
                ('id', models.BigAutoField(primary_key=True, serialize=False)),
                ('clave_padre', models.CharField(db_index=True, help_text='Clave del producto que coincide con reference_mask de ProductTemplate', max_length=50)),
                ('url', models.CharField(help_text='URL de la imagen en Supabase Storage', max_length=2048)),
            ],
            options={
                'verbose_name': 'Imagen de Producto',
                'verbose_name_plural': 'Imágenes de Productos',
                'db_table': 'cotizador_imagenproducto',
                'managed': True,
                'indexes': [models.Index(fields=['clave_padre'], name='idx_clave_padre'), models.Index(fields=['clave_padre', 'url'], name='idx_clave_url')],
            },
        ),
        migrations.CreateModel(
            name='DetalleCotizacion',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre_producto', models.CharField(max_length=255, verbose_name='Nombre del Producto')),
                ('descripcion', models.TextField(blank=True, null=True, verbose_name='Descripción')),
                ('cantidad', models.IntegerField(default=1, verbose_name='Cantidad')),
                ('precio_unitario', models.DecimalField(decimal_places=2, default=0, max_digits=10, verbose_name='Precio Unitario')),
                ('descuento', models.DecimalField(decimal_places=2, default=0, max_digits=5, validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(100)], verbose_name='Descuento (%)')),
                ('tipo_producto', models.CharField(choices=[('producto', 'Producto'), ('servicio', 'Servicio')], default='producto', max_length=50, verbose_name='Tipo de Producto')),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='Fecha de Creación')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='Fecha de Actualización')),
                ('cotizacion', models.ForeignKey(blank=True, db_column='cotizacion_id', null=True, on_delete=django.db.models.deletion.CASCADE, to='cotizador.cotizacion', verbose_name='Cotización')),
            ],
            options={
                'verbose_name': 'Detalle de Cotización',
                'verbose_name_plural': 'Detalles de Cotización',
                'db_table': 'cotizador_detallecotizacion',
                'ordering': ['created_at'],
                'managed': True,
            },
        ),
        migrations.CreateModel(
            name='ProductoBundle',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre_producto', models.CharField(help_text='Nombre del producto al momento de agregarlo al bundle', max_length=255)),
                ('cantidad', models.IntegerField(default=1, help_text='Número de unidades de este producto en el bundle')),
                ('precio_unitario', models.DecimalField(decimal_places=2, help_text='Precio por unidad del producto al momento de agregarlo al bundle', max_digits=10)),
                ('descuento', models.DecimalField(decimal_places=2, default=0, help_text='Porcentaje de descuento individual para este producto (0-100)', max_digits=5)),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='Fecha de Creación')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='Fecha de Actualización')),
                ('bundle', models.ForeignKey(help_text='Bundle al que pertenece este producto', on_delete=django.db.models.deletion.CASCADE, related_name='productos_bundle', to='cotizador.bundle')),
                ('producto', models.ForeignKey(blank=True, help_text='Producto del catálogo. Puede ser nulo si el producto se elimina', null=True, on_delete=django.db.models.deletion.SET_NULL, to='cotizador.producto')),
            ],
            options={
                'verbose_name': 'Producto de Bundle',
                'verbose_name_plural': 'Productos de Bundle',
                'db_table': 'cotizador_productobundle',
                'managed': True,
            },
        ),
    ]
```

## apps\cotizador\migrations\0002_remove_productobundle_bundle_and_more.py

- Characters: 11262
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-20 22:49

import django.core.validators
import django.db.models.deletion
import django.utils.timezone
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0001_initial'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='productobundle',
            name='bundle',
        ),
        migrations.RemoveField(
            model_name='detallecotizacion',
            name='cotizacion',
        ),
        migrations.RemoveField(
            model_name='productobundle',
            name='producto',
        ),
        migrations.AlterModelOptions(
            name='cotizacion',
            options={},
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='approved_by',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='atencion_a',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='codigo_vendedor',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='comentarios_internos',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='condiciones_pago',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='created_at',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='created_by',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='direccion_fiscal_calle',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='direccion_fiscal_ciudad',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='direccion_fiscal_colonia',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='direccion_fiscal_cp',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='direccion_fiscal_estado',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='direccion_fiscal_numero',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='ejecutivo_ventas',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='email_representante',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='estado',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='folio_cotizacion',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='lugar_entrega',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='modified_by',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='moneda',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='motivo_autorizacion',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='razon_social',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='requiere_autorizacion',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='rfc',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='telefono_representante',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='tiempo_entrega',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='tipo_cambio',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='updated_at',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='vigencia_dias',
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='email_vendedor',
            field=models.EmailField(blank=True, max_length=254, null=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='estatus',
            field=models.CharField(choices=[('borrador', 'Borrador'), ('enviada', 'Enviada'), ('aprobada', 'Aprobada'), ('rechazada', 'Rechazada'), ('cancelada', 'Cancelada')], default='borrador', max_length=20),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='fecha_creacion',
            field=models.DateTimeField(default=django.utils.timezone.now),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='fecha_modificacion',
            field=models.DateTimeField(auto_now=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='folio',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='iva',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=15),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='logistica',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=15),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='persona_contacto',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='subtotal_mobiliario',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=15),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='telefono_vendedor',
            field=models.CharField(blank=True, max_length=20, null=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='total_general',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=15),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='uuid',
            field=models.UUIDField(default=uuid.uuid4, editable=False, null=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='vendedor',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='cliente',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='email_cliente',
            field=models.EmailField(blank=True, max_length=254, null=True),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='id',
            field=models.AutoField(primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='proyectista',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='proyecto',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='telefono_cliente',
            field=models.CharField(blank=True, max_length=20, null=True),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='unidad_facturacion',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='version',
            field=models.PositiveIntegerField(default=1),
        ),
        migrations.CreateModel(
            name='ConfiguracionPDF',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('tiempo_entrega', models.CharField(blank=True, max_length=255, null=True)),
                ('vigencia', models.CharField(blank=True, max_length=255, null=True)),
                ('condiciones_pago', models.TextField(blank=True, null=True)),
                ('mostrar_clave', models.BooleanField(default=True)),
                ('mostrar_precio_lista', models.BooleanField(default=True)),
                ('mostrar_precio_descuento', models.BooleanField(default=True)),
                ('mostrar_logistica', models.BooleanField(default=True)),
                ('mostrar_descuento_total', models.BooleanField(default=True)),
                ('cotizacion', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='configuraciones_pdf', to='cotizador.cotizacion')),
            ],
        ),
        migrations.CreateModel(
            name='ProductoCotizacion',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('es_kit', models.BooleanField(default=False)),
                ('especial', models.BooleanField(default=False)),
                ('clave', models.CharField(blank=True, max_length=50, null=True)),
                ('descripcion', models.TextField(blank=True, null=True)),
                ('imagen_url', models.URLField(blank=True, null=True)),
                ('linea', models.CharField(blank=True, max_length=100, null=True)),
                ('familia', models.CharField(blank=True, max_length=100, null=True)),
                ('grupo', models.CharField(blank=True, max_length=100, null=True)),
                ('tag', models.CharField(blank=True, max_length=100, null=True)),
                ('cantidad', models.PositiveIntegerField(default=1)),
                ('porcentaje_descuento', models.DecimalField(decimal_places=2, default=0, max_digits=5, validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(100)])),
                ('precio_lista', models.DecimalField(decimal_places=2, default=0, max_digits=15)),
                ('costo', models.DecimalField(decimal_places=2, default=0, max_digits=15)),
                ('precio_descuento', models.DecimalField(decimal_places=2, default=0, max_digits=15)),
                ('margen', models.DecimalField(decimal_places=2, default=0, max_digits=15)),
                ('importe', models.DecimalField(decimal_places=2, default=0, max_digits=15)),
                ('cotizacion', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='productos', to='cotizador.cotizacion')),
            ],
        ),
        migrations.DeleteModel(
            name='Bundle',
        ),
        migrations.DeleteModel(
            name='DetalleCotizacion',
        ),
        migrations.DeleteModel(
            name='ProductoBundle',
        ),
    ]
```

## apps\cotizador\migrations\0003_alter_cotizacion_uuid.py

- Characters: 454
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-20 22:51

import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0002_remove_productobundle_bundle_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='cotizacion',
            name='uuid',
            field=models.UUIDField(default=uuid.uuid4, editable=False, unique=True),
        ),
    ]
```

## apps\cotizador\migrations\0004_alter_productocotizacion_porcentaje_descuento.py

- Characters: 447
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-20 22:58

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0003_alter_cotizacion_uuid'),
    ]

    operations = [
        migrations.AlterField(
            model_name='productocotizacion',
            name='porcentaje_descuento',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=5),
        ),
    ]
```

## apps\cotizador\migrations\0005_cotizacion_fecha_proyecto.py

- Characters: 432
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 02:59

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0004_alter_productocotizacion_porcentaje_descuento'),
    ]

    operations = [
        migrations.AddField(
            model_name='cotizacion',
            name='fecha_proyecto',
            field=models.DateField(blank=True, null=True),
        ),
    ]
```

## apps\cotizador\migrations\0006_alter_cotizacion_options_and_more.py

- Characters: 3292
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 03:11

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0005_cotizacion_fecha_proyecto'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='cotizacion',
            options={'ordering': ['-fecha_creacion'], 'verbose_name': 'Cotización', 'verbose_name_plural': 'Cotizaciones'},
        ),
        migrations.AlterModelOptions(
            name='productocotizacion',
            options={'verbose_name': 'Producto de Cotización', 'verbose_name_plural': 'Productos de Cotización'},
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='fecha_creacion',
            field=models.DateTimeField(auto_now_add=True),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='iva',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=12),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='logistica',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=12),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='subtotal_mobiliario',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=12),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='total_general',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=12),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='version',
            field=models.IntegerField(default=1),
        ),
        migrations.AlterField(
            model_name='productocotizacion',
            name='cantidad',
            field=models.IntegerField(default=0),
        ),
        migrations.AlterField(
            model_name='productocotizacion',
            name='costo',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=12),
        ),
        migrations.AlterField(
            model_name='productocotizacion',
            name='descripcion',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AlterField(
            model_name='productocotizacion',
            name='importe',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=12),
        ),
        migrations.AlterField(
            model_name='productocotizacion',
            name='margen',
            field=models.IntegerField(default=0),
        ),
        migrations.AlterField(
            model_name='productocotizacion',
            name='porcentaje_descuento',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=10),
        ),
        migrations.AlterField(
            model_name='productocotizacion',
            name='precio_descuento',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=12),
        ),
        migrations.AlterField(
            model_name='productocotizacion',
            name='precio_lista',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=12),
        ),
    ]
```

## apps\cotizador\migrations\0007_alter_cotizacion_uuid.py

- Characters: 465
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 03:20

import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0006_alter_cotizacion_options_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='cotizacion',
            name='uuid',
            field=models.UUIDField(db_index=True, default=uuid.uuid4, editable=False, unique=True),
        ),
    ]
```

## apps\cotizador\migrations\0008_cotizacion_fecha_aprobacion_cotizacion_fecha_envio_and_more.py

- Characters: 4171
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 04:12

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0007_alter_cotizacion_uuid'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name='cotizacion',
            name='fecha_aprobacion',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='fecha_envio',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='fecha_rechazo',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='motivo',
            field=models.TextField(blank=True, help_text='Motivo de rechazo o cancelación'),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='usuario_aprobacion',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cotizaciones_aprobadas', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='usuario_creacion',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cotizaciones_creadas', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='usuario_envio',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cotizaciones_enviadas', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='usuario_rechazo',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cotizaciones_rechazadas', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='cliente',
            field=models.CharField(blank=True, max_length=255),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='email_cliente',
            field=models.EmailField(blank=True, max_length=254),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='email_vendedor',
            field=models.EmailField(blank=True, max_length=254),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='id',
            field=models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID'),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='persona_contacto',
            field=models.CharField(blank=True, max_length=255),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='proyectista',
            field=models.CharField(blank=True, max_length=255),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='proyecto',
            field=models.CharField(blank=True, max_length=255),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='telefono_cliente',
            field=models.CharField(blank=True, max_length=20),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='telefono_vendedor',
            field=models.CharField(blank=True, max_length=20),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='unidad_facturacion',
            field=models.CharField(blank=True, max_length=50),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='vendedor',
            field=models.CharField(blank=True, max_length=255),
        ),
    ]
```

## apps\cotizador\migrations\0009_alter_cotizacion_cliente_and_more.py

- Characters: 2553
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 04:15

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0008_cotizacion_fecha_aprobacion_cotizacion_fecha_envio_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='cotizacion',
            name='cliente',
            field=models.CharField(blank=True, default='', max_length=255),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='email_cliente',
            field=models.EmailField(blank=True, default='', max_length=254),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='email_vendedor',
            field=models.EmailField(blank=True, default='', max_length=254),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='folio',
            field=models.CharField(blank=True, default='', max_length=50),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='motivo',
            field=models.TextField(blank=True, default='', help_text='Motivo de rechazo o cancelación'),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='persona_contacto',
            field=models.CharField(blank=True, default='', max_length=255),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='proyectista',
            field=models.CharField(blank=True, default='', max_length=255),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='proyecto',
            field=models.CharField(blank=True, default='', max_length=255),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='telefono_cliente',
            field=models.CharField(blank=True, default='', max_length=20),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='telefono_vendedor',
            field=models.CharField(blank=True, default='', max_length=20),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='unidad_facturacion',
            field=models.CharField(blank=True, default='', max_length=50),
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='vendedor',
            field=models.CharField(blank=True, default='', max_length=255),
        ),
    ]
```

## apps\cotizador\migrations\0010_update_nulls.py

- Characters: 1442
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 04:16

from django.db import migrations

def update_null_to_empty(apps, schema_editor):
    Cotizacion = apps.get_model('cotizador', 'Cotizacion')
    
    # Actualizar todos los registros que tengan campos nulos a string vacío
    Cotizacion.objects.filter(folio__isnull=True).update(folio='')
    Cotizacion.objects.filter(proyecto__isnull=True).update(proyecto='')
    Cotizacion.objects.filter(cliente__isnull=True).update(cliente='')
    Cotizacion.objects.filter(persona_contacto__isnull=True).update(persona_contacto='')
    Cotizacion.objects.filter(email_cliente__isnull=True).update(email_cliente='')
    Cotizacion.objects.filter(telefono_cliente__isnull=True).update(telefono_cliente='')
    Cotizacion.objects.filter(vendedor__isnull=True).update(vendedor='')
    Cotizacion.objects.filter(email_vendedor__isnull=True).update(email_vendedor='')
    Cotizacion.objects.filter(telefono_vendedor__isnull=True).update(telefono_vendedor='')
    Cotizacion.objects.filter(proyectista__isnull=True).update(proyectista='')
    Cotizacion.objects.filter(unidad_facturacion__isnull=True).update(unidad_facturacion='')
    Cotizacion.objects.filter(motivo__isnull=True).update(motivo='')

class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0009_alter_cotizacion_cliente_and_more'),
    ]

    operations = [
        migrations.RunPython(update_null_to_empty),
    ]
```

## apps\cotizador\migrations\0011_cotizacion_condiciones_pago_cotizacion_mostrar_clave_and_more.py

- Characters: 1704
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 04:27

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0010_update_nulls'),
    ]

    operations = [
        migrations.AddField(
            model_name='cotizacion',
            name='condiciones_pago',
            field=models.TextField(blank=True, default=''),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='mostrar_clave',
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='mostrar_descuento_total',
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='mostrar_logistica',
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='mostrar_precio_descuento',
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='mostrar_precio_lista',
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='tiempo_entrega',
            field=models.CharField(blank=True, default='', max_length=255),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='vigencia',
            field=models.CharField(blank=True, default='', max_length=255),
        ),
        migrations.DeleteModel(
            name='ConfiguracionPDF',
        ),
    ]
```

## apps\cotizador\migrations\0012_remove_cotizacion_fecha_aprobacion_and_more.py

- Characters: 1252
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 04:34

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0011_cotizacion_condiciones_pago_cotizacion_mostrar_clave_and_more'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='cotizacion',
            name='fecha_aprobacion',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='fecha_envio',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='fecha_rechazo',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='usuario_aprobacion',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='usuario_creacion',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='usuario_envio',
        ),
        migrations.RemoveField(
            model_name='cotizacion',
            name='usuario_rechazo',
        ),
        migrations.AlterField(
            model_name='cotizacion',
            name='motivo',
            field=models.TextField(blank=True, default=''),
        ),
    ]
```

## apps\cotizador\migrations\0013_alter_productocotizacion_cotizacion.py

- Characters: 591
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 05:21

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0012_remove_cotizacion_fecha_aprobacion_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='productocotizacion',
            name='cotizacion',
            field=models.ForeignKey(db_column='cotizacion_uuid', on_delete=django.db.models.deletion.CASCADE, related_name='productos', to='cotizador.cotizacion', to_field='uuid'),
        ),
    ]
```

## apps\cotizador\migrations\0014_alter_productocotizacion_cotizacion.py

- Characters: 566
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 05:23

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0013_alter_productocotizacion_cotizacion'),
    ]

    operations = [
        migrations.AlterField(
            model_name='productocotizacion',
            name='cotizacion',
            field=models.ForeignKey(db_column='cotizacion_uuid', on_delete=django.db.models.deletion.CASCADE, related_name='productos', to='cotizador.cotizacion'),
        ),
    ]
```

## apps\cotizador\migrations\0015_alter_producttemplate_options.py

- Characters: 367
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-21 22:25

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0014_alter_productocotizacion_cotizacion'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='producttemplate',
            options={'managed': True},
        ),
    ]
```

## apps\cotizador\migrations\0016_productscache_cotizacion_total_descuento_and_more.py

- Characters: 3883
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-02-25 13:35

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0015_alter_producttemplate_options'),
    ]

    operations = [
        migrations.CreateModel(
            name='ProductsCache',
            fields=[
                ('id', models.IntegerField(primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=255)),
                ('reference_mask', models.CharField(max_length=255)),
                ('type_id', models.IntegerField(null=True)),
                ('family_id', models.IntegerField(null=True)),
                ('line_id', models.IntegerField(null=True)),
                ('group_id', models.IntegerField(null=True)),
                ('active', models.BooleanField(default=True)),
                ('is_line', models.BooleanField(default=True)),
                ('description_sale', models.TextField(null=True)),
                ('default_code', models.CharField(max_length=64, null=True)),
                ('type_name', models.CharField(max_length=255, null=True)),
                ('family_name', models.CharField(max_length=255, null=True)),
                ('line_name', models.CharField(max_length=255, null=True)),
                ('group_name', models.CharField(max_length=255, null=True)),
                ('image_url', models.URLField(max_length=512, null=True)),
                ('last_sync', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Producto Supabase',
                'verbose_name_plural': 'Productos Supabase',
                'db_table': 'products_cache',
                'managed': False,
            },
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='total_descuento',
            field=models.DecimalField(decimal_places=2, default=0, max_digits=12),
        ),
        migrations.AddField(
            model_name='producttemplate',
            name='family',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='cotizador.productfamily'),
        ),
        migrations.AddField(
            model_name='producttemplate',
            name='group',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='cotizador.productgroup'),
        ),
        migrations.AddField(
            model_name='producttemplate',
            name='last_sync',
            field=models.DateTimeField(auto_now=True),
        ),
        migrations.AddField(
            model_name='producttemplate',
            name='line',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='cotizador.productline'),
        ),
        migrations.AddField(
            model_name='producttemplate',
            name='type',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='cotizador.producttype'),
        ),
        migrations.AddIndex(
            model_name='producttemplate',
            index=models.Index(fields=['name'], name='idx_name'),
        ),
        migrations.AddIndex(
            model_name='producttemplate',
            index=models.Index(fields=['reference_mask'], name='idx_ref_mask'),
        ),
        migrations.AddIndex(
            model_name='producttemplate',
            index=models.Index(fields=['is_line', 'active'], name='idx_line_active'),
        ),
        migrations.AddIndex(
            model_name='producttemplate',
            index=models.Index(fields=['type', 'family', 'line', 'group'], name='idx_product_hierarchy'),
        ),
        migrations.AlterModelTable(
            name='producttemplate',
            table='cotizador_product_template',
        ),
    ]
```

## apps\cotizador\migrations\0017_productocotizacion_kit_padre_id_and_more.py

- Characters: 3446
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-03-04 15:35

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0016_productscache_cotizacion_total_descuento_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name='productocotizacion',
            name='kit_padre_id',
            field=models.IntegerField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='productocotizacion',
            name='kit_uuid',
            field=models.UUIDField(blank=True, db_index=True, null=True),
        ),
        migrations.AddField(
            model_name='productocotizacion',
            name='mostrar_en_cotizacion',
            field=models.BooleanField(default=True),
        ),
        migrations.CreateModel(
            name='Kit',
            fields=[
                ('id', models.AutoField(primary_key=True, serialize=False)),
                ('uuid', models.UUIDField(db_index=True, default=uuid.uuid4, editable=False, unique=True)),
                ('nombre', models.CharField(max_length=255)),
                ('descripcion', models.TextField(blank=True, null=True)),
                ('imagen_url', models.URLField(blank=True, null=True)),
                ('valor_unitario', models.DecimalField(decimal_places=2, default=0, max_digits=12)),
                ('costo_unitario', models.DecimalField(decimal_places=2, default=0, max_digits=12)),
                ('porcentaje_descuento', models.DecimalField(decimal_places=2, default=0, max_digits=10)),
                ('valor_unitario_con_descuento', models.DecimalField(decimal_places=2, default=0, max_digits=12)),
                ('creado_por', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='kits_creados', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Kit',
                'verbose_name_plural': 'Kits',
            },
        ),
        migrations.CreateModel(
            name='KitProducto',
            fields=[
                ('id', models.AutoField(primary_key=True, serialize=False)),
                ('reference_mask', models.CharField(db_index=True, max_length=50)),
                ('cantidad', models.IntegerField(default=1)),
                ('porcentaje_descuento', models.DecimalField(decimal_places=2, default=0, max_digits=10)),
                ('precio_lista', models.DecimalField(decimal_places=2, default=0, max_digits=12)),
                ('costo', models.DecimalField(decimal_places=2, default=0, max_digits=12)),
                ('precio_descuento', models.DecimalField(decimal_places=2, default=0, max_digits=12)),
                ('importe', models.DecimalField(decimal_places=2, default=0, max_digits=12)),
                ('orden', models.IntegerField(default=0)),
                ('kit', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='productos', to='cotizador.kit')),
            ],
            options={
                'verbose_name': 'Producto de Kit',
                'verbose_name_plural': 'Productos de Kit',
                'ordering': ['orden', 'id'],
                'unique_together': {('kit', 'reference_mask')},
            },
        ),
    ]
```

## apps\cotizador\migrations\0018_alter_cotizadorimagenproducto_clave_padre.py

- Characters: 530
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-03-04 22:35

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0017_productocotizacion_kit_padre_id_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='cotizadorimagenproducto',
            name='clave_padre',
            field=models.CharField(db_index=True, help_text='Clave del producto que coincide con reference_mask de ProductTemplate', max_length=255),
        ),
    ]
```

## apps\cotizador\migrations\0019_alter_cotizadorimagenproducto_clave_padre.py

- Characters: 544
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-03-04 22:49

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0018_alter_cotizadorimagenproducto_clave_padre'),
    ]

    operations = [
        migrations.AlterField(
            model_name='cotizadorimagenproducto',
            name='clave_padre',
            field=models.CharField(db_index=True, help_text='Clave del producto que coincide con reference_mask de ProductTemplate', max_length=255, unique=True),
        ),
    ]
```

## apps\cotizador\migrations\0020_cotizacion_usuario_aprobacion_and_more.py

- Characters: 1565
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-03-06 11:11

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0019_alter_cotizadorimagenproducto_clave_padre'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name='cotizacion',
            name='usuario_aprobacion',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cotizaciones_aprobadas', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='usuario_creacion',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cotizaciones_creadas', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='usuario_envio',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cotizaciones_enviadas', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='usuario_rechazo',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cotizaciones_rechazadas', to=settings.AUTH_USER_MODEL),
        ),
        # Se eliminó la operación AlterField que estaba causando problemas
    ]
```

## apps\cotizador\migrations\0021_custom_kitproducto_fields.py

- Characters: 3220
- Tokens: 0

```python
from django.db import migrations

class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0020_cotizacion_usuario_aprobacion_and_more'),
    ]

    operations = [
        migrations.RunSQL(
            """
            -- Verificar si la columna reference_mask existe y renombrarla a clave
            DO $$
            BEGIN
                IF EXISTS (SELECT 1 FROM information_schema.columns 
                          WHERE table_name = 'cotizador_kitproducto' AND column_name = 'reference_mask') THEN
                    ALTER TABLE cotizador_kitproducto RENAME COLUMN reference_mask TO clave;
                END IF;
                
                -- Si clave no existe pero reference_mask tampoco, crear la columna clave
                IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                              WHERE table_name = 'cotizador_kitproducto' AND column_name = 'clave') AND
                   NOT EXISTS (SELECT 1 FROM information_schema.columns 
                              WHERE table_name = 'cotizador_kitproducto' AND column_name = 'reference_mask') THEN
                    ALTER TABLE cotizador_kitproducto ADD COLUMN clave VARCHAR(255);
                END IF;
            END
            $$;
            
            -- Añadir nuevos campos a la tabla KitProducto si no existen
            ALTER TABLE cotizador_kitproducto 
            ADD COLUMN IF NOT EXISTS descripcion VARCHAR(255) NULL,
            ADD COLUMN IF NOT EXISTS linea VARCHAR(100) NULL,
            ADD COLUMN IF NOT EXISTS familia VARCHAR(100) NULL,
            ADD COLUMN IF NOT EXISTS grupo VARCHAR(100) NULL,
            ADD COLUMN IF NOT EXISTS mostrar_en_kit BOOLEAN DEFAULT TRUE,
            ADD COLUMN IF NOT EXISTS es_opcional BOOLEAN DEFAULT FALSE;
            
            -- Actualizar la restricción unique_together
            ALTER TABLE cotizador_kitproducto DROP CONSTRAINT IF EXISTS cotizador_kitproducto_kit_id_reference_mask_uniq;
            
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM pg_constraint 
                    WHERE conname = 'cotizador_kitproducto_kit_id_clave_uniq'
                ) THEN
                    ALTER TABLE cotizador_kitproducto ADD CONSTRAINT cotizador_kitproducto_kit_id_clave_uniq UNIQUE (kit_id, clave);
                END IF;
            END
            $$;
            """,
            """
            -- Revertir cambios (renombrar y eliminar columnas)
            ALTER TABLE cotizador_kitproducto DROP CONSTRAINT IF EXISTS cotizador_kitproducto_kit_id_clave_uniq;
            ALTER TABLE cotizador_kitproducto ADD CONSTRAINT cotizador_kitproducto_kit_id_reference_mask_uniq UNIQUE (kit_id, reference_mask);
            
            ALTER TABLE cotizador_kitproducto 
            DROP COLUMN IF EXISTS descripcion,
            DROP COLUMN IF EXISTS linea,
            DROP COLUMN IF EXISTS familia,
            DROP COLUMN IF EXISTS grupo,
            DROP COLUMN IF EXISTS mostrar_en_kit,
            DROP COLUMN IF EXISTS es_opcional;
            
            ALTER TABLE cotizador_kitproducto RENAME COLUMN clave TO reference_mask;
            """
        ),
    ]
```

## apps\cotizador\migrations\0022_rename_reference_mask_kitproducto_clave_and_more.py

- Characters: 1576
- Tokens: 0

```python
# Generated by Django 5.0.1 on 2025-03-06 15:15

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0021_custom_kitproducto_fields'),
    ]

    operations = [
        migrations.RenameField(
            model_name='kitproducto',
            old_name='reference_mask',
            new_name='clave',
        ),
        migrations.AlterUniqueTogether(
            name='kitproducto',
            unique_together={('kit', 'clave')},
        ),
        migrations.AddField(
            model_name='kitproducto',
            name='descripcion',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='kitproducto',
            name='es_opcional',
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name='kitproducto',
            name='familia',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='kitproducto',
            name='grupo',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='kitproducto',
            name='linea',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='kitproducto',
            name='mostrar_en_kit',
            field=models.BooleanField(default=True),
        ),
    ]
```

## apps\cotizador\migrations\0023_add_cantidad_to_kit.py

- Characters: 406
- Tokens: 0

```python
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0022_rename_reference_mask_kitproducto_clave_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='kit',
            name='cantidad',
            field=models.IntegerField(default=1, help_text='Cantidad de unidades del kit'),
        ),
    ]
```

## apps\cotizador\migrations\0024_add_cliente_id_to_cotizacion.py

- Characters: 369
- Tokens: 0

```python
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0023_add_cantidad_to_kit'),
    ]

    operations = [
        migrations.AddField(
            model_name='cotizacion',
            name='cliente_id',
            field=models.CharField(blank=True, default='', max_length=50),
        ),
    ]
```

## apps\cotizador\migrations\0025_add_usuario_fields_to_cotizacion.py

- Characters: 566
- Tokens: 0

```python
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0024_add_cliente_id_to_cotizacion'),
    ]

    operations = [
        migrations.AddField(
            model_name='cotizacion',
            name='usuario_id',
            field=models.CharField(blank=True, default='', max_length=50),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='usuario_email',
            field=models.EmailField(blank=True, default='', max_length=254),
        ),
    ]
```

## apps\cotizador\migrations\0026_add_producto_id_to_models.py

- Characters: 550
- Tokens: 0

```python
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('cotizador', '0025_add_usuario_fields_to_cotizacion'),
    ]

    operations = [
        migrations.AddField(
            model_name='productocotizacion',
            name='producto_id',
            field=models.IntegerField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='kitproducto',
            name='producto_id',
            field=models.IntegerField(blank=True, null=True),
        ),
    ]
```

## apps\cotizador\migrations\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\cotizador\models.py

- Characters: 23107
- Tokens: 0

```python
from django.db import models
from django.conf import settings
from django.utils import timezone
from django.utils.html import mark_safe
from decimal import Decimal
from django.core.validators import MinValueValidator, MaxValueValidator
import uuid
from django.contrib.auth.models import User

class Cliente(models.Model):
    """Modelo para almacenar información de clientes"""
    partner_id = models.IntegerField(primary_key=True, help_text="ID único del cliente")
    name_partner = models.CharField(max_length=255, help_text="Nombre del cliente")
    rfc = models.CharField(max_length=20, blank=True, null=True, help_text="RFC del cliente")


    class Meta:
        db_table = 'cotizador_cliente'  # Nombre de la tabla en la base de datos
        verbose_name = 'Cliente'
        verbose_name_plural = 'Clientes'
        indexes = [
            models.Index(fields=['name_partner'], name='idx_cliente_name'),
            models.Index(fields=['rfc'], name='idx_cliente_rfc'),
        ]

    def __str__(self):
        return f"{self.name_partner} ({self.partner_id})"

class Producto(models.Model):
    nombre = models.CharField(max_length=255)
    codigo_producto = models.CharField(max_length=64, unique=True, null=True, blank=True)
    precio_base = models.DecimalField(max_digits=10, decimal_places=2)
    descripcion = models.TextField(blank=True, null=True)
    activo = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.codigo_producto} - {self.nombre}"

class ProductType(models.Model):
    """Modelo para product_type de Odoo"""
    id = models.AutoField(primary_key=True)
    name = models.CharField(max_length=255)

    class Meta:
        managed = False
        db_table = 'product_type'
        app_label = 'cotizador'

    def __str__(self):
        return self.name

class ProductFamily(models.Model):
    """Modelo para product_family de Odoo"""
    id = models.AutoField(primary_key=True)
    name = models.CharField(max_length=255)

    class Meta:
        managed = False
        db_table = 'product_family'
        app_label = 'cotizador'

    def __str__(self):
        return self.name

class ProductLine(models.Model):
    """Modelo para product_line de Odoo"""
    id = models.AutoField(primary_key=True)
    name = models.CharField(max_length=255)

    class Meta:
        managed = False
        db_table = 'product_line'
        app_label = 'cotizador'

    def __str__(self):
        return self.name

class ProductGroup(models.Model):
    """Modelo para product_group de Odoo"""
    id = models.AutoField(primary_key=True)
    name = models.CharField(max_length=255)

    class Meta:
        managed = False
        db_table = 'product_group'
        app_label = 'cotizador'

    def __str__(self):
        return self.name

class ProductTemplateManager(models.Manager):
    def get_queryset(self):
        return super().get_queryset().filter(
            is_line=True,
            reference_mask__isnull=False,
            active=True
        )

    def get_full_queryset(self):
        """
        Obtiene todos los registros sin filtros
        """
        return super().get_queryset()

class ProductTemplate(models.Model):
    """Modelo que almacena una copia local de los productos de Odoo"""
    objects = ProductTemplateManager()  # Hacer que el manager filtrado sea el predeterminado
    all_objects = models.Manager()  # Manager secundario para acceder a todos los registros

    id = models.AutoField(primary_key=True)
    name = models.CharField(max_length=255, db_index=True)
    reference_mask = models.CharField(max_length=255, null=True, db_index=True)
    note_pricelist = models.CharField(max_length=255, null=True, blank=True)
    type = models.ForeignKey(ProductType, on_delete=models.SET_NULL, null=True, db_index=True)
    family = models.ForeignKey(ProductFamily, on_delete=models.SET_NULL, null=True, db_index=True)
    line = models.ForeignKey(ProductLine, on_delete=models.SET_NULL, null=True, db_index=True)
    group = models.ForeignKey(ProductGroup, on_delete=models.SET_NULL, null=True, db_index=True)
    is_line = models.BooleanField(default=True, db_index=True)
    pricelist = models.BooleanField(default=False)
    active = models.BooleanField(default=True, db_index=True)
    last_sync = models.DateTimeField(auto_now=True)

    class Meta:
        managed = False  # Ahora es gestionado localmente
        db_table = 'product_template'  # Nueva tabla local
        app_label = 'cotizador'
        indexes = [
            models.Index(fields=['name'], name='idx_name'),
            models.Index(fields=['reference_mask'], name='idx_ref_mask'),
            models.Index(fields=['is_line', 'active'], name='idx_line_active'),
            models.Index(fields=['type', 'family', 'line', 'group'], name='idx_product_hierarchy')
        ]

    def __str__(self):
        return f"{self.reference_mask} - {self.name}"

    def get_images(self):
        """
        Obtiene todas las imágenes asociadas a este producto a través del reference_mask
        """
        return CotizadorImagenproducto.objects.filter(clave_padre=self.reference_mask)

    def get_primary_image(self):
        """
        Obtiene la primera imagen asociada al producto
        """
        return self.get_images().first()

    def get_image_preview(self):
        """
        Retorna el HTML para mostrar la vista previa de la primera imagen
        """
        image = self.get_primary_image()
        if image and image.url:
            return mark_safe(f'<img src="{image.url}" style="max-height: 50px;" />')
        return '-'

    def get_image_gallery(self):
        """
        Retorna el HTML para mostrar todas las imágenes del producto
        """
        images = self.get_images()
        if images:
            gallery_html = '<div style="display: flex; gap: 10px; flex-wrap: wrap;">'
            for image in images:
                if image.url:
                    gallery_html += f'<img src="{image.url}" style="max-height: 100px;" />'
            gallery_html += '</div>'
            return mark_safe(gallery_html)
        return 'No hay imágenes disponibles'

# Estados de cotización
ESTADO_BORRADOR = 'BORRADOR'
ESTADO_EN_REVISION = 'EN_REVISION'
ESTADO_ACEPTADA = 'ACEPTADA'
ESTADO_RECHAZADA = 'RECHAZADA'
ESTADO_CANCELADA = 'CANCELADA'

ESTADO_CHOICES = [
    (ESTADO_BORRADOR, 'Borrador'),
    (ESTADO_EN_REVISION, 'En Revisión'),
    (ESTADO_ACEPTADA, 'Aceptada'),
    (ESTADO_RECHAZADA, 'Rechazada'),
    (ESTADO_CANCELADA, 'Cancelada'),
]

class Cotizacion(models.Model):
    ESTATUS_CHOICES = [
        ('borrador', 'Borrador'),
        ('enviada', 'Enviada'),
        ('aprobada', 'Aprobada'),
        ('rechazada', 'Rechazada'),
        ('cancelada', 'Cancelada'),
    ]

    # Campos de control
    uuid = models.UUIDField(default=uuid.uuid4, editable=False, unique=True, db_index=True)
    folio = models.CharField(max_length=50, blank=True, default='')
    version = models.IntegerField(default=1)
    
    # Campos principales
    proyecto = models.CharField(max_length=255, blank=True, default='')
    fecha_proyecto = models.DateField(null=True, blank=True)
    cliente = models.CharField(max_length=255, blank=True, default='')
    cliente_id = models.CharField(max_length=50, blank=True, default='')
    persona_contacto = models.CharField(max_length=255, blank=True, default='')
    email_cliente = models.EmailField(blank=True, default='')
    telefono_cliente = models.CharField(max_length=20, blank=True, default='')
    vendedor = models.CharField(max_length=255, blank=True, default='')
    email_vendedor = models.EmailField(blank=True, default='')
    telefono_vendedor = models.CharField(max_length=20, blank=True, default='')
    proyectista = models.CharField(max_length=255, blank=True, default='')
    unidad_facturacion = models.CharField(max_length=50, blank=True, default='')
    usuario_id = models.CharField(max_length=50, blank=True, default='')
    usuario_email = models.EmailField(blank=True, default='')
    estatus = models.CharField(max_length=20, choices=ESTATUS_CHOICES, default='borrador')
    motivo = models.TextField(blank=True, default='')
    
    # Campos de configuración PDF
    tiempo_entrega = models.CharField(max_length=255, blank=True, default='')
    vigencia = models.CharField(max_length=255, blank=True, default='')
    condiciones_pago = models.TextField(blank=True, default='')
    mostrar_clave = models.BooleanField(default=True)
    mostrar_precio_lista = models.BooleanField(default=True)
    mostrar_precio_descuento = models.BooleanField(default=True)
    mostrar_logistica = models.BooleanField(default=True)
    mostrar_descuento_total = models.BooleanField(default=True)
    
    # Campos de sistema
    fecha_creacion = models.DateTimeField(auto_now_add=True)
    fecha_modificacion = models.DateTimeField(auto_now=True)
    usuario_creacion = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='cotizaciones_creadas'
    )
    usuario_envio = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='cotizaciones_enviadas'
    )
    usuario_aprobacion = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='cotizaciones_aprobadas'
    )
    usuario_rechazo = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='cotizaciones_rechazadas'
    )
    
    # Campos calculados
    subtotal_mobiliario = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    total_descuento = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    logistica = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    iva = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    total_general = models.DecimalField(max_digits=12, decimal_places=2, default=0)

    class Meta:
        verbose_name = 'Cotización'
        verbose_name_plural = 'Cotizaciones'
        ordering = ['-fecha_creacion']

    def __str__(self):
        return f"{self.folio} - {self.cliente}"

class Kit(models.Model):
    """
    Modelo que representa un kit de productos con sus valores calculados.
    Un kit es un conjunto de productos que se venden como una unidad.
    """
    id = models.AutoField(primary_key=True)
    uuid = models.UUIDField(default=uuid.uuid4, editable=False, unique=True, db_index=True)
    nombre = models.CharField(max_length=255)
    descripcion = models.TextField(blank=True, null=True)
    imagen_url = models.URLField(blank=True, null=True)
    cantidad = models.IntegerField(default=1, help_text='Cantidad de unidades del kit')
    valor_unitario = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    costo_unitario = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    porcentaje_descuento = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    valor_unitario_con_descuento = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    creado_por = models.ForeignKey(
        settings.AUTH_USER_MODEL, 
        on_delete=models.SET_NULL, 
        null=True, 
        related_name='kits_creados'
    )

    class Meta:
        verbose_name = 'Kit'
        verbose_name_plural = 'Kits'

    def __str__(self):
        return f"{self.nombre}"
        
    def agregar_producto(self, clave, cantidad=1, porcentaje_descuento=0, **kwargs):
        """
        Agrega un producto al kit
        """
        producto = KitProducto.objects.create(
            kit=self,
            clave=clave,
            cantidad=cantidad,
            porcentaje_descuento=porcentaje_descuento,
            **kwargs
        )
        return producto
        
    def actualizar_producto(self, producto_kit_id, cantidad=None, porcentaje_descuento=None, **kwargs):
        """
        Actualiza un producto existente en el kit
        """
        try:
            producto = self.productos.get(id=producto_kit_id)
            
            if cantidad is not None:
                producto.cantidad = cantidad
                
            if porcentaje_descuento is not None:
                producto.porcentaje_descuento = porcentaje_descuento
                
            for key, value in kwargs.items():
                setattr(producto, key, value)
                
            producto.save()
            return producto
        except KitProducto.DoesNotExist:
            return None
            
    def eliminar_producto(self, producto_kit_id):
        """
        Elimina un producto del kit
        """
        try:
            producto = self.productos.get(id=producto_kit_id)
            producto.delete()
            return True
        except KitProducto.DoesNotExist:
            return False
            
    def duplicar(self, nuevo_nombre=None):
        """
        Crea una copia del kit con todos sus productos
        """
        # Crear un nuevo kit con los mismos datos
        nuevo_kit = Kit.objects.create(
            nombre=nuevo_nombre or f"{self.nombre} (Copia)",
            descripcion=self.descripcion,
            imagen_url=self.imagen_url,
            cantidad=self.cantidad,
            valor_unitario=self.valor_unitario,
            costo_unitario=self.costo_unitario,
            porcentaje_descuento=self.porcentaje_descuento,
            valor_unitario_con_descuento=self.valor_unitario_con_descuento,
            creado_por=self.creado_por
        )
        
        # Duplicar productos
        for producto in self.productos.all():
            KitProducto.objects.create(
                kit=nuevo_kit,
                clave=producto.clave,
                cantidad=producto.cantidad,
                porcentaje_descuento=producto.porcentaje_descuento,
                precio_lista=producto.precio_lista,
                costo=producto.costo,
                precio_descuento=producto.precio_descuento,
                importe=producto.importe,
                mostrar_en_kit=producto.mostrar_en_kit,
                descripcion=producto.descripcion,
                linea=producto.linea,
                familia=producto.familia,
                grupo=producto.grupo,
                producto_id=producto.producto_id
            )
        
        return nuevo_kit


class KitProducto(models.Model):
    """Modelo que representa la relación entre un Kit y un producto.
    Almacena la información necesaria para calcular precios y cantidades.
    """
    id = models.AutoField(primary_key=True)
    kit = models.ForeignKey(Kit, on_delete=models.CASCADE, related_name='productos')
    clave = models.CharField(max_length=50, db_index=True)  
    cantidad = models.IntegerField(default=1)
    porcentaje_descuento = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    precio_lista = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    costo = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    precio_descuento = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    importe = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    
    # Campo adicional para ordenar productos dentro del kit
    orden = models.IntegerField(default=0)
    
    # Nuevos campos
    descripcion = models.CharField(max_length=255, blank=True, null=True)
    linea = models.CharField(max_length=100, blank=True, null=True)
    familia = models.CharField(max_length=100, blank=True, null=True)
    grupo = models.CharField(max_length=100, blank=True, null=True)
    mostrar_en_kit = models.BooleanField(default=True)
    es_opcional = models.BooleanField(default=False)
    
    # ID del producto en el sistema externo
    producto_id = models.IntegerField(blank=True, null=True)

    class Meta:
        verbose_name = 'Producto de Kit'
        verbose_name_plural = 'Productos de Kit'
        ordering = ['orden', 'id']
        unique_together = ('kit', 'clave')  # Evita duplicados del mismo producto en un kit
    
    def __str__(self):
        return f"{self.kit.nombre} - {self.clave} (x{self.cantidad})"

    def save(self, *args, **kwargs):
        """
        Sobrescribes el método save para calcular el precio con descuento y el importe
        """
        # Calcular precio con descuento
        if self.porcentaje_descuento > 0:
            self.precio_descuento = self.precio_lista * (1 - (self.porcentaje_descuento / 100))
        else:
            self.precio_descuento = self.precio_lista
        
        # Calcular importe
        self.importe = self.precio_descuento * self.cantidad
        
        super().save(*args, **kwargs)
        
        # Actualizar totales del kit
        self.kit.save()
        
    def get_producto_nombre(self):
        """
        Obtiene el nombre del producto desde ProductsCache
        """
        from .cache.models import ProductsCache
        try:
            # Intentar obtener el producto desde la tabla products_cache
            producto = ProductsCache.objects.get(reference_mask=self.clave)
            return producto.name
        except Exception:
            # Si hay cualquier error, devolver el reference_mask
            return self.clave
            
    def get_producto_imagen(self):
        """
        Obtiene la URL de la primera imagen del producto
        """
        from .cache.models import ProductsCache
        try:
            # Primero intentar obtener la imagen desde ProductsCache
            try:
                producto = ProductsCache.objects.get(reference_mask=self.clave)
                if producto.image_url:
                    return producto.image_url
            except Exception:
                pass
                
            # Si no hay imagen en ProductsCache, intentar con CotizadorImagenproducto
            imagen = CotizadorImagenproducto.objects.filter(clave_padre=self.clave).first()
            return imagen.url if imagen else None
        except Exception:
            return None


class ProductoCotizacion(models.Model):
    cotizacion = models.ForeignKey(
        'Cotizacion',
        on_delete=models.CASCADE,
        related_name='productos',
        db_column='cotizacion_uuid'  # Esta columna es en realidad bigint en la DB
    )
    es_kit = models.BooleanField(default=False)
    especial = models.BooleanField(default=False)
    clave = models.CharField(max_length=50, blank=True, null=True)
    descripcion = models.CharField(max_length=255, blank=True, null=True)
    imagen_url = models.URLField(blank=True, null=True)
    linea = models.CharField(max_length=100, blank=True, null=True)
    familia = models.CharField(max_length=100, blank=True, null=True)
    grupo = models.CharField(max_length=100, blank=True, null=True)
    tag = models.CharField(max_length=100, blank=True, null=True)
    
    # Campos numéricos
    cantidad = models.IntegerField(default=0)
    porcentaje_descuento = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    precio_lista = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    costo = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    precio_descuento = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    margen = models.IntegerField(default=0)
    importe = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    
    # Campos para kits
    kit_uuid = models.UUIDField(blank=True, null=True, db_index=True)
    kit_padre_id = models.IntegerField(blank=True, null=True)
    mostrar_en_cotizacion = models.BooleanField(default=True)
    
    # ID del producto en el sistema externo
    producto_id = models.IntegerField(blank=True, null=True)

    class Meta:
        verbose_name = 'Producto de Cotización'
        verbose_name_plural = 'Productos de Cotización'

    def __str__(self):
        return f"{self.clave} - {self.descripcion}"
    
    def save(self, *args, **kwargs):
        """
        Sobrescribes el mu00e9todo save para asegurar que los valores numu00e9ricos
        se guarden correctamente y no sean None o cadenas vacu00edas
        """
        # Asegurar que los campos numu00e9ricos tengan valores vu00e1lidos
        if self.precio_lista is None:
            self.precio_lista = Decimal('0')
        if self.costo is None:
            self.costo = Decimal('0')
        if self.precio_descuento is None:
            self.precio_descuento = Decimal('0')
        if self.importe is None:
            self.importe = Decimal('0')
            
        # Solo recalcular el importe si no tiene un valor o es cero
        # Esto permite establecer el importe manualmente en otros lugares del cu00f3digo
        if (self.importe is None or self.importe == Decimal('0')) and self.precio_descuento and self.cantidad:
            self.importe = self.precio_descuento * self.cantidad
            
        super().save(*args, **kwargs)


class CotizadorImagenproducto(models.Model):
    """
    Modelo para almacenar las imágenes de los productos.
    Cada imagen está asociada a un producto mediante la clave_padre que coincide
    con el reference_mask de ProductTemplate.
    """
    id = models.BigAutoField(primary_key=True)
    clave_padre = models.CharField(
        max_length=255, 
        db_index=True,
        unique=True,
        help_text='Clave del producto que coincide con reference_mask de ProductTemplate'
    )
    url = models.CharField(
        max_length=2048,
        help_text='URL de la imagen en Supabase Storage'
    )

    class Meta:
        managed = True
        db_table = 'cotizador_imagenproducto'
        verbose_name = 'Imagen de Producto'
        verbose_name_plural = 'Imágenes de Productos'
        indexes = [
            models.Index(fields=['clave_padre'], name='idx_clave_padre'),
            models.Index(fields=['clave_padre', 'url'], name='idx_clave_url')
        ]

    def __str__(self):
        return f"Imagen de {self.clave_padre}"

    def get_product_template(self):
        """
        Obtiene el ProductTemplate asociado a esta imagen usando el reference_mask
        """
        return ProductTemplate.objects.using('erp-portalgebesa-com').filter(
            reference_mask=self.clave_padre,
            active=True,
            is_line=True
        ).first()

    def get_product_info(self):
        """
        Obtiene información detallada del producto asociado
        """
        product = self.get_product_template()
        if product:
            return {
                'id': product.id,
                'reference_mask': product.reference_mask,
                'description': product.description_picking,
                'type': product.type_id.name if product.type_id else None,
                'family': product.family_id.name if product.family_id else None,
                'line': product.line_id.name if product.line_id else None,
                'group': product.group_id.name if product.group_id else None
            }
        return None
```

## apps\cotizador\README.md

- Characters: 2767
- Tokens: 0

````markdown
# Módulo de Cotizador

## Descripción
Este módulo maneja todo el sistema de cotizaciones y presupuestos en APP-MANAGER, permitiendo la gestión completa del proceso de cotización.

## Estructura

```
cotizador/
├── __init__.py
├── admin.py          # Configuración del panel de administración
├── apps.py          # Configuración de la aplicación
├── models.py        # Modelos de datos
├── routers.py       # Configuración de rutas de la API
├── serializers.py   # Serializadores para la API
├── tests.py         # Pruebas unitarias
├── urls.py          # Configuración de URLs
└── views.py         # Vistas y lógica de negocio
```

## Características Principales

1. **Gestión de Cotizaciones**
   - Creación de cotizaciones
   - Seguimiento de estado
   - Historial de cambios
   - Cálculos automáticos

2. **Productos y Servicios**
   - Catálogo de productos
   - Precios y descuentos
   - Gestión de inventario
   - Categorización

3. **Clientes**
   - Base de datos de clientes
   - Historial de cotizaciones por cliente
   - Información de contacto

## Endpoints API

### Cotizaciones
- `GET /api/cotizador/cotizaciones/` - Listar cotizaciones
- `POST /api/cotizador/cotizaciones/` - Crear cotización
- `GET /api/cotizador/cotizaciones/{id}/` - Detalle de cotización
- `PUT /api/cotizador/cotizaciones/{id}/` - Actualizar cotización
- `DELETE /api/cotizador/cotizaciones/{id}/` - Eliminar cotización

### Productos
- `GET /api/cotizador/productos/` - Listar productos
- `POST /api/cotizador/productos/` - Crear producto
- `GET /api/cotizador/productos/{id}/` - Detalle de producto

## Modelos

### Cotizacion
- Cliente
- Fecha
- Estado
- Items
- Total
- Observaciones

### Producto
- Nombre
- Descripción
- Precio
- Categoría
- Stock

### Cliente
- Información de contacto
- Historial de cotizaciones
- Preferencias

## Funcionalidades

1. **Cálculos Automáticos**
   - Subtotales
   - Impuestos
   - Descuentos
   - Total final

2. **Gestión de Estados**
   - Pendiente
   - En revisión
   - Aprobada
   - Rechazada
   - Finalizada

3. **Reportes**
   - Cotizaciones por período
   - Productos más cotizados
   - Estadísticas de conversión

## Uso

```python
# Ejemplo de creación de cotización
from apps.cotizador.models import Cotizacion, Item

def crear_cotizacion(cliente, items):
    cotizacion = Cotizacion.objects.create(
        cliente=cliente,
        estado='pendiente'
    )
    for item in items:
        Item.objects.create(
            cotizacion=cotizacion,
            producto=item['producto'],
            cantidad=item['cantidad']
        )
    return cotizacion
```

## Configuración
El módulo utiliza las siguientes configuraciones:
- Configuraciones de impuestos
- Estados de cotización
- Políticas de descuentos
- Formatos de numeración
````

## apps\cotizador\routers.py

- Characters: 2060
- Tokens: 0

```python
class DatabaseRouter:
    """
    Router para manejar las consultas a múltiples bases de datos.
    """
    def db_for_read(self, model, **hints):
        """
        Determina qué base de datos usar para lectura.
        """
        if model._meta.app_label == 'cotizador' and model.__name__ == 'ProductoOdoo':
            return 'odoo_db'
        return 'default'

    def db_for_write(self, model, **hints):
        """
        Todas las escrituras van a la base de datos default.
        """
        return 'default'

    def allow_relation(self, obj1, obj2, **hints):
        """
        Permite relaciones si ambos modelos están en la misma base de datos.
        """
        return True

    def allow_migrate(self, db, app_label, model_name=None, **hints):
        """
        Asegura que las migraciones solo se apliquen a la base de datos default.
        """
        if db == 'odoo_db':
            return False
        return True


class ERPRouter:
    """
    Router para dirigir las consultas de modelos específicos a la base de datos ERP.
    """
    route_app_labels = {'cotizador'}
    erp_models = {'producttemplate', 'producttype', 'productfamily', 'productline', 'productgroup'}  

    def db_for_read(self, model, **hints):
        if model._meta.app_label in self.route_app_labels and model._meta.model_name in self.erp_models:
            return 'erp-portalgebesa-com'
        return None

    def db_for_write(self, model, **hints):
        if model._meta.app_label in self.route_app_labels and model._meta.model_name in self.erp_models:
            return 'erp-portalgebesa-com'
        return None

    def allow_relation(self, obj1, obj2, **hints):
        if (
            obj1._meta.app_label in self.route_app_labels or
            obj2._meta.app_label in self.route_app_labels
        ):
            return True
        return None

    def allow_migrate(self, db, app_label, model_name=None, **hints):
        if app_label in self.route_app_labels and model_name in self.erp_models:
            return False
        return None
```

## apps\cotizador\serializers.py

- Characters: 21452
- Tokens: 0

```python
from rest_framework import serializers
from .models import (
    ProductTemplate, Cliente, Cotizacion, ProductoCotizacion,
    CotizadorImagenproducto, Kit, KitProducto
)
from .cache.models import ProductsCache
from decimal import Decimal

class EmptyStringCharField(serializers.CharField):
    def to_representation(self, value):
        if value is None:
            return ""
        return super().to_representation(value)

class EmptyStringURLField(serializers.URLField):
    def to_representation(self, value):
        if value is None:
            return ""
        return super().to_representation(value)

class ProductTemplateSerializer(serializers.ModelSerializer):
    type_name = EmptyStringCharField(source='type.name', read_only=True)
    family_name = EmptyStringCharField(source='family.name', read_only=True)
    line_name = EmptyStringCharField(source='line.name', read_only=True)
    group_name = EmptyStringCharField(source='group.name', read_only=True)
    imagen = serializers.SerializerMethodField()

    def get_imagen(self, obj):
        if hasattr(obj, '_prefetched_imagen'):
            return obj._prefetched_imagen.url if obj._prefetched_imagen else ""
            
        imagen = CotizadorImagenproducto.objects.filter(
            clave_padre=obj.reference_mask
        ).only('url').first()
        return imagen.url if imagen else ""

    class Meta:
        model = ProductTemplate
        fields = [
            'id', 
            'active', 
            'is_line', 
            'type',
            'reference_mask',
            'name',
            'type_name',
            'family_name',
            'line_name',
            'group_name',
            'imagen'
        ]

class ClienteSerializer(serializers.ModelSerializer):
    class Meta:
        model = Cliente
        fields = '__all__'

class ProductoCotizacionSerializer(serializers.ModelSerializer):
    cotizacion_uuid = serializers.UUIDField(source='cotizacion.uuid')
    cantidad = serializers.IntegerField(required=False, default=1)
    porcentaje_descuento = serializers.DecimalField(max_digits=10, decimal_places=2, required=False, default=0)
    precio_lista = serializers.DecimalField(max_digits=12, decimal_places=2, required=False, default=0)
    costo = serializers.DecimalField(max_digits=12, decimal_places=2, required=False, default=0)
    precio_descuento = serializers.DecimalField(max_digits=12, decimal_places=2, required=False, default=0)
    margen = serializers.IntegerField(required=False, default=0)
    importe = serializers.DecimalField(max_digits=12, decimal_places=2, required=False, default=0)
    clave = EmptyStringCharField(max_length=50, allow_blank=True, required=False)
    descripcion = EmptyStringCharField(max_length=255, allow_blank=True, required=False)
    imagen_url = EmptyStringCharField(allow_blank=True, required=False)
    linea = EmptyStringCharField(max_length=100, allow_blank=True, required=False)
    familia = EmptyStringCharField(max_length=100, allow_blank=True, required=False)
    grupo = EmptyStringCharField(max_length=100, allow_blank=True, required=False)
    tag = EmptyStringCharField(allow_blank=True, required=False)
    producto_id = serializers.IntegerField(required=False, allow_null=True)

    class Meta:
        model = ProductoCotizacion
        fields = [
            'id',
            'cotizacion_uuid',
            'kit_uuid',
            'es_kit',
            'especial',
            'clave',
            'descripcion',
            'imagen_url',
            'linea',
            'familia',
            'grupo',
            'tag',
            'producto_id',
            'cantidad',
            'porcentaje_descuento',
            'precio_lista',
            'costo',
            'precio_descuento',
            'margen',
            'importe'
        ]

    def create(self, validated_data):
        cotizacion_data = validated_data.pop('cotizacion')
        try:
            cotizacion = Cotizacion.objects.get(uuid=cotizacion_data['uuid'])
            validated_data['cotizacion'] = cotizacion
            return super().create(validated_data)
        except Cotizacion.DoesNotExist:
            raise serializers.ValidationError({'cotizacion_uuid': 'Cotización no encontrada'})

    def validate_porcentaje_descuento(self, value):
        if value < 0 or value > 100:
            raise serializers.ValidationError("El porcentaje de descuento debe estar entre 0 y 100")
        return value

    def validate_cantidad(self, value):
        if value <= 0:
            raise serializers.ValidationError("La cantidad debe ser mayor que 0")
        return value

class ClienteInfoSerializer(serializers.Serializer):
    cliente = serializers.CharField()
    persona_contacto = serializers.CharField()
    email_cliente = serializers.EmailField()
    telefono_cliente = serializers.CharField()

class VendedorInfoSerializer(serializers.Serializer):
    vendedor = serializers.CharField()
    email_vendedor = serializers.EmailField()
    telefono_vendedor = serializers.CharField()

class OperacionesSerializer(serializers.Serializer):
    subtotal_mobiliario = serializers.DecimalField(max_digits=12, decimal_places=2)
    total_descuento = serializers.DecimalField(max_digits=12, decimal_places=2)
    logistica = serializers.DecimalField(max_digits=12, decimal_places=2)
    iva = serializers.DecimalField(max_digits=12, decimal_places=2)
    total_general = serializers.DecimalField(max_digits=12, decimal_places=2)

class ConfiguracionPDFSerializer(serializers.Serializer):
    tiempo_entrega = serializers.CharField()
    vigencia = serializers.CharField()
    condiciones_pago = serializers.CharField()
    mostrar_clave = serializers.BooleanField()
    mostrar_precio_lista = serializers.BooleanField()
    mostrar_precio_descuento = serializers.BooleanField()
    mostrar_logistica = serializers.BooleanField()
    mostrar_descuento_total = serializers.BooleanField()

class CotizacionSerializer(serializers.ModelSerializer):
    productos = ProductoCotizacionSerializer(many=True, read_only=True)
    
    # Verificar si los campos de usuario existen en la base de datos
    from django.db import connection
    cursor = connection.cursor()
    cursor.execute(
        """SELECT column_name FROM information_schema.columns 
           WHERE table_name = 'cotizador_cotizacion' 
           AND column_name = 'usuario_creacion_id'"""
    )
    usuario_fields_exist = bool(cursor.fetchone())

    class Meta:
        model = Cotizacion
        fields = [
            'uuid',
            'folio',
            'version',
            'proyecto',
            'fecha_proyecto',
            'unidad_facturacion',
            'proyectista',
            'estatus',
            'motivo',
            'fecha_creacion',
            'fecha_modificacion',
            # Cliente info
            'cliente',
            'cliente_id',
            'persona_contacto',
            'email_cliente',
            'telefono_cliente',
            # Vendedor info
            'vendedor',
            'email_vendedor',
            'telefono_vendedor',
            # Usuario info
            'usuario_id',
            'usuario_email',
            # Operaciones
            'subtotal_mobiliario',
            'total_descuento',
            'logistica',
            'iva',
            'total_general',
            # Configuración PDF
            'tiempo_entrega',
            'vigencia',
            'condiciones_pago',
            'mostrar_clave',
            'mostrar_precio_lista',
            'mostrar_precio_descuento',
            'mostrar_logistica',
            'mostrar_descuento_total',
            # Productos
            'productos'
        ]
        
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        # Añadir campos de usuario solo si existen en la base de datos
        if self.__class__.usuario_fields_exist:
            self.fields['usuario_creacion'] = serializers.PrimaryKeyRelatedField(read_only=True)
            self.fields['usuario_envio'] = serializers.PrimaryKeyRelatedField(read_only=True)
            self.fields['usuario_aprobacion'] = serializers.PrimaryKeyRelatedField(read_only=True)
            self.fields['usuario_rechazo'] = serializers.PrimaryKeyRelatedField(read_only=True)

    def to_representation(self, instance):
        data = super().to_representation(instance)
        
        # Agrupar información del cliente
        data['cliente_info'] = {
            'cliente': data.pop('cliente'),
            'cliente_id': data.pop('cliente_id'),
            'persona_contacto': data.pop('persona_contacto'),
            'email_cliente': data.pop('email_cliente'),
            'telefono_cliente': data.pop('telefono_cliente')
        }
        
        # Agrupar información del vendedor
        data['vendedor_info'] = {
            'vendedor': data.pop('vendedor'),
            'email_vendedor': data.pop('email_vendedor'),
            'telefono_vendedor': data.pop('telefono_vendedor')
        }
        
        # Agrupar operaciones
        data['operaciones'] = {
            'subtotal_mobiliario': data.pop('subtotal_mobiliario'),
            'total_descuento': data.pop('total_descuento'),
            'logistica': data.pop('logistica'),
            'iva': data.pop('iva'),
            'total_general': data.pop('total_general')
        }
        
        # Agrupar configuración PDF
        data['configuracion_pdf'] = {
            'tiempo_entrega': data.pop('tiempo_entrega'),
            'vigencia': data.pop('vigencia'),
            'condiciones_pago': data.pop('condiciones_pago'),
            'mostrar_clave': data.pop('mostrar_clave'),
            'mostrar_precio_lista': data.pop('mostrar_precio_lista'),
            'mostrar_precio_descuento': data.pop('mostrar_precio_descuento'),
            'mostrar_logistica': data.pop('mostrar_logistica'),
            'mostrar_descuento_total': data.pop('mostrar_descuento_total')
        }
        
        # Agrupar información del usuario
        data['usuario_info'] = {
            'usuario_id': data.pop('usuario_id'),
            'usuario_email': data.pop('usuario_email')
        }
        
        return data

    def create(self, validated_data):
        # Manejar campos que pueden venir en la solicitud pero no en validated_data
        request = self.context.get('request')
        if request and hasattr(request, 'data'):
            # Manejar cliente_id
            if 'cliente_id' in request.data:
                validated_data['cliente_id'] = request.data.get('cliente_id')
            
            # Manejar usuario_id y usuario_email
            if 'usuario_id' in request.data:
                validated_data['usuario_id'] = request.data.get('usuario_id')
            if 'usuario_email' in request.data:
                validated_data['usuario_email'] = request.data.get('usuario_email')
            
        instance = Cotizacion.objects.create(**validated_data)
        return instance

    def update(self, instance, validated_data):
        # Manejar campos que pueden venir en la solicitud pero no en validated_data
        request = self.context.get('request')
        if request and hasattr(request, 'data'):
            # Manejar cliente_id
            if 'cliente_id' in request.data:
                validated_data['cliente_id'] = request.data.get('cliente_id')
            
            # Manejar usuario_id y usuario_email
            if 'usuario_id' in request.data:
                validated_data['usuario_id'] = request.data.get('usuario_id')
            if 'usuario_email' in request.data:
                validated_data['usuario_email'] = request.data.get('usuario_email')
            
        return super().update(instance, validated_data)

class CotizadorImagenproductoSerializer(serializers.ModelSerializer):
    clave_padre = EmptyStringCharField(max_length=255)
    url = EmptyStringURLField()

    class Meta:
        model = CotizadorImagenproducto
        fields = ['id', 'clave_padre', 'url']

class KitProductoSerializer(serializers.ModelSerializer):
    """Serializer para el modelo KitProducto"""
    producto_nombre = serializers.SerializerMethodField()
    producto_imagen = serializers.SerializerMethodField()
    
    class Meta:
        model = KitProducto
        fields = [
            'id', 'kit', 'clave', 'cantidad', 'porcentaje_descuento',
            'precio_lista', 'costo', 'precio_descuento', 'importe',
            'orden', 'producto_nombre', 'producto_imagen',
            'descripcion', 'linea', 'familia', 'grupo', 'producto_id'
        ]
    
    def get_producto_nombre(self, obj):
        return obj.get_producto_nombre()
    
    def get_producto_imagen(self, obj):
        return obj.get_producto_imagen()

class KitProductoCreateUpdateSerializer(serializers.ModelSerializer):
    """Serializer para crear o actualizar un KitProducto"""
    class Meta:
        model = KitProducto
        fields = [
            'orden','clave', 'cantidad', 'porcentaje_descuento',
            'precio_lista', 'costo', 'importe','descripcion', 'linea', 'familia', 'grupo', 'mostrar_en_kit','es_opcional', 'producto_id' 
        ]
        read_only_fields = ['precio_descuento', 'importe']

class KitSerializer(serializers.ModelSerializer):
    """
    Serializer para el modelo Kit.
    """
    productos = KitProductoSerializer(many=True, read_only=True)
    creado_por_nombre = serializers.SerializerMethodField()
    
    class Meta:
        model = Kit
        fields = [
            'id', 'uuid', 'nombre', 'descripcion', 'imagen_url', 'cantidad',
            'valor_unitario', 'costo_unitario', 'porcentaje_descuento',
            'valor_unitario_con_descuento', 'creado_por', 'creado_por_nombre',
            'productos'
        ]
    
    def get_creado_por_nombre(self, obj):
        """
        Obtiene el nombre del usuario que creó el kit
        """
        if obj.creado_por:
            return f"{obj.creado_por.first_name} {obj.creado_por.last_name}".strip() or obj.creado_por.username
        return None


class KitCreateUpdateSerializer(serializers.ModelSerializer):
    """
    Serializer para crear y actualizar kits sin incluir los productos.
    """
    class Meta:
        model = Kit
        fields = [
            'uuid', 'nombre', 'descripcion', 'imagen_url', 'cantidad',
            'valor_unitario', 'costo_unitario', 'porcentaje_descuento',
            'valor_unitario_con_descuento'
        ]
        extra_kwargs = {
            'uuid': {'read_only': True},
            'nombre': {'required': True},
            'descripcion': {'required': False},
            'imagen_url': {'required': False},
            'cantidad': {'required': False, 'default': 1},
            'valor_unitario': {'required': False, 'default': 0},
            'costo_unitario': {'required': False, 'default': 0},
            'porcentaje_descuento': {'required': False, 'default': 0},
            'valor_unitario_con_descuento': {'required': False, 'default': 0}
        }
    
    def create(self, validated_data):
        # Asignar el usuario actual como creador del kit
        user = self.context['request'].user
        validated_data['creado_por'] = user
        return super().create(validated_data)
        
    def update(self, instance, validated_data):
        # Asegurarse de que el UUID no se modifique durante la actualización
        # y que todos los campos se actualicen correctamente
        instance.nombre = validated_data.get('nombre', instance.nombre)
        instance.descripcion = validated_data.get('descripcion', instance.descripcion)
        instance.imagen_url = validated_data.get('imagen_url', instance.imagen_url)
        instance.cantidad = validated_data.get('cantidad', instance.cantidad)
        instance.valor_unitario = validated_data.get('valor_unitario', instance.valor_unitario)
        instance.costo_unitario = validated_data.get('costo_unitario', instance.costo_unitario)
        instance.porcentaje_descuento = validated_data.get('porcentaje_descuento', instance.porcentaje_descuento)
        instance.valor_unitario_con_descuento = validated_data.get('valor_unitario_con_descuento', instance.valor_unitario_con_descuento)
        
        instance.save()
        return instance


class ApplyKitToCotizacionSerializer(serializers.Serializer):
    """
    Serializer para aplicar un kit a una cotización.
    Permite especificar valores personalizados para el kit en la cotización.
    """
    kit_uuid = serializers.UUIDField(
        required=True,
        help_text="UUID del kit a aplicar"
    )
    mostrar_productos_individuales = serializers.BooleanField(
        default=True,
        help_text="Si es True, muestra los productos individuales del kit en la cotización"
    )
    porcentaje_descuento_adicional = serializers.DecimalField(
        max_digits=10,
        decimal_places=2,
        default=0,
        min_value=0,
        max_value=100,
        help_text="Porcentaje de descuento adicional a aplicar al kit completo"
    )
    # Campos opcionales para personalizar el kit en la cotización
    cantidad = serializers.IntegerField(
        required=False,
        min_value=1,
        help_text="Cantidad personalizada del kit para esta cotización"
    )
    valor_unitario = serializers.DecimalField(
        max_digits=12,
        decimal_places=2,
        required=False,
        min_value=0,
        help_text="Valor unitario personalizado del kit para esta cotización"
    )
    costo_unitario = serializers.DecimalField(
        max_digits=12,
        decimal_places=2,
        required=False,
        min_value=0,
        help_text="Costo unitario personalizado del kit para esta cotización"
    )
    porcentaje_descuento = serializers.DecimalField(
        max_digits=10,
        decimal_places=2,
        required=False,
        min_value=0,
        max_value=100,
        help_text="Porcentaje de descuento personalizado del kit para esta cotización"
    )
    valor_unitario_con_descuento = serializers.DecimalField(
        max_digits=12,
        decimal_places=2,
        required=False,
        min_value=0,
        help_text="Valor unitario con descuento personalizado del kit para esta cotización"
    )

    def validate_kit_uuid(self, value):
        """
        Valida que el kit exista.
        """
        try:
            Kit.objects.get(uuid=value)
            return value
        except Kit.DoesNotExist:
            raise serializers.ValidationError("El kit especificado no existe.")


class KitImageUploadSerializer(serializers.Serializer):
    """
    Serializer para la carga de imágenes de kits.
    """
    image = serializers.ImageField(
        help_text="Archivo de imagen a cargar",
        required=True
    )
    
    def validate_image(self, value):
        """
        Validar que el archivo sea una imagen y tenga un tamaño adecuado.
        """
        # Verificar el tipo de archivo
        if not value.content_type.startswith('image/'):
            raise serializers.ValidationError(
                "El archivo debe ser una imagen (JPEG, PNG, etc.)"
            )
        
        # Verificar el tamaño (máximo 5MB)
        if value.size > 5 * 1024 * 1024:
            raise serializers.ValidationError(
                "El tamaño de la imagen no debe exceder 5MB"
            )
        
        return value

class OrderLineItemSerializer(serializers.Serializer):
    """
    Serializer para los items de línea de una orden.
    """
    product_id = serializers.IntegerField(required=True)
    product_uom_qty = serializers.IntegerField(required=True)
    price_unit = serializers.DecimalField(max_digits=12, decimal_places=2, required=True)

class CreateOrderSerializer(serializers.Serializer):
    """
    Serializer para crear órdenes en Odoo.
    """
    partner_id = serializers.IntegerField(required=True)
    client_order_ref = serializers.CharField(required=True)
    priority = serializers.CharField(required=False, default="replenishment")
    manufacture = serializers.CharField(required=False, default="replenishment")
    products = serializers.ListField(
        child=OrderLineItemSerializer(),
        required=True
    )
    
    def validate_products(self, value):
        """
        Valida que haya al menos un producto en la lista.
        """
        if not value:
            raise serializers.ValidationError("Debe proporcionar al menos un producto")
        return value
    
    def to_odoo_format(self):
        """
        Convierte el formato simplificado al formato que espera Odoo.
        """
        data = self.validated_data.copy()
        products = data.pop('products')
        
        # Convertir la lista de productos al formato que espera Odoo [0, 0, {...}]
        order_line = []
        for product in products:
            order_line.append([0, 0, {
                'product_id': product['product_id'],
                'product_uom_qty': product['product_uom_qty'],
                'price_unit': product['price_unit']
            }])
        
        # Asegurarse de que todos los campos necesarios estén presentes
        result = {
            'partner_id': data['partner_id'],
            'client_order_ref': data['client_order_ref'],
            'priority': data.get('priority', 'replenishment'),
            'manufacture': data.get('manufacture', 'replenishment'),
            'order_line': order_line
        }
        
        return result
```

## apps\cotizador\services.py

- Characters: 2981
- Tokens: 0

```python
import requests
from typing import Dict, Any
from django.conf import settings
import json
from decimal import Decimal

# Clase para serializar Decimal a float
class DecimalEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, Decimal):
            return float(obj)
        return super(DecimalEncoder, self).default(obj)

class OdooService:
    def __init__(self, url=None):
        # Endpoint REST para crear órdenes
        self.order_endpoint = url or settings.ODOO_ENDPOINT
        self.login = settings.ODOO_LOGIN
        self.password = settings.ODOO_PASSWORD
        self.api_key = settings.ODOO_API_KEY
    
    def create_sales_order(self, order_data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Crear una orden de venta en Odoo usando el endpoint REST específico
        
        Args:
            order_data: Diccionario con los datos de la orden en formato Odoo
                
        Returns:
            Diccionario con la información de la orden creada
        """
        try:
            # Preparar el payload en el formato específico requerido por el endpoint
            payload = {
                "fields": ["name", "partner_id", "client_order_ref", "priority", "order_line"],
                "values": order_data
            }
            
            print("\n===== PAYLOAD ENVIADO A ODOO =====")
            print(json.dumps(payload, indent=4, cls=DecimalEncoder))
            print("====================================\n")
            
            # Convertir el payload a JSON usando el encoder personalizado
            payload_json = json.dumps(payload, cls=DecimalEncoder)
            
            # Preparar los headers con las credenciales
            headers = {
                'Content-Type': 'application/json',
                'login': self.login,
                'password': self.password,
                'api_key': self.api_key
            }
            
            # Realizar la petición POST al endpoint
            response = requests.post(
                self.order_endpoint, 
                data=payload_json,
                headers=headers
            )
            
            print("\n===== RESPUESTA DE ODOO =====")
            print(f"Status code: {response.status_code}")
            print(f"Response: {response.text}")
            print("===============================\n")
            
            # Verificar si la petición fue exitosa
            response.raise_for_status()
            
            # Procesar la respuesta
            result = response.json()
            
            return result
            
        except requests.exceptions.RequestException as e:
            print(f"Error en la petición HTTP: {str(e)}")
            raise Exception(f"Error al crear orden de venta en Odoo: {str(e)}")
        except Exception as e:
            print(f"Error inesperado: {str(e)}")
            raise Exception(f"Error inesperado al crear orden de venta en Odoo: {str(e)}")
```

## apps\cotizador\tests.py

- Characters: 59
- Tokens: 0

```python
from django.test import TestCase

# Create your tests here.
```

## apps\cotizador\urls.py

- Characters: 1009
- Tokens: 0

```python
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import (
    CotizacionViewSet,
    ProductoCotizacionViewSet,
    CotizadorImagenproductoViewSet,
    KitViewSet,
    KitProductoViewSet,
    SyncViewSet
)

# Crear dos routers, uno con slash y otro sin slash
router_no_slash = DefaultRouter(trailing_slash=False)
router_with_slash = DefaultRouter(trailing_slash=True)

# Registrar las vistas en ambos routers
for router in [router_no_slash, router_with_slash]:
    router.register(r'cotizaciones', CotizacionViewSet)
    router.register(r'productos-cotizacion', ProductoCotizacionViewSet)
    router.register(r'imagenes-producto', CotizadorImagenproductoViewSet)
    router.register(r'kits', KitViewSet)
    router.register(r'kit-productos', KitProductoViewSet)
    router.register(r'sync', SyncViewSet, basename='sync')

urlpatterns = [
    # Incluir ambos routers
    path('', include(router_no_slash.urls)),
    path('', include(router_with_slash.urls)),
]
```

## apps\cotizador\utils\storage.py

- Characters: 2733
- Tokens: 0

```python
"""
Utilidades para manejar la subida de archivos a Supabase Storage.
"""

import os
import requests
from datetime import datetime
from .supabase_config import SUPABASE_URL, SUPABASE_KEY, BUCKET_NAME, get_public_url

def upload_file_to_supabase(file_path, object_name=None):
    """
    Sube un archivo a Supabase Storage.
    
    Args:
        file_path (str): Ruta local al archivo
        object_name (str, optional): Nombre del objeto en el bucket. 
                                   Si no se proporciona, se generará uno basado en el nombre del archivo.
    
    Returns:
        tuple: (URL pública si el archivo se subió correctamente, None si hubo un error),
               (None si se subió correctamente, mensaje de error si hubo un error)
    """
    if not os.path.exists(file_path):
        return None, f"El archivo {file_path} no existe"

    # Si no se proporciona un nombre de objeto, genera uno basado en la fecha y el nombre original
    if not object_name:
        file_name = os.path.basename(file_path)
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        object_name = f"{timestamp}_{file_name}"

    # Prepara los headers para la solicitud
    headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': f'Bearer {SUPABASE_KEY}',
        'Content-Type': 'application/octet-stream'
    }

    # URL para la subida
    upload_url = f"{SUPABASE_URL}/storage/v1/object/{BUCKET_NAME}/{object_name}"

    try:
        with open(file_path, 'rb') as f:
            response = requests.post(upload_url, headers=headers, data=f)
        
        if response.status_code == 200:
            return get_public_url(object_name), None
        else:
            return None, f"Error al subir el archivo: {response.text}"
    
    except Exception as e:
        return None, f"Error durante la subida: {str(e)}"

def delete_file_from_supabase(object_name):
    """
    Elimina un archivo de Supabase Storage.
    
    Args:
        object_name (str): Nombre del objeto en el bucket
    
    Returns:
        tuple: (True si se eliminó correctamente, False si hubo un error),
               (None si se eliminó correctamente, mensaje de error si hubo un error)
    """
    headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': f'Bearer {SUPABASE_KEY}'
    }

    delete_url = f"{SUPABASE_URL}/storage/v1/object/{BUCKET_NAME}/{object_name}"

    try:
        response = requests.delete(delete_url, headers=headers)
        
        if response.status_code in [200, 204]:
            return True, None
        else:
            return False, f"Error al eliminar el archivo: {response.text}"
    
    except Exception as e:
        return False, f"Error durante la eliminación: {str(e)}"
```

## apps\cotizador\utils\upload_helpers.py

- Characters: 13530
- Tokens: 0

```python
"""
Utilidades para manejar la subida de imágenes de productos a Supabase Storage.
"""

import os
import uuid
import tempfile
import re
from django.conf import settings
from datetime import datetime
import requests
import json
from supabase import create_client, Client

def upload_image_to_supabase(image_file, line_name, reference_mask):
    """
    Sube una imagen a Supabase Storage en una carpeta organizada por línea de producto.
    
    Args:
        image_file: Archivo de imagen (InMemoryUploadedFile)
        line_name: Nombre de la línea del producto
        reference_mask: Identificador único del producto
    
    Returns:
        tuple: (URL pública si la imagen se subió correctamente, None si hubo un error),
               (None si se subió correctamente, mensaje de error si hubo un error)
    """
    # Normalizar el nombre de la línea para usarlo como carpeta
    # Extraer solo la parte principal antes de paréntesis o caracteres especiales
    if line_name:
        # Eliminar espacios al inicio y final
        clean_line_name = line_name.strip()
        
        # Extraer la parte antes del primer paréntesis, guion o cualquier otro separador común
        match = re.match(r'^([^(|\-|–|,]+)', clean_line_name)
        if match:
            folder_name = match.group(1).strip()
        else:
            folder_name = clean_line_name
    else:
        folder_name = "otros"
    
    # Obtener la extensión del archivo
    file_extension = os.path.splitext(image_file.name)[1].lower()
    
    # Construir la ruta del objeto en Supabase Storage
    # Formato: Imagenes/[nombre_linea]/[reference_mask].[extension]
    storage_path = f"Imagenes/{folder_name}/{reference_mask}{file_extension}"
    
    # Guardar temporalmente el archivo
    with tempfile.NamedTemporaryFile(delete=False, suffix=file_extension) as temp_file:
        for chunk in image_file.chunks():
            temp_file.write(chunk)
        temp_file_path = temp_file.name
    
    try:
        # Inicializar el cliente de Supabase
        supabase: Client = create_client(
            settings.SUPABASE_URL,
            settings.SUPABASE_KEY
        )
        
        # Nombre del bucket en Supabase Storage
        bucket_name = 'imagenes-productos'
        
        try:
            # Primero intentamos usar el SDK para subir el archivo
            with open(temp_file_path, 'rb') as f:
                file_content = f.read()
                result = supabase.storage.from_(bucket_name).upload(
                    path=storage_path,
                    file=file_content,
                    file_options={
                        "content-type": image_file.content_type,
                        "upsert": "true"
                    }
                )
        except Exception as sdk_error:
            # Si falla el SDK, intentamos con la API REST directa
            print(f"Error con SDK: {str(sdk_error)}. Intentando con API REST...")
            
            with open(temp_file_path, 'rb') as f:
                file_content = f.read()
                
                # URL para subir archivos a Supabase Storage
                upload_url = f"{settings.SUPABASE_URL}/storage/v1/object/{bucket_name}/{storage_path}"
                
                # Cabeceras de la solicitud con token de servicio si está disponible
                headers = {
                    "Authorization": f"Bearer {getattr(settings, 'SUPABASE_SERVICE_KEY', settings.SUPABASE_KEY)}",
                    "Content-Type": image_file.content_type,
                    "x-upsert": "true"  # Para sobrescribir si ya existe
                }
                
                # Realizar la solicitud POST
                response = requests.post(
                    upload_url,
                    headers=headers,
                    data=file_content
                )
                
                # Verificar si la solicitud fue exitosa
                if response.status_code not in (200, 201):
                    raise Exception(f"Error en la API de Supabase: {response.text}")
        
        # Eliminar el archivo temporal
        os.unlink(temp_file_path)
        
        # Construir la URL pública
        public_url = supabase.storage.from_(bucket_name).get_public_url(storage_path)
        
        return public_url, None
    
    except Exception as e:
        # Asegurarse de eliminar el archivo temporal en caso de error
        if os.path.exists(temp_file_path):
            os.unlink(temp_file_path)
        return None, f"Error durante la subida: {str(e)}"


def upload_kit_image_to_supabase(image_file, kit_uuid):
    """
    Sube una imagen de un kit a Supabase Storage.
    
    Args:
        image_file: Archivo de imagen (InMemoryUploadedFile)
        kit_uuid: UUID del kit
    
    Returns:
        tuple: (URL pública si la imagen se subió correctamente, None si hubo un error),
               (None si se subió correctamente, mensaje de error si hubo un error),
               (Ruta de almacenamiento en Supabase si se subió correctamente, None si hubo un error)
    """
    # Obtener la extensión del archivo
    file_extension = os.path.splitext(image_file.name)[1].lower()
    
    # Construir la ruta del objeto en Supabase Storage
    # Formato: Imagenes/kits/[kit_uuid].[extension]
    storage_path = f"Imagenes/kits/{kit_uuid}{file_extension}"
    
    # Guardar temporalmente el archivo
    with tempfile.NamedTemporaryFile(delete=False, suffix=file_extension) as temp_file:
        for chunk in image_file.chunks():
            temp_file.write(chunk)
        temp_file_path = temp_file.name
    
    try:
        # Inicializar el cliente de Supabase
        supabase: Client = create_client(
            settings.SUPABASE_URL,
            settings.SUPABASE_KEY
        )
        
        # Nombre del bucket en Supabase Storage
        bucket_name = 'imagenes-kits'
        
        try:
            # Primero intentamos usar el SDK para subir el archivo
            with open(temp_file_path, 'rb') as f:
                file_content = f.read()
                result = supabase.storage.from_(bucket_name).upload(
                    path=storage_path,
                    file=file_content,
                    file_options={
                        "content-type": image_file.content_type,
                        "upsert": "true"
                    }
                )
        except Exception as sdk_error:
            # Si falla el SDK, intentamos con la API REST directa
            print(f"Error con SDK: {str(sdk_error)}. Intentando con API REST...")
            
            with open(temp_file_path, 'rb') as f:
                file_content = f.read()
                
                # URL para subir archivos a Supabase Storage
                upload_url = f"{settings.SUPABASE_URL}/storage/v1/object/{bucket_name}/{storage_path}"
                
                # Cabeceras de la solicitud con token de servicio si está disponible
                headers = {
                    "Authorization": f"Bearer {getattr(settings, 'SUPABASE_SERVICE_KEY', settings.SUPABASE_KEY)}",
                    "Content-Type": image_file.content_type,
                    "x-upsert": "true"  # Para sobrescribir si ya existe
                }
                
                # Realizar la solicitud POST
                response = requests.post(
                    upload_url,
                    headers=headers,
                    data=file_content
                )
                
                # Verificar si la solicitud fue exitosa
                if response.status_code not in (200, 201):
                    raise Exception(f"Error en la API de Supabase: {response.text}")
        
        # Eliminar el archivo temporal
        os.unlink(temp_file_path)
        
        # Construir la URL pública
        public_url = supabase.storage.from_(bucket_name).get_public_url(storage_path)
        
        return public_url, None, storage_path
    
    except Exception as e:
        # Asegurarse de eliminar el archivo temporal en caso de error
        if os.path.exists(temp_file_path):
            os.unlink(temp_file_path)
        return None, f"Error durante la subida: {str(e)}", None


def upload_kit_image_without_uuid(image_file):
    """
    Sube una imagen de un kit a Supabase Storage sin requerir UUID.
    Genera un nombre único basado en timestamp y hash.
    
    Args:
        image_file: Archivo de imagen (InMemoryUploadedFile)
    
    Returns:
        tuple: (URL pública si la imagen se subió correctamente, None si hubo un error),
               (None si se subió correctamente, mensaje de error si hubo un error),
               (Ruta de almacenamiento en Supabase si se subió correctamente, None si hubo un error)
    """
    try:
        print("DEBUG: Iniciando upload_kit_image_without_uuid")
        # Obtener la extensión del archivo
        file_extension = os.path.splitext(image_file.name)[1].lower()
        print(f"DEBUG: Extensión del archivo: {file_extension}")
        
        # Generar un nombre único basado en timestamp y hash del contenido
        import time
        import hashlib
        timestamp = int(time.time() * 1000)
        print(f"DEBUG: Timestamp: {timestamp}")
        
        # Crear un hash del nombre del archivo y los primeros bytes para mayor unicidad
        hasher = hashlib.md5()
        print(f"DEBUG: Tipo de image_file.name: {type(image_file.name)}")
        hasher.update(image_file.name.encode())
        
        # Leer los primeros bytes del archivo para el hash sin consumir todo el archivo
        image_file.seek(0)
        print("DEBUG: Leyendo primeros bytes del archivo")
        content_sample = image_file.read(1024)  # Leer solo los primeros 1024 bytes
        print(f"DEBUG: Tipo de content_sample: {type(content_sample)}")
        image_file.seek(0)  # Volver al inicio del archivo
        
        # Asegurarse de que content_sample sea bytes antes de pasarlo a hasher.update
        if isinstance(content_sample, bytes):
            print("DEBUG: content_sample es bytes")
            hasher.update(content_sample)
        elif isinstance(content_sample, str):
            print("DEBUG: content_sample es string")
            hasher.update(content_sample.encode())
        elif content_sample is not None:
            print(f"DEBUG: content_sample es otro tipo: {type(content_sample)}")
            # Convertir a string y luego a bytes
            str_content = str(content_sample)
            print(f"DEBUG: str_content: {str_content[:50]}... (truncado)")
            hasher.update(str_content.encode())
        else:
            print("DEBUG: content_sample es None")
        
        file_hash = hasher.hexdigest()[:10]  # Usar solo los primeros 10 caracteres del hash
        print(f"DEBUG: Hash generado: {file_hash}")
        
        # Construir un nombre de archivo único
        unique_filename = f"kit_{timestamp}_{file_hash}{file_extension}"
        print(f"DEBUG: Nombre de archivo único: {unique_filename}")
        
        # Construir la ruta del objeto en Supabase Storage
        # Formato: Imagenes/kits/[unique_filename]
        storage_path = f"Imagenes/kits/{unique_filename}"
        print(f"DEBUG: Ruta de almacenamiento: {storage_path}")
        
        # Guardar temporalmente el archivo
        with tempfile.NamedTemporaryFile(delete=False, suffix=file_extension) as temp_file:
            for chunk in image_file.chunks():
                temp_file.write(chunk)
            temp_file_path = temp_file.name
        print(f"DEBUG: Archivo temporal creado en: {temp_file_path}")
        
        # Inicializar el cliente de Supabase
        print("DEBUG: Inicializando cliente de Supabase")
        supabase: Client = create_client(
            settings.SUPABASE_URL,
            settings.SUPABASE_KEY
        )
        
        # Nombre del bucket en Supabase Storage
        bucket_name = 'imagenes-kits'
        print(f"DEBUG: Usando bucket: {bucket_name}")
        
        # Subir el archivo a Supabase Storage
        print("DEBUG: Abriendo archivo para subir")
        with open(temp_file_path, 'rb') as f:
            file_content = f.read()
            print(f"DEBUG: Tamaño del archivo: {len(file_content)} bytes")
            print("DEBUG: Subiendo archivo a Supabase")
            supabase.storage.from_(bucket_name).upload(
                path=storage_path,
                file=file_content,
                file_options={
                    "content-type": image_file.content_type,
                    "upsert": "true"
                }
            )
        
        # Construir la URL pública
        print("DEBUG: Obteniendo URL pública")
        public_url = supabase.storage.from_(bucket_name).get_public_url(storage_path)
        print(f"DEBUG: URL pública: {public_url}")
        
        return public_url, None, storage_path
    
    except Exception as e:
        import traceback
        print(f"DEBUG: Error en upload_kit_image_without_uuid: {str(e)}")
        print(f"DEBUG: Traceback: {traceback.format_exc()}")
        # Asegurarse de eliminar el archivo temporal en caso de error
        if 'temp_file_path' in locals() and os.path.exists(temp_file_path):
            os.unlink(temp_file_path)
        return None, str(e), None
    
    finally:
        # Eliminar el archivo temporal
        if 'temp_file_path' in locals() and os.path.exists(temp_file_path):
            print("DEBUG: Eliminando archivo temporal")
            os.unlink(temp_file_path)
```

## apps\cotizador\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## apps\__init__.py

- Characters: 0
- Tokens: 0

```python

```

## app_manager\asgi.py

- Characters: 398
- Tokens: 0

```python
"""
ASGI config for app_manager project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.0/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'app_manager.settings')

application = get_asgi_application()
```

## app_manager\celery.py

- Characters: 632
- Tokens: 0

```python
import os
from celery import Celery
from celery.schedules import crontab

# Establecer la configuración de Django por defecto
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'app_manager.settings')

app = Celery('app_manager')

# Usar la configuración de Django
app.config_from_object('django.conf:settings', namespace='CELERY')

# Cargar tareas automáticamente
app.autodiscover_tasks()

# Configurar tareas periódicas
app.conf.beat_schedule = {
    'sync-products-monday-8am': {
        'task': 'apps.cotizador.cache.tasks.sync_products_task',
        'schedule': crontab(hour=8, minute=0, day_of_week=0),  # Lunes 8:00 AM
    },
}
```

## app_manager\routers.py

- Characters: 829
- Tokens: 0

```python
class DatabaseRouter:
    """
    Router para manejar las consultas a múltiples bases de datos.
    """
    def db_for_read(self, model, **hints):
        if model._meta.app_label == 'cotizador' and model._meta.db_table == 'product_template':
            return 'erp-portalgebesa-com'
        return 'default'

    def db_for_write(self, model, **hints):
        if model._meta.app_label == 'cotizador' and model._meta.db_table == 'product_template':
            return None  # No permitir escrituras en la base de datos ERP
        return 'default'

    def allow_relation(self, obj1, obj2, **hints):
        return True

    def allow_migrate(self, db, app_label, model_name=None, **hints):
        if db == 'erp-portalgebesa-com':
            return False  # No realizar migraciones en la base de datos ERP
        return True
```

## app_manager\urls.py

- Characters: 565
- Tokens: 0

```python
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    
    # API v1 URLs
    path('api/v1/', include([
        path('accounts/', include('apps.accounts.urls_api')),
        path('cotizador/', include([
            path('productos/', include('apps.cotizador.cache.urls')),  # URLs de productos en caché
            path('', include('apps.cotizador.urls')),  # Otras URLs del cotizador
        ])),
    ])),
    
    # URLs de templates
    path('accounts/', include('apps.accounts.urls')),
]
```

## app_manager\wsgi.py

- Characters: 398
- Tokens: 0

```python
"""
WSGI config for app_manager project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.0/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'app_manager.settings')

application = get_wsgi_application()
```

## app_manager\__init__.py

- Characters: 120
- Tokens: 0

```python
# from .celery import app as celery_app

# __all__ = ('celery_app',)

# Comentado temporalmente para ejecutar sin Celery
```

## GETTING_STARTED.md

- Characters: 3344
- Tokens: 0

````markdown
# Getting Started - Backend App Manager

## Requisitos Previos

- Python 3.10 o superior
- PostgreSQL 14 o superior
- pip (gestor de paquetes de Python)
- virtualenv o venv

## Estructura del Proyecto

```
back-app-manager/
├── app_manager/         # Configuración principal del proyecto
├── apps/               # Aplicaciones del sistema
├── manage.py          # Script de gestión de Django
├── requirements.txt   # Dependencias del proyecto
└── .env              # Variables de entorno (crear desde ejemplo)
```

## Configuración Inicial

1. **Clonar el Repositorio**
   ```bash
   git clone [URL_DEL_REPOSITORIO]
   cd back-app-manager
   ```

2. **Crear y Activar Entorno Virtual**
   ```bash
   python -m venv venv
   source venv/bin/activate  # En Windows: venv\Scripts\activate
   ```

3. **Instalar Dependencias**
   ```bash
   pip install -r requirements.txt
   ```

4. **Configurar Variables de Entorno**
   - Copiar el archivo `.env.example` a `.env`
   - Configurar las siguientes variables:
     - `DATABASE_URL`: URL de conexión a PostgreSQL
     - `SECRET_KEY`: Clave secreta de Django
     - `DEBUG`: True/False según el entorno
     - `ALLOWED_HOSTS`: Hosts permitidos
     - `CORS_ALLOWED_ORIGINS`: Orígenes permitidos para CORS

5. **Ejecutar Migraciones**
   ```bash
   python manage.py migrate
   ```

6. **Crear Superusuario**
   ```bash
   python manage.py createsuperuser
   ```

7. **Iniciar el Servidor de Desarrollo**
   ```bash
   python manage.py runserver
   ```

## Puntos Clave del Sistema

### 1. Sistema de Autenticación
- Basado en email en lugar de username
- Tokens JWT para autenticación de API
- Roles y permisos específicos por área

### 2. Estructura de Permisos
- Roles predefinidos:
  - Administrador
  - Manager
  - Vendedor
  - Backoffice
  - Marketing
- Permisos por área y unidad de negocio

### 3. APIs Principales
- `/api/auth/`: Endpoints de autenticación
- `/api/users/`: Gestión de usuarios
- `/api/quotations/`: Sistema de cotizaciones
- `/api/catalog/`: Catálogos del sistema

### 4. Validaciones del Sistema
- Validación de áreas permitidas
- Validación de unidades de negocio
- Validación de razones sociales
- Validaciones específicas por módulo

## Guías de Desarrollo

### 1. Crear Nueva Aplicación
```bash
python manage.py startapp [nombre_app] apps/[nombre_app]
```

### 2. Agregar Nuevos Modelos
1. Crear modelo en `apps/[nombre_app]/models.py`
2. Registrar en `apps/[nombre_app]/admin.py`
3. Crear migraciones: `python manage.py makemigrations`
4. Aplicar migraciones: `python manage.py migrate`

### 3. Crear Nuevos Endpoints
1. Definir serializers en `apps/[nombre_app]/serializers.py`
2. Crear viewsets en `apps/[nombre_app]/views.py`
3. Registrar URLs en `apps/[nombre_app]/urls.py`

## Pruebas
```bash
python manage.py test
```

## Comandos Útiles
```bash
# Crear migraciones
python manage.py makemigrations

# Aplicar migraciones
python manage.py migrate

# Crear superusuario
python manage.py createsuperuser

# Recolectar archivos estáticos
python manage.py collectstatic

# Shell de Django
python manage.py shell
```

## Recursos Adicionales
- [Documentación de Django](https://docs.djangoproject.com/)
- [Documentación de Django REST Framework](https://www.django-rest-framework.org/)
- [Guía de Estilo de Código Python (PEP 8)](https://www.python.org/dev/peps/pep-0008/)
````

## manage.py

- Characters: 666
- Tokens: 0

```python
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'app_manager.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
```

## README.md

- Characters: 18165
- Tokens: 0

````markdown
# APP-MANAGER

Sistema de gestión empresarial desarrollado con Django 5.0.1 y Django REST Framework.

## Descripción

APP-MANAGER es una aplicación web robusta diseñada para la gestión empresarial, que incluye módulos para manejo de cuentas de usuario, funcionalidades core del negocio y un sistema de cotizaciones.

## Características Principales

### Sistema de Usuarios y Permisos

#### Modelo de Usuario
- Autenticación basada en email
- Campos personalizados:
  - Información personal (nombre, apellido, teléfono)
  - Área (RH, Ventas, Compras, Producción, TI)
  - Unidad (CDMX, Querétaro, Laguna, Monterrey, SPL, Guadalajara)
  - Razón Social (GEBESA NACIONAL, OPERADORA DE SUCURSALES GEBESA, SALMON DE LA LAGUNA)
- Validaciones automáticas:
  - Correspondencia entre unidad y razón social
  - Validación de áreas permitidas
  - Restricciones por rol y unidad

#### Sistema de Permisos
- Roles definidos:
  - Administrador: Acceso total al sistema
  - Manager: Gestión de cotizaciones globales
  - Vendedor: Creación y visualización de cotizaciones propias
  - Backoffice: Edición y procesamiento de cotizaciones
  - Marketing: Gestión de contenido multimedia
- Permisos por área:
  - Ventas: Acceso al módulo de cotizaciones
  - Otras áreas: Permisos específicos por módulo
- Validaciones de unidad y razón social:
  - Restricción de acceso por unidad asignada
  - Validación de razón social correspondiente

### Módulo de Cotizaciones

#### Características
- Generación automática de folios por año (formato: COT-YYYY-XXXX)
- Validación de unidad de facturación
- Cálculo automático de precios y descuentos usando Decimal para precisión financiera
- Historial de modificaciones
- Soporte para productos y servicios
- Manejo de descuentos por producto
- Creación de bundles de productos
- Cálculo automático de subtotal, IVA y total
- Gestión de imágenes de productos
- Creación de cotizaciones en un solo paso (incluye productos)

#### Permisos Específicos
- Creación: Solo roles Manager y Vendedor del área de Ventas
- Visualización: 
  - Manager: Todas las cotizaciones del sistema
  - Vendedor: Solo sus propias cotizaciones
- Edición: Solo Backoffice, Managers y Administradores

#### API Endpoints de Cotizaciones
```
GET /api/v1/cotizador/cotizaciones/
- Listar cotizaciones
- Filtros: cliente, estado, fecha, folio
- Búsqueda: folio, cliente, proyecto, razón social, RFC
- Ordenamiento: created_at, updated_at, folio_cotizacion
- Paginación incluida

POST /api/v1/cotizador/cotizaciones/
- Crear nueva cotización
- Permite crear productos en el mismo request
- Validación automática de campos numéricos
- Cálculo automático de totales

GET /api/v1/cotizador/cotizaciones/{id}/
- Ver detalle de cotización
- Incluye productos relacionados
- Muestra cálculos actualizados

PUT /api/v1/cotizador/cotizaciones/{id}/
- Actualizar cotización completa
- Actualiza productos relacionados
- Recalcula totales automáticamente

PATCH /api/v1/cotizador/cotizaciones/{id}/
- Actualización parcial de cotización
- Solo actualiza campos enviados
- Mantiene integridad de datos

DELETE /api/v1/cotizador/cotizaciones/{id}/
- Eliminar cotización
- Solo disponible en estado borrador
- Requiere permisos especiales
```

#### Modelos de Datos
- **Cotizacion**: Datos principales de la cotización
- **DetalleCotizacion**: Productos y servicios incluidos
- **Bundle**: Agrupación de productos relacionados
- **ProductoBundle**: Productos individuales dentro de un bundle
- **CotizadorImagenproducto**: Gestión de imágenes de productos

#### Características Técnicas
- Uso de Decimal para cálculos financieros precisos
- Validaciones robustas en serializers
- Manejo transaccional para operaciones múltiples
- Optimización de consultas para mejor rendimiento
- Integración con sistema de usuarios y permisos

## API Endpoints Detallados

### Autenticación
```
POST /api/auth/login/
- Login de usuario
- Devuelve: token de acceso, información del usuario y apps permitidas
- Público

POST /api/auth/logout/
- Cierre de sesión
- Requiere: token de refresco
- Autenticado

GET /api/auth/verify/
- Verifica accesos del usuario
- Devuelve: lista de aplicaciones permitidas
- Autenticado
```

### Usuarios
```
GET /api/users/
- Listar usuarios
- Filtros: email, área, unidad
- Solo administradores

POST /api/users/
- Crear nuevo usuario
- Solo administradores

GET /api/users/{id}/
- Ver detalle de usuario
- Admins: cualquier usuario
- Usuarios: solo su propio perfil

PUT /api/users/{id}/
- Actualizar usuario
- Admins: cualquier usuario
- Usuarios: solo su propio perfil

DELETE /api/users/{id}/
- Eliminar usuario
- Solo administradores

POST /api/users/{id}/change-password/
- Cambiar contraseña
- Requiere: contraseña actual
- Usuario propio o admin

POST /api/users/{id}/activate/
- Activar cuenta
- Solo administradores

POST /api/users/{id}/deactivate/
- Desactivar cuenta
- Solo administradores

GET /api/users/check-email/
- Verificar disponibilidad de email
- Público
```

### Cotizaciones
```
GET /api/cotizaciones/
- Listar cotizaciones
- Filtros: fecha, estado, unidad
- Permisos según rol

POST /api/cotizaciones/
- Crear cotización
- Solo Manager y Vendedor
- Área de Ventas

GET /api/cotizaciones/{id}/
- Ver cotización
- Permisos según rol y unidad

PUT /api/cotizaciones/{id}/
- Actualizar cotización
- Manager: todas
- Backoffice: su unidad
- Vendedor: propias en borrador

DELETE /api/cotizaciones/{id}/
- Eliminar cotización
- Solo administradores
```

### Detalles de Cotización
```
GET /api/detalles-cotizacion/
- Listar detalles
- Filtros: cotización
- Permisos heredados de cotización

POST /api/detalles-cotizacion/
- Agregar detalle
- Permisos heredados de cotización

PUT /api/detalles-cotizacion/{id}/
- Actualizar detalle
- Permisos heredados de cotización

DELETE /api/detalles-cotizacion/{id}/
- Eliminar detalle
- Permisos heredados de cotización
```

### Productos
```
GET /api/productos/
- Listar productos
- Filtros: nombre, código
- Solo lectura
- Área de Ventas
```

## Tecnologías Utilizadas

- Python 3.11+
- Django 5.0.1
- Django REST Framework
- PostgreSQL
- JWT para autenticación
- Django Jazzmin para el panel de administración
- Django CORS Headers para manejo de CORS
- Pillow para procesamiento de imágenes

## Estructura del Proyecto

```
APP-MANAGER/
├── app_manager/          # Configuración principal del proyecto
├── apps/                 # Aplicaciones del proyecto
│   ├── accounts/        # Gestión de usuarios y autenticación
│   ├── core/           # Funcionalidades principales
│   └── cotizador/      # Sistema de cotizaciones
├── manage.py            # Script de gestión de Django
├── requirements.txt     # Dependencias del proyecto
└── .env                # Variables de entorno (no versionado)
```

## Requisitos del Sistema

- Python 3.11+
- PostgreSQL
- Entorno virtual (recomendado)

## Instalación

1. Clonar el repositorio:
```bash
git clone <url-del-repositorio>
cd APP-MANAGER
```

2. Crear y activar entorno virtual:
```bash
python -m venv venv
source venv/bin/activate  # En Windows: venv\Scripts\activate
```

3. Instalar dependencias:
```bash
pip install -r requirements.txt
```

4. Configurar variables de entorno:
- Crear archivo `.env` basado en el ejemplo proporcionado
- Configurar las variables necesarias (DB, SECRET_KEY, etc.)

5. Realizar migraciones:
```bash
python manage.py migrate
```

6. Crear superusuario:
```bash
python manage.py createsuperuser
```

7. Iniciar el servidor:
```bash
python manage.py runserver
```

## Módulos Principales

### Accounts
- Gestión de usuarios con campos personalizados:
  - Unidad (CDMX, QRO, LAG, MTY, SPL, GDL)
  - Razón Social (GEBESA NACIONAL, OPERADORA DE SUCURSALES GEBESA, SALMON DE LA LAGUNA)
- Autenticación JWT
- Perfiles de usuario
- Control de permisos
- Gestión de áreas (RH, Ventas, Compras, Producción, TI)

### Core
- Funcionalidades base del sistema
- Configuraciones generales
- Utilidades compartidas
- Sistema de permisos personalizados

### Cotizador
- Sistema completo de cotizaciones
- Gestión de clientes y productos
- Integración con sistema ERP existente
- Campos principales:
  - Información del cliente (proyecto, datos de contacto)
  - Información del representante
  - Unidad de facturación vinculada a razón social
  - Estados de cotización (Borrador, Enviada, Aceptada, etc.)
  - Folio automático con formato personalizado
- Conexión con catálogos del ERP:
  - Tipos de producto
  - Familias de producto
  - Líneas de producto
  - Grupos de producto

## Pendientes
- [ ] Configurar correctamente la conexión con Supabase
- [ ] Implementar validaciones adicionales en el modelo de Cotización
- [ ] Agregar endpoints en la API REST para el módulo de cotizaciones
- [ ] Documentar la API con Swagger/OpenAPI

## Variables de Entorno Requeridas

```bash
# Django
SECRET_KEY=your-secret-key

# Database - Supabase
SUPABASE_DB_NAME=your-db-name
SUPABASE_DB_USER=your-db-user
SUPABASE_DB_PASSWORD=your-db-password
SUPABASE_DB_HOST=your-db-host
SUPABASE_DB_PORT=your-db-port

# Database - ERP
ERP_PORTALGEBESA_DB_NAME=your-erp-db-name
ERP_PORTALGEBESA_DB_USER=your-erp-db-user
ERP_PORTALGEBESA_DB_PASSWORD=your-erp-db-password
ERP_PORTALGEBESA_DB_HOST=your-erp-db-host
ERP_PORTALGEBESA_DB_PORT=your-erp-db-port
```

## Configuración

El proyecto utiliza python-decouple para la gestión de variables de entorno. Asegúrese de configurar las siguientes variables en el archivo `.env`:

- SECRET_KEY
- DEBUG
- DATABASE_URL
- ALLOWED_HOSTS
- Otras configuraciones específicas

## Seguridad

- Implementación de JWT para autenticación segura
- CORS configurado para control de acceso
- Manejo seguro de contraseñas y datos sensibles

## Contribución

1. Fork el repositorio
2. Cree una rama para su característica (`git checkout -b feature/AmazingFeature`)
3. Commit sus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abra un Pull Request

## Licencia

Este proyecto está bajo licencia privada. Todos los derechos reservados.

## Soporte

Para soporte o consultas, contacte al equipo de desarrollo.

## Sistema de Permisos y Roles

### Roles del Sistema

#### 1. Administrador
- **Nivel de Acceso**: Total
- **Capacidades**:
  - Gestión completa de usuarios
  - Acceso a todos los módulos
  - Bypass de restricciones de unidad/razón social
  - Modificación de configuraciones del sistema
  - Visualización de logs y auditoría

#### 2. Manager
- **Nivel de Acceso**: Global
- **Capacidades**:
  - Ver todas las cotizaciones del sistema
  - Crear nuevas cotizaciones
  - Aprobar/Rechazar cotizaciones
  - Ver reportes globales
- **Restricciones**:
  - Debe pertenecer al área de Ventas

#### 3. Vendedor
- **Nivel de Acceso**: Personal
- **Capacidades**:
  - Crear nuevas cotizaciones
  - Ver sus propias cotizaciones
  - Modificar cotizaciones en borrador
- **Restricciones**:
  - Solo ve sus propias cotizaciones
  - No puede aprobar cotizaciones
  - Debe pertenecer al área de Ventas

#### 4. Backoffice
- **Nivel de Acceso**: Por Unidad
- **Capacidades**:
  - Editar cotizaciones aprobadas
  - Procesar documentación
  - Generar reportes
- **Restricciones**:
  - No puede crear nuevas cotizaciones
  - Solo puede editar cotizaciones de su unidad

#### 5. Marketing
- **Nivel de Acceso**: Global con restricciones
- **Capacidades**:
  - Gestión de contenido multimedia
  - Actualización de catálogos
- **Restricciones**:
  - Sin acceso al módulo de cotizaciones
  - Sin capacidad de modificar datos sensibles

## Validaciones del Sistema

### 1. Validaciones de Usuario

#### Validaciones de Área
```python
AREAS_PERMITIDAS = [
    'RH',        # Recursos Humanos
    'VENTAS',    # Ventas
    'COMPRAS',   # Compras
    'PROD',      # Producción
    'TI'         # Tecnología
]
```
- Cada usuario debe tener un área asignada
- El área determina el acceso a módulos específicos
- Validación automática al crear/modificar usuarios

#### Validaciones de Unidad
```python
UNIDADES_NEGOCIO = [
    'CDMX',      # Ciudad de México
    'QRO',       # Querétaro
    'LAG',       # Laguna
    'MTY',       # Monterrey
    'SPL',       # San Pedro Lagunillas
    'GDL'        # Guadalajara
]
```
- Cada usuario debe pertenecer a una unidad
- La unidad determina el alcance de visibilidad
- Validación contra lista predefinida

#### Validaciones de Razón Social
```python
RAZONES_SOCIALES = [
    'GEBESA_NACIONAL',
    'OPERADORA_DE_SUCURSALES_GEBESA',
    'SALMON_DE_LA_LAGUNA'
]

# Mapeo de unidades a razones sociales permitidas
UNIDAD_RAZON_SOCIAL_MAPPING = {
    'CDMX': ['GEBESA_NACIONAL', 'OPERADORA_DE_SUCURSALES_GEBESA'],
    'QRO':  ['GEBESA_NACIONAL', 'OPERADORA_DE_SUCURSALES_GEBESA'],
    'LAG':  ['SALMON_DE_LA_LAGUNA'],
    'MTY':  ['GEBESA_NACIONAL', 'OPERADORA_DE_SUCURSALES_GEBESA'],
    'SPL':  ['GEBESA_NACIONAL'],
    'GDL':  ['GEBESA_NACIONAL', 'OPERADORA_DE_SUCURSALES_GEBESA']
}
```
- Cada unidad tiene razones sociales específicas permitidas
- Validación automática al asignar razón social
- Los superusuarios están exentos de esta validación

### 2. Validaciones de Cotizaciones

#### Permisos de Creación
```python
def can_create_cotizacion(user):
    """
    Verifica si un usuario puede crear cotizaciones:
    - Debe tener rol Manager o Vendedor
    - Su razón social debe corresponder con su unidad
    - Debe pertenecer al área de ventas
    """
```
- Solo usuarios del área de Ventas
- Rol debe ser Manager o Vendedor
- Razón social debe corresponder a su unidad

#### Permisos de Visualización
```python
def can_view_cotizaciones(user, cotizacion_owner=None):
    """
    Verifica permisos para ver cotizaciones:
    - Manager y Backoffice ven todas las cotizaciones
    - Vendedores solo ven sus propias cotizaciones
    - Debe pertenecer al área de ventas
    """
```
- Managers tienen acceso global a todas las cotizaciones
- Vendedores solo ven sus propias cotizaciones
- Validación de área de ventas requerida

#### Permisos de Edición
```python
def can_edit_cotizacion(user, cotizacion):
    """
    Verifica permisos para editar cotizaciones:
    - Administradores pueden editar todo
    - Managers pueden editar cualquier cotización
    - Backoffice solo puede editar de su unidad/razón social
    """
```
- Managers tienen permisos globales de edición
- Backoffice mantiene restricciones por unidad
- Control de estado de la cotización

## Implementación de Permisos

### 1. A Nivel de Modelo
```python
class User(AbstractUser):
    def clean(self):
        # Validar área
        if self.area not in dict(self.AREA_CHOICES):
            raise ValidationError(...)
        
        # Validar unidad y razón social
        if not self.is_superuser:
            razones_permitidas = UNIDAD_RAZON_SOCIAL_MAPPING.get(self.unidad, [])
            if self.razon_social not in razones_permitidas:
                raise ValidationError(...)
```

### 2. A Nivel de Vista
```python
class CotizadorPermission(permissions.BasePermission):
    def has_permission(self, request, view):
        # Validar autenticación
        if not request.user.is_authenticated:
            return False
            
        # Validar rol
        role = get_cotizador_rol(request.user)
        if not role:
            return False

        # Validar permisos específicos
        if request.method == 'POST':
            return can_create_cotizacion(request.user)
        
        return can_view_cotizaciones(request.user)
```

### 3. A Nivel de Admin
```python
class CustomUserAdmin(UserAdmin):
    def save_model(self, request, obj, form, change):
        if not change:  # Si es un nuevo usuario
            obj.created_by = request.user
        super().save_model(request, obj, form, change)
```

## Notas Importantes

1. **Jerarquía de Permisos**
   - Los permisos se validan en cascada
   - Primero se valida el área
   - Luego la unidad
   - Finalmente la razón social

2. **Excepciones**
   - Los superusuarios bypasan todas las validaciones
   - Algunos roles tienen permisos especiales en sus áreas

3. **Auditoría**
   - Todas las acciones son registradas
   - Se mantiene historial de cambios
   - Trazabilidad completa de modificaciones

4. **Seguridad**
   - Validaciones tanto en frontend como backend
   - Tokens JWT para autenticación
   - Sesiones con tiempo de expiración

## Base de Datos

### Tablas en PostgreSQL (ERP)
- users
- cotizaciones
- detalles_cotizacion
- productos
- ...

### Tablas en Supabase
```sql
-- Tabla para almacenar imágenes FALTA DE AGREGAR (PENDIENTE SERGIO)
CREATE TABLE imagenes (
    id SERIAL PRIMARY KEY,
    clave_padre VARCHAR(50) NOT NULL,    -- ID de referencia al registro en PostgreSQL
    tipo_registro VARCHAR(30) NOT NULL,   -- 'cotizacion', 'producto', etc.
    url TEXT NOT NULL,                    -- URL de la imagen en Supabase Storage
    nombre_archivo VARCHAR(255) NOT NULL,
    tipo_archivo VARCHAR(50) NOT NULL,    -- MIME type
    tamanio INTEGER NOT NULL,             -- Tamaño en bytes
    orden INTEGER DEFAULT 0,              -- Para ordenar múltiples imágenes
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_imagen UNIQUE (clave_padre, tipo_registro, nombre_archivo)
);

-- Índices
CREATE INDEX idx_imagenes_clave_padre ON imagenes(clave_padre);
CREATE INDEX idx_imagenes_tipo_registro ON imagenes(tipo_registro);
```

### Relación con PostgreSQL
- Las imágenes se almacenan físicamente en Supabase Storage
- La tabla `imagenes` mantiene la relación entre los registros de PostgreSQL y sus imágenes
- La `clave_padre` se relaciona con el ID del registro correspondiente en PostgreSQL
- Ejemplo de relación:
  ```
  PostgreSQL: cotizacion.id = 1234
  Supabase: imagenes.clave_padre = '1234' AND tipo_registro = 'cotizacion'
  ```

## Dependencias Actualizadas
```
asgiref==3.8.1
Django==5.0.1
django-cors-headers==4.3.1
django-filter==23.5
django-jazzmin==3.0.1
djangorestframework==3.14.0
djangorestframework_simplejwt==5.4.0
pillow==11.1.0
psycopg2-binary==2.9.9
PyJWT==2.10.1
python-decouple==3.8
pytz==2025.1
sqlparse==0.5.3
tzdata==2025.1
````

## requirements.txt

- Characters: 758
- Tokens: 0

```text
asgiref==3.8.1
Django==5.0.1
django-cors-headers==4.3.1
django-filter==23.5
django-jazzmin==3.0.1
djangorestframework==3.14.0
djangorestframework_simplejwt==5.4.0
pillow==11.1.0
psycopg2-binary==2.9.9
PyJWT==2.10.1
python-decouple==3.8
pytz==2025.1
requests==2.31.0
sqlparse==0.5.3
tzdata==2025.1
celery>=5.3.0
redis>=4.5.0

# Supabase y dependencias relacionadas
supabase==2.3.1
gotrue==2.1.0
supafunc==0.3.1
postgrest==0.13.0
realtime==1.0.0
storage3==0.7.0

# Utilidades
tqdm==4.66.2
python-magic==0.4.27
python-magic-bin==0.4.14; platform_system=='Windows'
pandas==2.2.0
openpyxl==3.1.2
xlrd==2.0.1

# Dependencias para Vercel
uvicorn==0.27.1
gunicorn==21.2.0
whitenoise==6.6.0
dj-database-url==2.1.0
# Libreria para estructura de proyecto
repomix==0.2.2
```

## Statistics

- Total Files: 114
- Total Characters: 460692
- Total Tokens: 0
